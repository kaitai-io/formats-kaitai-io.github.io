<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>.bmp file format: Nim parsing library</title>
  <meta name="keywords" content="kaitai,struct,binary,format,parsing,decoding,java,javascript,python,ruby,library,metadata">
  <meta name="description" content="Kaitai Struct is a formal language for binary format specification that can be compiled into parser code">

  <link rel="stylesheet" href="//kaitai.io/styles/bootstrap.min.css">
  <link rel="stylesheet" href="//kaitai.io/styles/bootstrap-theme.min.css">
  <link href='https://fonts.googleapis.com/css?family=Exo:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Share+Tech+Mono' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="//kaitai.io/styles/main.css" type="text/css">
  <link rel="stylesheet" href="../pygments-default.css" type="text/css">
  <style>
.diagram-img {
    display: block;
    max-width: 100%;
    height: auto;
    margin: 0 auto;
}

section.format {
    padding: 30px 0;
}

section#format-meta, section#format-index-header {
    background: #e3eef7;
}

section#format-diagram, section#format-index-footer {
    background: #e9f8dd;
}

section#format-ksy, section#format-lang {
    background: #d1eadd;
}

section#format-index .row {
    padding-bottom: 10px;
}

  </style>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MFSBBRGREL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-MFSBBRGREL');
  </script>
</head>
<body data-spy="scroll" data-target="#main-navbar" data-offset="100">

    <nav class="navbar navbar-inverse navbar-fixed-top" id="main-navbar">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-navbar-collapse" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <span class="navbar-brand">Kaitai Struct</span>
            </div>
            <div class="collapse navbar-collapse" id="main-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="//kaitai.io/#what-is-it">What is it?</a></li>
                    <li><a href="//kaitai.io/#quick-start">Quick Start</a></li>
                    <li><a href="//kaitai.io/#download">Download</a></li>
                    <li class="active"><a href="//formats.kaitai.io/">Format Gallery</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="https://ide.kaitai.io/">Try it &mdash; Web IDE</a></li>
                    <li><a href="//doc.kaitai.io/">Documentation</a></li>
                </ul>
            </div>
        </div>
    </nav>
<nav>
    <div class="container">
    <ol class="breadcrumb">
        <li><a href="../index.html">Format Gallery</a></li>
        <li>Image Files</li>
        <li class="active">.bmp file format</li>
    </ol>
    </div>
</nav>

<section id="format-meta" class="format">
    <div class="container">
        <h1>.bmp file format:
            
            Nim parsing library
            
        </h1>

        <div class="row">
            <div class="col-md-8">
                <p><p>The <strong>BMP file format</strong>, also known as <strong>bitmap image file</strong> or <strong>device independent
bitmap (DIB) file format</strong> or simply a <strong>bitmap</strong>, is a raster graphics image file
format used to store bitmap digital images, independently of the display
device (such as a graphics adapter), especially on Microsoft Windows
and OS/2 operating systems.</p>
<h2>Samples</h2>
<p>Great collection of various BMP sample files:
<a href="http://entropymine.com/jason/bmpsuite/bmpsuite/html/bmpsuite.html"><strong>BMP Suite Image List</strong></a> (by Jason Summers)</p>
<p>If only there was such a comprehensive sample suite for every file format! It's like
a dream for every developer of any binary file format parser. It contains a lot of
different types and variations of BMP files, even the tricky ones, where it's not clear
from the specification how to deal with them (marked there as &quot;<strong>q</strong>uestionable&quot;).</p>
<p>If you make a program which will be able to read all the &quot;<strong>g</strong>ood&quot; and &quot;<strong>q</strong>uestionable&quot;
BMP files and won't crash on the &quot;<strong>b</strong>ad&quot; ones, it will definitely have one of the most
extensive support of BMP files in the universe!</p>
<h2>BITMAPV2INFOHEADER and BITMAPV3INFOHEADER</h2>
<p>A beneficial discussion on Adobe forum (archived):
<a href="https://web.archive.org/web/20150127132443/https://forums.adobe.com/message/3272950"><strong>Invalid BMP Format with Alpha channel</strong></a></p>
<p>In 2010, someone noticed that Photoshop generated BMP with an odd type of header. There wasn't
any documentation available for this header at the time (and still isn't).
However, Chris Cox (former Adobe employee) claimed that they hadn't invented any type
of proprietary header and everything they were writing was taken directly
from the Microsoft documentation.</p>
<p>It showed up that the unknown header was called BITMAPV3INFOHEADER.
Although Microsoft has apparently requested and verified the use of the header,
the documentation on MSDN has probably got lost and they have probably
forgotten about this type of header.</p>
<p>This is the only source I could find about these structures, so we could't rely
on it so much, but I think supporting them as a read-only format won't harm anything.
Due to the fact that it isn't documented anywhere else, most applications don't support it.</p>
<p>All Windows headers at once (including mentioned BITMAPV2INFOHEADER and BITMAPV3INFOHEADER):</p>
<p><img src="https://web.archive.org/web/20190527043845/https://forums.adobe.com/servlet/JiveServlet/showImage/2-3273299-47801/BMP_Headers.png" alt="Bitmap headers overview" /></p>
<h2>Specs</h2>
<ul>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/gdi/bitmap-storage">Bitmap Storage (Windows Dev Center)</a>
<ul>
<li>BITMAPFILEHEADER</li>
<li>BITMAPINFOHEADER</li>
<li>BITMAPV4HEADER</li>
<li>BITMAPV5HEADER</li>
</ul>
</li>
<li><a href="https://www.fileformat.info/format/os2bmp/egff.htm">OS/2 Bitmap File Format</a>
<ul>
<li>BITMAPFILEHEADER (OS2BMPFILEHEADER)</li>
<li>BITMAPCOREHEADER (OS21XBITMAPHEADER)</li>
<li>OS22XBITMAPHEADER</li>
</ul>
</li>
<li><a href="http://netghost.narod.ru/gff/graphics/summary/micbmp.htm">Microsoft Windows Bitmap</a>
<ul>
<li>BITMAPFILEHEADER (WINBMPFILEHEADER)</li>
<li>BITMAPCOREHEADER (WIN2XBITMAPHEADER)</li>
<li>BITMAPINFOHEADER (WINNTBITMAPHEADER)</li>
<li>BITMAPV4HEADER (WIN4XBITMAPHEADER)</li>
</ul>
</li>
</ul>
</p>
            </div>
            <div class="col-md-4">
                <div class="panel panel-info">
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">File extension</h3>
                    </div>
                    <div class="panel-body">
                        bmp
                    </div>
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">KS implementation details</h3>
                    </div>
                    
                    <div class="panel-body">
                        License: <a href="https://spdx.org/licenses/CC0-1.0.html">CC0-1.0</a>
                    </div>
                    
                    
                    <div class="panel-body">
                        Minimal Kaitai Struct required: 0.9
                    </div>
                    
                    
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">References</h3>
                    </div>
                    <div class="panel-body">
                        <ul>
                            
                            
                            
                            
                            
                            <li><a href="http://www.loc.gov/preservation/digital/formats/fdd/fdd000189.shtml">LOC fdd000189</a></li>
                            
                            <li><a href="https://www.nationalarchives.gov.uk/pronom/fmt/115">PRONOM fmt/115</a></li>
<li><a href="https://www.nationalarchives.gov.uk/pronom/fmt/116">PRONOM fmt/116</a></li>
<li><a href="https://www.nationalarchives.gov.uk/pronom/fmt/117">PRONOM fmt/117</a></li>
<li><a href="https://www.nationalarchives.gov.uk/pronom/fmt/118">PRONOM fmt/118</a></li>
<li><a href="https://www.nationalarchives.gov.uk/pronom/fmt/119">PRONOM fmt/119</a></li>
<li><a href="https://www.nationalarchives.gov.uk/pronom/x-fmt/25">PRONOM x-fmt/25</a></li>
                            
                            <li><a href="https://www.wikidata.org/wiki/Q192869">Wikidata Q192869</a></li>
                            
                            <li><a href="https://forensicswiki.xyz/page/BMP">BMP in ForensicsWiki</a></li>
                            
                            <li><a href="http://fileformats.archiveteam.org/wiki/BMP">BMP in Just Solve the File Format Problem</a></li>
                            
                        </ul>
                    </div>
                    
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
            <p>
            This page hosts a formal specification of .bmp file format
            using <a href="//kaitai.io">Kaitai Struct</a>. This
            specification can be automatically translated into a
            variety of programming languages to get a parsing library.
            </p>

            <ul class="nav nav-pills">
                
                
                <li>
                
                <a href="index.html" title=".bmp file format parsing Overview library">Overview</a></li>
                
                
                <li>
                
                <a href="cpp_stl_11.html" title=".bmp file format parsing C++11/STL library">C++11/STL</a></li>
                
                
                <li>
                
                <a href="cpp_stl_98.html" title=".bmp file format parsing C++98/STL library">C++98/STL</a></li>
                
                
                <li>
                
                <a href="csharp.html" title=".bmp file format parsing C# library">C#</a></li>
                
                
                <li>
                
                <a href="java.html" title=".bmp file format parsing Java library">Java</a></li>
                
                
                <li>
                
                <a href="javascript.html" title=".bmp file format parsing JavaScript library">JavaScript</a></li>
                
                
                <li>
                
                <a href="lua.html" title=".bmp file format parsing Lua library">Lua</a></li>
                
                
                <li class="active">
                
                <a href="nim.html" title=".bmp file format parsing Nim library">Nim</a></li>
                
                
                <li>
                
                <a href="perl.html" title=".bmp file format parsing Perl library">Perl</a></li>
                
                
                <li>
                
                <a href="php.html" title=".bmp file format parsing PHP library">PHP</a></li>
                
                
                <li>
                
                <a href="python.html" title=".bmp file format parsing Python library">Python</a></li>
                
                
                <li>
                
                <a href="ruby.html" title=".bmp file format parsing Ruby library">Ruby</a></li>
                
            </ul>
            </div>
        </div>
    </div>
</section>


<section id="format-lang" class="format">
    <div class="container">
        <h2>
            
            Nim source code to parse .bmp file format
            
        </h2>

        

        <h3>bmp.nim</h3>

        <div class="row">
            <div class="pull-right">
                <p>
                    <a href="src/nim/bmp.nim" download="bmp.nim" class="btn btn-success">Download <i class="fa fa-download"></i></a>
                </p>
            </div>
        </div>

        <div class="row">
            <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="n">kaitai_struct_nim_runtime</span>
<span class="kn">import</span> <span class="n">options</span>

<span class="k">type</span>
  <span class="n">Bmp</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">fileHdr</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_FileHeader</span>
    <span class="p">`</span><span class="n">dibInfo</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span>
    <span class="p">`</span><span class="n">bitmap</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_Bitmap</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">rawDibInfo</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">byte</span><span class="o">]</span>
    <span class="p">`</span><span class="n">rawBitmap</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">byte</span><span class="o">]</span>
  <span class="n">Bmp_Intent</span><span class="o">*</span> <span class="o">=</span> <span class="k">enum</span>
    <span class="n">business</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">graphics</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">images</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">abs_colorimetric</span> <span class="o">=</span> <span class="mi">8</span>
  <span class="n">Bmp_ColorSpace</span><span class="o">*</span> <span class="o">=</span> <span class="k">enum</span>
    <span class="n">calibrated_rgb</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">profile_linked</span> <span class="o">=</span> <span class="mi">1279872587</span>
    <span class="n">profile_embedded</span> <span class="o">=</span> <span class="mi">1296188740</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="mi">1466527264</span>
    <span class="n">s_rgb</span> <span class="o">=</span> <span class="mi">1934772034</span>
  <span class="n">Bmp_Os2Rendering</span><span class="o">*</span> <span class="o">=</span> <span class="k">enum</span>
    <span class="n">no_halftoning</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">error_diffusion</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">panda</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">super_circle</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="n">Bmp_HeaderType</span><span class="o">*</span> <span class="o">=</span> <span class="k">enum</span>
    <span class="n">bitmap_core_header</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">bitmap_info_header</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">bitmap_v2_info_header</span> <span class="o">=</span> <span class="mi">52</span>
    <span class="n">bitmap_v3_info_header</span> <span class="o">=</span> <span class="mi">56</span>
    <span class="n">os2_2x_bitmap_header</span> <span class="o">=</span> <span class="mi">64</span>
    <span class="n">bitmap_v4_header</span> <span class="o">=</span> <span class="mi">108</span>
    <span class="n">bitmap_v5_header</span> <span class="o">=</span> <span class="mi">124</span>
  <span class="n">Bmp_Compressions</span><span class="o">*</span> <span class="o">=</span> <span class="k">enum</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rle8</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">rle4</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">bitfields</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">jpeg</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">png</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">alpha_bitfields</span> <span class="o">=</span> <span class="mi">6</span>
  <span class="n">Bmp_Os2Compressions</span><span class="o">*</span> <span class="o">=</span> <span class="k">enum</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rle8</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">rle4</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">huffman_1d</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">rle24</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="n">Bmp_CieXyz</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">x</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_FixedPoint2Dot30</span>
    <span class="p">`</span><span class="n">y</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_FixedPoint2Dot30</span>
    <span class="p">`</span><span class="n">z</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_FixedPoint2Dot30</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapV4Extension</span>
  <span class="n">Bmp_RgbRecord</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">blue</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint8</span>
    <span class="p">`</span><span class="n">green</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint8</span>
    <span class="p">`</span><span class="n">red</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint8</span>
    <span class="p">`</span><span class="n">reserved</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint8</span>
    <span class="p">`</span><span class="n">hasReservedField</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_ColorTable</span>
  <span class="n">Bmp_BitmapV5Extension</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">intent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_Intent</span>
    <span class="p">`</span><span class="n">ofsProfile</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">lenProfile</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">reserved</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span>
    <span class="p">`</span><span class="n">hasProfileInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">profileDataInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">KaitaiStruct</span>
  <span class="n">Bmp_ColorMask</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">redMask</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">greenMask</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">blueMask</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">alphaMask</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">hasAlphaMask</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">KaitaiStruct</span>
  <span class="n">Bmp_BitmapV4Extension</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">colorSpaceType</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_ColorSpace</span>
    <span class="p">`</span><span class="n">endpointRed</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_CieXyz</span>
    <span class="p">`</span><span class="n">endpointGreen</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_CieXyz</span>
    <span class="p">`</span><span class="n">endpointBlue</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_CieXyz</span>
    <span class="p">`</span><span class="n">gammaRed</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_FixedPoint16Dot16</span>
    <span class="p">`</span><span class="n">gammaBlue</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_FixedPoint16Dot16</span>
    <span class="p">`</span><span class="n">gammaGreen</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_FixedPoint16Dot16</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span>
  <span class="n">Bmp_BitmapInfoExtension</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">compression</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_Compressions</span>
    <span class="p">`</span><span class="n">os2Compression</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_Os2Compressions</span>
    <span class="p">`</span><span class="n">lenImage</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">xResolution</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">yResolution</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">numColorsUsed</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">numColorsImportant</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span>
  <span class="n">Bmp_FixedPoint2Dot30</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">raw</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_CieXyz</span>
    <span class="p">`</span><span class="n">valueInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">float64</span>
  <span class="n">Bmp_Bitmap</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp</span>
  <span class="n">Bmp_BitmapHeader</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">imageWidth</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">imageHeightRaw</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">int32</span>
    <span class="p">`</span><span class="n">numPlanes</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint16</span>
    <span class="p">`</span><span class="n">bitsPerPixel</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint16</span>
    <span class="p">`</span><span class="n">bitmapInfoExt</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapInfoExtension</span>
    <span class="p">`</span><span class="n">colorMask</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_ColorMask</span>
    <span class="p">`</span><span class="n">os22xBitmapExt</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_Os22xBitmapExtension</span>
    <span class="p">`</span><span class="n">bitmapV4Ext</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapV4Extension</span>
    <span class="p">`</span><span class="n">bitmapV5Ext</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapV5Extension</span>
    <span class="p">`</span><span class="n">lenHeader</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span>
    <span class="p">`</span><span class="n">extendsBitmapV4Inst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">extendsOs22xBitmapInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">usesFixedPaletteInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">extendsBitmapInfoInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">imageHeightInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">int</span>
    <span class="p">`</span><span class="n">isCoreHeaderInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">extendsBitmapV5Inst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">isColorMaskHereInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">bottomUpInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
  <span class="n">Bmp_Os22xBitmapExtension</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">units</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint16</span>
    <span class="p">`</span><span class="n">reserved</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint16</span>
    <span class="p">`</span><span class="n">recording</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint16</span>
    <span class="p">`</span><span class="n">rendering</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_Os2Rendering</span>
    <span class="p">`</span><span class="n">size1</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">size2</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">colorEncoding</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">identifier</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span>
  <span class="n">Bmp_FixedPoint16Dot16</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">raw</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapV4Extension</span>
    <span class="p">`</span><span class="n">valueInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">float64</span>
  <span class="n">Bmp_ColorTable</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">colors</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">Bmp_RgbRecord</span><span class="o">]</span>
    <span class="p">`</span><span class="n">hasReservedField</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">numColors</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span>
    <span class="p">`</span><span class="n">numColorsPresentInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">int</span>
  <span class="n">Bmp_FileHeader</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">fileType</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">byte</span><span class="o">]</span>
    <span class="p">`</span><span class="n">lenFile</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">reserved1</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint16</span>
    <span class="p">`</span><span class="n">reserved2</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint16</span>
    <span class="p">`</span><span class="n">ofsBitmap</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">int32</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp</span>
  <span class="n">Bmp_BitmapInfo</span><span class="o">*</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">KaitaiStruct</span>
    <span class="p">`</span><span class="n">lenHeader</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">header</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span>
    <span class="p">`</span><span class="n">colorMask</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_ColorMask</span>
    <span class="p">`</span><span class="n">colorTable</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_ColorTable</span>
    <span class="p">`</span><span class="n">parent</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp</span>
    <span class="p">`</span><span class="n">rawHeader</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">byte</span><span class="o">]</span>
    <span class="p">`</span><span class="n">rawColorTable</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">byte</span><span class="o">]</span>
    <span class="p">`</span><span class="n">isColorMaskGivenInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">colorMaskGivenInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">Bmp_ColorMask</span>
    <span class="p">`</span><span class="n">colorMaskBlueInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">colorMaskAlphaInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="n">uint32</span>
    <span class="p">`</span><span class="n">colorMaskGreenInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">int</span>
    <span class="p">`</span><span class="n">isColorMaskHereInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">bool</span>
    <span class="p">`</span><span class="n">colorMaskRedInst</span><span class="p">`</span><span class="o">*</span><span class="p">:</span> <span class="kt">int</span>

<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp], io: KaitaiStream, root: KaitaiStruct, parent: KaitaiStruct): Bmp</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_CieXyz], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapV4Extension): Bmp_CieXyz</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_RgbRecord], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_ColorTable, hasReservedField: any): Bmp_RgbRecord</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapV5Extension], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapHeader): Bmp_BitmapV5Extension</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_ColorMask], io: KaitaiStream, root: KaitaiStruct, parent: KaitaiStruct, hasAlphaMask: any): Bmp_ColorMask</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapV4Extension], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapHeader): Bmp_BitmapV4Extension</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapInfoExtension], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapHeader): Bmp_BitmapInfoExtension</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_FixedPoint2Dot30], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_CieXyz): Bmp_FixedPoint2Dot30</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_Bitmap], io: KaitaiStream, root: KaitaiStruct, parent: Bmp): Bmp_Bitmap</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapHeader], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapInfo, lenHeader: any): Bmp_BitmapHeader</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_Os22xBitmapExtension], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapHeader): Bmp_Os22xBitmapExtension</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_FixedPoint16Dot16], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapV4Extension): Bmp_FixedPoint16Dot16</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_ColorTable], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapInfo, hasReservedField: any, numColors: any): Bmp_ColorTable</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_FileHeader], io: KaitaiStream, root: KaitaiStruct, parent: Bmp): Bmp_FileHeader</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapInfo], io: KaitaiStream, root: KaitaiStruct, parent: Bmp): Bmp_BitmapInfo</span>

<span class="k">proc </span><span class="nf">hasProfile</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapV5Extension</span><span class="p">):</span> <span class="kt">bool</span>
<span class="k">proc </span><span class="nf">profileData</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapV5Extension</span><span class="p">):</span> <span class="n">KaitaiStruct</span>
<span class="k">proc </span><span class="nf">value</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_FixedPoint2Dot30</span><span class="p">):</span> <span class="kt">float64</span>
<span class="k">proc </span><span class="nf">extendsBitmapV4</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span>
<span class="k">proc </span><span class="nf">extendsOs22xBitmap</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span>
<span class="k">proc </span><span class="nf">usesFixedPalette</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span>
<span class="k">proc </span><span class="nf">extendsBitmapInfo</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span>
<span class="k">proc </span><span class="nf">imageHeight</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">int</span>
<span class="k">proc </span><span class="nf">isCoreHeader</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span>
<span class="k">proc </span><span class="nf">extendsBitmapV5</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span>
<span class="k">proc </span><span class="nf">isColorMaskHere</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span>
<span class="k">proc </span><span class="nf">bottomUp</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span>
<span class="k">proc </span><span class="nf">value</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_FixedPoint16Dot16</span><span class="p">):</span> <span class="kt">float64</span>
<span class="k">proc </span><span class="nf">numColorsPresent</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_ColorTable</span><span class="p">):</span> <span class="kt">int</span>
<span class="k">proc </span><span class="nf">isColorMaskGiven</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="kt">bool</span>
<span class="k">proc </span><span class="nf">colorMaskGiven</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="n">Bmp_ColorMask</span>
<span class="k">proc </span><span class="nf">colorMaskBlue</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="n">uint32</span>
<span class="k">proc </span><span class="nf">colorMaskAlpha</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="n">uint32</span>
<span class="k">proc </span><span class="nf">colorMaskGreen</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="kt">int</span>
<span class="k">proc </span><span class="nf">isColorMaskHere</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="kt">bool</span>
<span class="k">proc </span><span class="nf">colorMaskRed</span><span class="o">*</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="kt">int</span>


<span class="sd">##[</span>
<span class="n">The</span> <span class="o">**</span><span class="n">BMP</span> <span class="n">file</span> <span class="n">format</span><span class="o">**</span><span class="p">,</span> <span class="n">also</span> <span class="n">known</span> <span class="k">as</span> <span class="o">**</span><span class="n">bitmap</span> <span class="n">image</span> <span class="n">file</span><span class="o">**</span> <span class="ow">or</span> <span class="o">**</span><span class="n">device</span> <span class="n">independent</span>
<span class="n">bitmap</span> <span class="p">(</span><span class="n">DIB</span><span class="p">)</span> <span class="n">file</span> <span class="n">format</span><span class="o">**</span> <span class="ow">or</span> <span class="n">simply</span> <span class="n">a</span> <span class="o">**</span><span class="n">bitmap</span><span class="o">**</span><span class="p">,</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">raster</span> <span class="n">graphics</span> <span class="n">image</span> <span class="n">file</span>
<span class="n">format</span> <span class="n">used</span> <span class="n">to</span> <span class="n">store</span> <span class="n">bitmap</span> <span class="n">digital</span> <span class="n">images</span><span class="p">,</span> <span class="n">independently</span> <span class="k">of</span> <span class="n">the</span> <span class="n">display</span>
<span class="n">device</span> <span class="p">(</span><span class="n">such</span> <span class="k">as</span> <span class="n">a</span> <span class="n">graphics</span> <span class="n">adapter</span><span class="p">),</span> <span class="n">especially</span> <span class="n">on</span> <span class="n">Microsoft</span> <span class="n">Windows</span>
<span class="ow">and</span> <span class="n">OS</span><span class="o">/</span><span class="mi">2</span> <span class="n">operating</span> <span class="n">systems</span><span class="p">.</span>

<span class="sd">## Samples</span>

<span class="n">Great</span> <span class="n">collection</span> <span class="k">of</span> <span class="n">various</span> <span class="n">BMP</span> <span class="n">sample</span> <span class="n">files</span><span class="p">:</span>
<span class="o">[**</span><span class="n">BMP</span> <span class="n">Suite</span> <span class="n">Image</span> <span class="n">List</span><span class="o">**]</span><span class="p">(</span>
  <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">entropymine</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">jason</span><span class="o">/</span><span class="n">bmpsuite</span><span class="o">/</span><span class="n">bmpsuite</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">bmpsuite</span><span class="p">.</span><span class="n">html</span>
<span class="p">)</span> <span class="p">(</span><span class="n">by</span> <span class="n">Jason</span> <span class="n">Summers</span><span class="p">)</span>

<span class="k">If</span> <span class="n">only</span> <span class="n">there</span> <span class="n">was</span> <span class="n">such</span> <span class="n">a</span> <span class="n">comprehensive</span> <span class="n">sample</span> <span class="n">suite</span> <span class="k">for</span> <span class="n">every</span> <span class="n">file</span> <span class="n">format</span><span class="o">!</span> <span class="n">It</span><span class="sc">&#39;s like</span>
<span class="n">a</span> <span class="n">dream</span> <span class="k">for</span> <span class="n">every</span> <span class="n">developer</span> <span class="k">of</span> <span class="n">any</span> <span class="n">binary</span> <span class="n">file</span> <span class="n">format</span> <span class="n">parser</span><span class="p">.</span> <span class="n">It</span> <span class="n">contains</span> <span class="n">a</span> <span class="n">lot</span> <span class="k">of</span>
<span class="n">different</span> <span class="n">types</span> <span class="ow">and</span> <span class="n">variations</span> <span class="k">of</span> <span class="n">BMP</span> <span class="n">files</span><span class="p">,</span> <span class="n">even</span> <span class="n">the</span> <span class="n">tricky</span> <span class="n">ones</span><span class="p">,</span> <span class="n">where</span> <span class="n">it</span><span class="sc">&#39;s not clear</span>
<span class="kn">from</span> <span class="n">the</span> <span class="n">specification</span> <span class="n">how</span> <span class="n">to</span> <span class="n">deal</span> <span class="k">with</span> <span class="n">them</span> <span class="p">(</span><span class="n">marked</span> <span class="n">there</span> <span class="k">as</span> <span class="s">&quot;**q**uestionable&quot;</span><span class="p">).</span>

<span class="k">If</span> <span class="n">you</span> <span class="n">make</span> <span class="n">a</span> <span class="n">program</span> <span class="n">which</span> <span class="n">will</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="n">read</span> <span class="n">all</span> <span class="n">the</span> <span class="s">&quot;**g**ood&quot;</span> <span class="ow">and</span> <span class="s">&quot;**q**uestionable&quot;</span>
<span class="n">BMP</span> <span class="n">files</span> <span class="ow">and</span> <span class="n">won</span><span class="sc">&#39;t crash on the &quot;**b**ad&quot; ones, it will definitely have one of the most</span>
<span class="n">extensive</span> <span class="n">support</span> <span class="k">of</span> <span class="n">BMP</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">universe</span><span class="o">!</span>

<span class="sd">## BITMAPV2INFOHEADER and BITMAPV3INFOHEADER</span>

<span class="n">A</span> <span class="n">beneficial</span> <span class="n">discussion</span> <span class="n">on</span> <span class="n">Adobe</span> <span class="n">forum</span> <span class="p">(</span><span class="n">archived</span><span class="p">):</span>
<span class="o">[**</span><span class="n">Invalid</span> <span class="n">BMP</span> <span class="n">Format</span> <span class="k">with</span> <span class="n">Alpha</span> <span class="n">channel</span><span class="o">**]</span><span class="p">(</span>
  <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">web</span><span class="p">.</span><span class="n">archive</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">web</span><span class="o">/</span><span class="mi">20150127132443</span><span class="o">/</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">forums</span><span class="p">.</span><span class="n">adobe</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">message</span><span class="o">/</span><span class="mi">3272950</span>
<span class="p">)</span>

<span class="ow">In</span> <span class="mi">2010</span><span class="p">,</span> <span class="n">someone</span> <span class="n">noticed</span> <span class="n">that</span> <span class="n">Photoshop</span> <span class="n">generated</span> <span class="n">BMP</span> <span class="k">with</span> <span class="n">an</span> <span class="n">odd</span> <span class="k">type</span> <span class="k">of</span> <span class="n">header</span><span class="p">.</span> <span class="n">There</span> <span class="n">wasn</span><span class="sc">&#39;t</span>
<span class="n">any</span> <span class="n">documentation</span> <span class="n">available</span> <span class="k">for</span> <span class="n">this</span> <span class="n">header</span> <span class="n">at</span> <span class="n">the</span> <span class="n">time</span> <span class="p">(</span><span class="ow">and</span> <span class="n">still</span> <span class="n">isn</span><span class="sc">&#39;t).</span>
<span class="n">However</span><span class="p">,</span> <span class="n">Chris</span> <span class="n">Cox</span> <span class="p">(</span><span class="n">former</span> <span class="n">Adobe</span> <span class="n">employee</span><span class="p">)</span> <span class="n">claimed</span> <span class="n">that</span> <span class="n">they</span> <span class="n">hadn</span><span class="sc">&#39;t invented any type</span>
<span class="k">of</span> <span class="n">proprietary</span> <span class="n">header</span> <span class="ow">and</span> <span class="n">everything</span> <span class="n">they</span> <span class="n">were</span> <span class="n">writing</span> <span class="n">was</span> <span class="n">taken</span> <span class="n">directly</span>
<span class="kn">from</span> <span class="n">the</span> <span class="n">Microsoft</span> <span class="n">documentation</span><span class="p">.</span>

<span class="n">It</span> <span class="n">showed</span> <span class="n">up</span> <span class="n">that</span> <span class="n">the</span> <span class="n">unknown</span> <span class="n">header</span> <span class="n">was</span> <span class="n">called</span> <span class="n">BITMAPV3INFOHEADER</span><span class="p">.</span>
<span class="n">Although</span> <span class="n">Microsoft</span> <span class="n">has</span> <span class="n">apparently</span> <span class="n">requested</span> <span class="ow">and</span> <span class="n">verified</span> <span class="n">the</span> <span class="n">use</span> <span class="k">of</span> <span class="n">the</span> <span class="n">header</span><span class="p">,</span>
<span class="n">the</span> <span class="n">documentation</span> <span class="n">on</span> <span class="n">MSDN</span> <span class="n">has</span> <span class="n">probably</span> <span class="n">got</span> <span class="n">lost</span> <span class="ow">and</span> <span class="n">they</span> <span class="n">have</span> <span class="n">probably</span>
<span class="n">forgotten</span> <span class="n">about</span> <span class="n">this</span> <span class="k">type</span> <span class="k">of</span> <span class="n">header</span><span class="p">.</span>

<span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">only</span> <span class="n">source</span> <span class="n">I</span> <span class="n">could</span> <span class="n">find</span> <span class="n">about</span> <span class="n">these</span> <span class="n">structures</span><span class="p">,</span> <span class="n">so</span> <span class="n">we</span> <span class="n">could</span><span class="sc">&#39;t rely</span>
<span class="n">on</span> <span class="n">it</span> <span class="n">so</span> <span class="n">much</span><span class="p">,</span> <span class="n">but</span> <span class="n">I</span> <span class="n">think</span> <span class="n">supporting</span> <span class="n">them</span> <span class="k">as</span> <span class="n">a</span> <span class="n">read</span><span class="o">-</span><span class="n">only</span> <span class="n">format</span> <span class="n">won</span><span class="sc">&#39;t harm anything.</span>
<span class="n">Due</span> <span class="n">to</span> <span class="n">the</span> <span class="n">fact</span> <span class="n">that</span> <span class="n">it</span> <span class="n">isn</span><span class="sc">&#39;t documented anywhere else, most applications don&#39;</span><span class="n">t</span> <span class="n">support</span> <span class="n">it</span><span class="p">.</span>

<span class="n">All</span> <span class="n">Windows</span> <span class="n">headers</span> <span class="n">at</span> <span class="n">once</span> <span class="p">(</span><span class="n">including</span> <span class="n">mentioned</span> <span class="n">BITMAPV2INFOHEADER</span> <span class="ow">and</span> <span class="n">BITMAPV3INFOHEADER</span><span class="p">):</span>

<span class="o">![</span><span class="n">Bitmap</span> <span class="n">headers</span> <span class="n">overview</span><span class="o">]</span><span class="p">(</span>
  <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">web</span><span class="p">.</span><span class="n">archive</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">web</span><span class="o">/</span><span class="mi">20190527043845</span><span class="o">/</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">forums</span><span class="p">.</span><span class="n">adobe</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">servlet</span><span class="o">/</span><span class="n">JiveServlet</span><span class="o">/</span><span class="n">showImage</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">3273299</span><span class="o">-</span><span class="mi">47801</span><span class="o">/</span><span class="n">BMP_Headers</span><span class="p">.</span><span class="n">png</span>
<span class="p">)</span>

<span class="sd">## Specs</span>
 <span class="o">*</span> <span class="o">[</span><span class="n">Bitmap</span> <span class="n">Storage</span> <span class="p">(</span><span class="n">Windows</span> <span class="n">Dev</span> <span class="n">Center</span><span class="p">)</span><span class="o">]</span><span class="p">(</span>
     <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="p">.</span><span class="n">microsoft</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">en</span><span class="o">-</span><span class="n">us</span><span class="o">/</span><span class="n">windows</span><span class="o">/</span><span class="n">win32</span><span class="o">/</span><span class="n">gdi</span><span class="o">/</span><span class="n">bitmap</span><span class="o">-</span><span class="n">storage</span>
   <span class="p">)</span>
    <span class="o">*</span> <span class="n">BITMAPFILEHEADER</span>
    <span class="o">*</span> <span class="n">BITMAPINFOHEADER</span>
    <span class="o">*</span> <span class="n">BITMAPV4HEADER</span>
    <span class="o">*</span> <span class="n">BITMAPV5HEADER</span>
 <span class="o">*</span> <span class="o">[</span><span class="n">OS</span><span class="o">/</span><span class="mi">2</span> <span class="n">Bitmap</span> <span class="n">File</span> <span class="n">Format</span><span class="o">]</span><span class="p">(</span>
      <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">fileformat</span><span class="p">.</span><span class="n">info</span><span class="o">/</span><span class="n">format</span><span class="o">/</span><span class="n">os2bmp</span><span class="o">/</span><span class="n">egff</span><span class="p">.</span><span class="n">htm</span>
   <span class="p">)</span>
    <span class="o">*</span> <span class="n">BITMAPFILEHEADER</span> <span class="p">(</span><span class="n">OS2BMPFILEHEADER</span><span class="p">)</span>
    <span class="o">*</span> <span class="n">BITMAPCOREHEADER</span> <span class="p">(</span><span class="n">OS21XBITMAPHEADER</span><span class="p">)</span>
    <span class="o">*</span> <span class="n">OS22XBITMAPHEADER</span>
 <span class="o">*</span> <span class="o">[</span><span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">Bitmap</span><span class="o">]</span><span class="p">(</span>
      <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">netghost</span><span class="p">.</span><span class="n">narod</span><span class="p">.</span><span class="n">ru</span><span class="o">/</span><span class="n">gff</span><span class="o">/</span><span class="n">graphics</span><span class="o">/</span><span class="n">summary</span><span class="o">/</span><span class="n">micbmp</span><span class="p">.</span><span class="n">htm</span>
   <span class="p">)</span>
    <span class="o">*</span> <span class="n">BITMAPFILEHEADER</span> <span class="p">(</span><span class="n">WINBMPFILEHEADER</span><span class="p">)</span>
    <span class="o">*</span> <span class="n">BITMAPCOREHEADER</span> <span class="p">(</span><span class="n">WIN2XBITMAPHEADER</span><span class="p">)</span>
    <span class="o">*</span> <span class="n">BITMAPINFOHEADER</span> <span class="p">(</span><span class="n">WINNTBITMAPHEADER</span><span class="p">)</span>
    <span class="o">*</span> <span class="n">BITMAPV4HEADER</span> <span class="p">(</span><span class="n">WIN4XBITMAPHEADER</span><span class="p">)</span>

<span class="o">]</span><span class="sd">##</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp], io: KaitaiStream, root: KaitaiStruct, parent: KaitaiStruct): Bmp =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

  <span class="k">let</span> <span class="n">fileHdrExpr</span> <span class="o">=</span> <span class="n">Bmp_FileHeader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">fileHdr</span> <span class="o">=</span> <span class="n">fileHdrExpr</span>
  <span class="k">let</span> <span class="n">rawDibInfoExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readBytes</span><span class="p">(</span><span class="kt">int</span><span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">fileHdr</span><span class="p">.</span><span class="n">ofsBitmap</span> <span class="o">-</span> <span class="mi">14</span><span class="p">)))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">rawDibInfo</span> <span class="o">=</span> <span class="n">rawDibInfoExpr</span>
  <span class="k">let</span> <span class="n">rawDibInfoIo</span> <span class="o">=</span> <span class="n">newKaitaiStream</span><span class="p">(</span><span class="n">rawDibInfoExpr</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">dibInfoExpr</span> <span class="o">=</span> <span class="n">Bmp_BitmapInfo</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">rawDibInfoIo</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">dibInfo</span> <span class="o">=</span> <span class="n">dibInfoExpr</span>
  <span class="k">let</span> <span class="n">rawBitmapExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readBytesFull</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">rawBitmap</span> <span class="o">=</span> <span class="n">rawBitmapExpr</span>
  <span class="k">let</span> <span class="n">rawBitmapIo</span> <span class="o">=</span> <span class="n">newKaitaiStream</span><span class="p">(</span><span class="n">rawBitmapExpr</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">bitmapExpr</span> <span class="o">=</span> <span class="n">Bmp_Bitmap</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">rawBitmapIo</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">bitmapExpr</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp], filename: string): Bmp =</span>
  <span class="n">Bmp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>


<span class="sd">##[</span>
<span class="o">@</span><span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-ciexyz&quot;</span><span class="o">&gt;</span><span class="n">Source</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">]</span><span class="sd">##</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_CieXyz], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapV4Extension): Bmp_CieXyz =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_CieXyz</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

  <span class="k">let</span> <span class="n">xExpr</span> <span class="o">=</span> <span class="n">Bmp_FixedPoint2Dot30</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xExpr</span>
  <span class="k">let</span> <span class="n">yExpr</span> <span class="o">=</span> <span class="n">Bmp_FixedPoint2Dot30</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">yExpr</span>
  <span class="k">let</span> <span class="n">zExpr</span> <span class="o">=</span> <span class="n">Bmp_FixedPoint2Dot30</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">zExpr</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_CieXyz], filename: string): Bmp_CieXyz =</span>
  <span class="n">Bmp_CieXyz</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_RgbRecord], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_ColorTable, hasReservedField: any): Bmp_RgbRecord =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_RgbRecord</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="k">let</span> <span class="n">hasReservedFieldExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span><span class="n">hasReservedField</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">hasReservedField</span> <span class="o">=</span> <span class="n">hasReservedFieldExpr</span>

  <span class="k">let</span> <span class="n">blueExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU1</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">blue</span> <span class="o">=</span> <span class="n">blueExpr</span>
  <span class="k">let</span> <span class="n">greenExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU1</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">green</span> <span class="o">=</span> <span class="n">greenExpr</span>
  <span class="k">let</span> <span class="n">redExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU1</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">red</span> <span class="o">=</span> <span class="n">redExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">hasReservedField</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">reservedExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU1</span><span class="p">()</span>
    <span class="n">this</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="n">reservedExpr</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_RgbRecord], filename: string): Bmp_RgbRecord =</span>
  <span class="n">Bmp_RgbRecord</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>


<span class="sd">##[</span>
<span class="o">@</span><span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-bitmapv5header&quot;</span><span class="o">&gt;</span><span class="n">Source</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">]</span><span class="sd">##</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapV5Extension], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapHeader): Bmp_BitmapV5Extension =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_BitmapV5Extension</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

  <span class="k">let</span> <span class="n">intentExpr</span> <span class="o">=</span> <span class="n">Bmp_Intent</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">())</span>
  <span class="n">this</span><span class="p">.</span><span class="n">intent</span> <span class="o">=</span> <span class="n">intentExpr</span>

  <span class="sd">##[</span>
  <span class="n">The</span> <span class="n">offset</span><span class="p">,</span> <span class="ow">in</span> <span class="n">bytes</span><span class="p">,</span> <span class="kn">from</span> <span class="n">the</span> <span class="n">beginning</span> <span class="k">of</span> <span class="n">the</span> <span class="n">BITMAPV5HEADER</span> <span class="n">structure</span> <span class="n">to</span> <span class="n">the</span> <span class="n">start</span> <span class="k">of</span> <span class="n">the</span> <span class="n">profile</span> <span class="n">data</span><span class="p">.</span>
  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">ofsProfileExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">ofsProfile</span> <span class="o">=</span> <span class="n">ofsProfileExpr</span>
  <span class="k">let</span> <span class="n">lenProfileExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">lenProfile</span> <span class="o">=</span> <span class="n">lenProfileExpr</span>
  <span class="k">let</span> <span class="n">reservedExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="n">reservedExpr</span>

<span class="k">proc </span><span class="nf">hasProfile</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapV5Extension</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">hasProfileInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">hasProfileInst</span>
  <span class="k">let</span> <span class="n">hasProfileInstExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span> <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">bitmapV4Ext</span><span class="p">.</span><span class="n">colorSpaceType</span> <span class="o">==</span> <span class="n">bmp</span><span class="p">.</span><span class="n">profile_linked</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">bitmapV4Ext</span><span class="p">.</span><span class="n">colorSpaceType</span> <span class="o">==</span> <span class="n">bmp</span><span class="p">.</span><span class="n">profile_embedded</span><span class="p">))</span> <span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">hasProfileInst</span> <span class="o">=</span> <span class="n">hasProfileInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">hasProfileInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">hasProfileInst</span>

<span class="k">proc </span><span class="nf">profileData</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapV5Extension</span><span class="p">):</span> <span class="n">KaitaiStruct</span> <span class="o">=</span> 

  <span class="sd">##[</span>
  <span class="o">@</span><span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;https://docs.microsoft.com/en-us/previous-versions/windows/desktop/wcs/using-structures-in-wcs-1-0&quot;</span><span class="o">&gt;</span><span class="s">&quot;If the profile is embedded, profile data is the actual profile, and if it is linked, the profile data is the null-terminated file name of the profile. This cannot be a Unicode string. It must be composed exclusively of characters from the Windows character set (code page 1252).&quot;</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
  <span class="o">]</span><span class="sd">##</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">profileDataInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">profileDataInst</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">hasProfile</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">io</span> <span class="o">=</span> <span class="n">Bmp</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">).</span><span class="n">io</span>
    <span class="k">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">pos</span><span class="p">()</span>
    <span class="n">io</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="kt">int</span><span class="p">((</span><span class="mi">14</span> <span class="o">+</span> <span class="n">this</span><span class="p">.</span><span class="n">ofsProfile</span><span class="p">)))</span>
    <span class="k">block</span><span class="p">:</span>
      <span class="k">let</span> <span class="n">on</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">bitmapV4Ext</span><span class="p">.</span><span class="n">colorSpaceType</span> <span class="o">==</span> <span class="n">bmp</span><span class="p">.</span><span class="n">profile_linked</span>
      <span class="k">if</span> <span class="n">on</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">profileDataInstExpr</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">readBytes</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">lenProfile</span><span class="p">)).</span><span class="n">bytesTerminate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kp">false</span><span class="p">),</span> <span class="s">&quot;windows-1252&quot;</span><span class="p">)</span>
        <span class="n">this</span><span class="p">.</span><span class="n">profileDataInst</span> <span class="o">=</span> <span class="n">profileDataInstExpr</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">let</span> <span class="n">profileDataInstExpr</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">readBytes</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">lenProfile</span><span class="p">))</span>
        <span class="n">this</span><span class="p">.</span><span class="n">profileDataInst</span> <span class="o">=</span> <span class="n">profileDataInstExpr</span>
    <span class="n">io</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">profileDataInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">profileDataInst</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapV5Extension], filename: string): Bmp_BitmapV5Extension =</span>
  <span class="n">Bmp_BitmapV5Extension</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_ColorMask], io: KaitaiStream, root: KaitaiStruct, parent: KaitaiStruct, hasAlphaMask: any): Bmp_ColorMask =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_ColorMask</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="k">let</span> <span class="n">hasAlphaMaskExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span><span class="n">hasAlphaMask</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">hasAlphaMask</span> <span class="o">=</span> <span class="n">hasAlphaMaskExpr</span>

  <span class="k">let</span> <span class="n">redMaskExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">redMask</span> <span class="o">=</span> <span class="n">redMaskExpr</span>
  <span class="k">let</span> <span class="n">greenMaskExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">greenMask</span> <span class="o">=</span> <span class="n">greenMaskExpr</span>
  <span class="k">let</span> <span class="n">blueMaskExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">blueMask</span> <span class="o">=</span> <span class="n">blueMaskExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">hasAlphaMask</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">alphaMaskExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
    <span class="n">this</span><span class="p">.</span><span class="n">alphaMask</span> <span class="o">=</span> <span class="n">alphaMaskExpr</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_ColorMask], filename: string): Bmp_ColorMask =</span>
  <span class="n">Bmp_ColorMask</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>


<span class="sd">##[</span>
<span class="o">@</span><span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-bitmapv4header&quot;</span><span class="o">&gt;</span><span class="n">Source</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">]</span><span class="sd">##</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapV4Extension], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapHeader): Bmp_BitmapV4Extension =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_BitmapV4Extension</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

  <span class="k">let</span> <span class="n">colorSpaceTypeExpr</span> <span class="o">=</span> <span class="n">Bmp_ColorSpace</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">())</span>
  <span class="n">this</span><span class="p">.</span><span class="n">colorSpaceType</span> <span class="o">=</span> <span class="n">colorSpaceTypeExpr</span>
  <span class="k">let</span> <span class="n">endpointRedExpr</span> <span class="o">=</span> <span class="n">Bmp_CieXyz</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">endpointRed</span> <span class="o">=</span> <span class="n">endpointRedExpr</span>
  <span class="k">let</span> <span class="n">endpointGreenExpr</span> <span class="o">=</span> <span class="n">Bmp_CieXyz</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">endpointGreen</span> <span class="o">=</span> <span class="n">endpointGreenExpr</span>
  <span class="k">let</span> <span class="n">endpointBlueExpr</span> <span class="o">=</span> <span class="n">Bmp_CieXyz</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">endpointBlue</span> <span class="o">=</span> <span class="n">endpointBlueExpr</span>
  <span class="k">let</span> <span class="n">gammaRedExpr</span> <span class="o">=</span> <span class="n">Bmp_FixedPoint16Dot16</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">gammaRed</span> <span class="o">=</span> <span class="n">gammaRedExpr</span>
  <span class="k">let</span> <span class="n">gammaBlueExpr</span> <span class="o">=</span> <span class="n">Bmp_FixedPoint16Dot16</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">gammaBlue</span> <span class="o">=</span> <span class="n">gammaBlueExpr</span>
  <span class="k">let</span> <span class="n">gammaGreenExpr</span> <span class="o">=</span> <span class="n">Bmp_FixedPoint16Dot16</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">gammaGreen</span> <span class="o">=</span> <span class="n">gammaGreenExpr</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapV4Extension], filename: string): Bmp_BitmapV4Extension =</span>
  <span class="n">Bmp_BitmapV4Extension</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>


<span class="sd">##[</span>
<span class="o">@</span><span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;https://docs.microsoft.com/en-us/previous-versions/dd183376(v=vs.85)&quot;</span><span class="o">&gt;</span><span class="n">Source</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">]</span><span class="sd">##</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapInfoExtension], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapHeader): Bmp_BitmapInfoExtension =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_BitmapInfoExtension</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

  <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">extendsOs22xBitmap</span><span class="p">):</span>
    <span class="k">let</span> <span class="n">compressionExpr</span> <span class="o">=</span> <span class="n">Bmp_Compressions</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">())</span>
    <span class="n">this</span><span class="p">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">compressionExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">parent</span><span class="p">.</span><span class="n">extendsOs22xBitmap</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">os2CompressionExpr</span> <span class="o">=</span> <span class="n">Bmp_Os2Compressions</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">())</span>
    <span class="n">this</span><span class="p">.</span><span class="n">os2Compression</span> <span class="o">=</span> <span class="n">os2CompressionExpr</span>

  <span class="sd">##[</span>
  <span class="k">If</span> <span class="n">biCompression</span> <span class="ow">is</span> <span class="n">BI_JPEG</span> <span class="ow">or</span> <span class="n">BI_PNG</span><span class="p">,</span> <span class="n">indicates</span> <span class="n">the</span> <span class="n">size</span> <span class="k">of</span> <span class="n">the</span> <span class="n">JPEG</span> <span class="ow">or</span> <span class="n">PNG</span> <span class="n">image</span> <span class="n">buffer</span><span class="p">.</span>
<span class="n">This</span> <span class="n">may</span> <span class="n">be</span> <span class="kt">set</span> <span class="n">to</span> <span class="n">zero</span> <span class="k">for</span> <span class="n">BI_RGB</span> <span class="n">bitmaps</span><span class="p">.</span>

  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">lenImageExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">lenImage</span> <span class="o">=</span> <span class="n">lenImageExpr</span>
  <span class="k">let</span> <span class="n">xResolutionExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">xResolution</span> <span class="o">=</span> <span class="n">xResolutionExpr</span>
  <span class="k">let</span> <span class="n">yResolutionExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">yResolution</span> <span class="o">=</span> <span class="n">yResolutionExpr</span>
  <span class="k">let</span> <span class="n">numColorsUsedExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">numColorsUsed</span> <span class="o">=</span> <span class="n">numColorsUsedExpr</span>
  <span class="k">let</span> <span class="n">numColorsImportantExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">numColorsImportant</span> <span class="o">=</span> <span class="n">numColorsImportantExpr</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapInfoExtension], filename: string): Bmp_BitmapInfoExtension =</span>
  <span class="n">Bmp_BitmapInfoExtension</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_FixedPoint2Dot30], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_CieXyz): Bmp_FixedPoint2Dot30 =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_FixedPoint2Dot30</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

  <span class="k">let</span> <span class="n">rawExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">rawExpr</span>

<span class="k">proc </span><span class="nf">value</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_FixedPoint2Dot30</span><span class="p">):</span> <span class="kt">float64</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">valueInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">valueInst</span>
  <span class="k">let</span> <span class="n">valueInstExpr</span> <span class="o">=</span> <span class="kt">float64</span><span class="p">(((</span><span class="kt">float32</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">raw</span><span class="p">))</span> <span class="ow">div</span> <span class="p">(</span><span class="mi">1</span> <span class="ow">shl</span> <span class="mi">30</span><span class="p">)))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">valueInst</span> <span class="o">=</span> <span class="n">valueInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">valueInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">valueInst</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_FixedPoint2Dot30], filename: string): Bmp_FixedPoint2Dot30 =</span>
  <span class="n">Bmp_FixedPoint2Dot30</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>


<span class="sd">##[</span>
<span class="n">Replace</span> <span class="k">with</span> <span class="n">an</span> <span class="n">opaque</span> <span class="k">type</span> <span class="k">if</span> <span class="n">you</span> <span class="n">care</span> <span class="n">about</span> <span class="n">the</span> <span class="n">pixels</span><span class="p">.</span>
<span class="n">You</span> <span class="n">can</span> <span class="n">look</span> <span class="n">at</span> <span class="n">an</span> <span class="n">example</span> <span class="k">of</span> <span class="n">a</span> <span class="n">JavaScript</span> <span class="n">implementation</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">generalmimon</span><span class="o">/</span><span class="n">bmptool</span><span class="o">/</span><span class="n">blob</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">Bitmap</span><span class="p">.</span><span class="n">js</span>

<span class="n">There</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">proposal</span> <span class="k">for</span> <span class="n">adding</span> <span class="n">bitmap</span> <span class="n">data</span> <span class="k">type</span> <span class="n">to</span> <span class="n">Kaitai</span> <span class="n">Struct</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">kaitai</span><span class="o">-</span><span class="n">io</span><span class="o">/</span><span class="n">kaitai_struct</span><span class="o">/</span><span class="n">issues</span><span class="o">/</span><span class="mi">188</span>

<span class="o">]</span><span class="sd">##</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_Bitmap], io: KaitaiStream, root: KaitaiStruct, parent: Bmp): Bmp_Bitmap =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_Bitmap</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>


<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_Bitmap], filename: string): Bmp_Bitmap =</span>
  <span class="n">Bmp_Bitmap</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>


<span class="sd">##[</span>
<span class="o">@</span><span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-bitmapcoreheader&quot;</span><span class="o">&gt;</span><span class="n">Source</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">@</span><span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;https://www.fileformat.info/format/os2bmp/egff.htm#OS2BMP-DMYID.3.1&quot;</span><span class="o">&gt;</span><span class="n">Source</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">]</span><span class="sd">##</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapHeader], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapInfo, lenHeader: any): Bmp_BitmapHeader =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_BitmapHeader</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="k">let</span> <span class="n">lenHeaderExpr</span> <span class="o">=</span> <span class="n">uint32</span><span class="p">(</span><span class="n">lenHeader</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">=</span> <span class="n">lenHeaderExpr</span>


  <span class="sd">##[</span>
  <span class="n">Image</span> <span class="n">width</span><span class="p">,</span> <span class="n">px</span>
  <span class="o">]</span><span class="sd">##</span>
  <span class="k">block</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">on</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">isCoreHeader</span>
    <span class="k">if</span> <span class="n">on</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
      <span class="k">let</span> <span class="n">imageWidthExpr</span> <span class="o">=</span> <span class="n">uint32</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU2le</span><span class="p">())</span>
      <span class="n">this</span><span class="p">.</span><span class="n">imageWidth</span> <span class="o">=</span> <span class="n">imageWidthExpr</span>
    <span class="k">elif</span> <span class="n">on</span> <span class="o">==</span> <span class="kp">false</span><span class="p">:</span>
      <span class="k">let</span> <span class="n">imageWidthExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
      <span class="n">this</span><span class="p">.</span><span class="n">imageWidth</span> <span class="o">=</span> <span class="n">imageWidthExpr</span>

  <span class="sd">##[</span>
  <span class="n">Image</span> <span class="n">height</span><span class="p">,</span> <span class="n">px</span> <span class="p">(</span><span class="n">positive</span> <span class="o">=&gt;</span> <span class="n">bottom</span><span class="o">-</span><span class="n">up</span> <span class="n">image</span><span class="p">,</span> <span class="n">negative</span> <span class="o">=&gt;</span> <span class="n">top</span><span class="o">-</span><span class="n">down</span> <span class="n">image</span><span class="p">)</span>
  <span class="o">]</span><span class="sd">##</span>
  <span class="k">block</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">on</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">isCoreHeader</span>
    <span class="k">if</span> <span class="n">on</span> <span class="o">==</span> <span class="kp">true</span><span class="p">:</span>
      <span class="k">let</span> <span class="n">imageHeightRawExpr</span> <span class="o">=</span> <span class="kt">int32</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readS2le</span><span class="p">())</span>
      <span class="n">this</span><span class="p">.</span><span class="n">imageHeightRaw</span> <span class="o">=</span> <span class="n">imageHeightRawExpr</span>
    <span class="k">elif</span> <span class="n">on</span> <span class="o">==</span> <span class="kp">false</span><span class="p">:</span>
      <span class="k">let</span> <span class="n">imageHeightRawExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readS4le</span><span class="p">()</span>
      <span class="n">this</span><span class="p">.</span><span class="n">imageHeightRaw</span> <span class="o">=</span> <span class="n">imageHeightRawExpr</span>

  <span class="sd">##[</span>
  <span class="n">Number</span> <span class="k">of</span> <span class="n">planes</span> <span class="k">for</span> <span class="n">target</span> <span class="n">device</span><span class="p">,</span> <span class="n">must</span> <span class="n">be</span> <span class="mi">1</span>
  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">numPlanesExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU2le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">numPlanes</span> <span class="o">=</span> <span class="n">numPlanesExpr</span>

  <span class="sd">##[</span>
  <span class="n">Number</span> <span class="k">of</span> <span class="n">bits</span> <span class="n">per</span> <span class="n">pixel</span> <span class="n">that</span> <span class="n">image</span> <span class="n">buffer</span> <span class="n">uses</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">24</span> <span class="ow">or</span> <span class="mi">32</span><span class="p">)</span>
  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">bitsPerPixelExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU2le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">=</span> <span class="n">bitsPerPixelExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapInfo</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">bitmapInfoExtExpr</span> <span class="o">=</span> <span class="n">Bmp_BitmapInfoExtension</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
    <span class="n">this</span><span class="p">.</span><span class="n">bitmapInfoExt</span> <span class="o">=</span> <span class="n">bitmapInfoExtExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHere</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">colorMaskExpr</span> <span class="o">=</span> <span class="n">Bmp_ColorMask</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">!=</span> <span class="n">ord</span><span class="p">(</span><span class="n">bmp</span><span class="p">.</span><span class="n">bitmap_v2_info_header</span><span class="p">))</span>
    <span class="n">this</span><span class="p">.</span><span class="n">colorMask</span> <span class="o">=</span> <span class="n">colorMaskExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsOs22xBitmap</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">os22xBitmapExtExpr</span> <span class="o">=</span> <span class="n">Bmp_Os22xBitmapExtension</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
    <span class="n">this</span><span class="p">.</span><span class="n">os22xBitmapExt</span> <span class="o">=</span> <span class="n">os22xBitmapExtExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV4</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">bitmapV4ExtExpr</span> <span class="o">=</span> <span class="n">Bmp_BitmapV4Extension</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
    <span class="n">this</span><span class="p">.</span><span class="n">bitmapV4Ext</span> <span class="o">=</span> <span class="n">bitmapV4ExtExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV5</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">bitmapV5ExtExpr</span> <span class="o">=</span> <span class="n">Bmp_BitmapV5Extension</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>
    <span class="n">this</span><span class="p">.</span><span class="n">bitmapV5Ext</span> <span class="o">=</span> <span class="n">bitmapV5ExtExpr</span>

<span class="k">proc </span><span class="nf">extendsBitmapV4</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV4Inst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV4Inst</span>
  <span class="k">let</span> <span class="n">extendsBitmapV4InstExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">&gt;=</span> <span class="n">ord</span><span class="p">(</span><span class="n">bmp</span><span class="p">.</span><span class="n">bitmap_v4_header</span><span class="p">))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV4Inst</span> <span class="o">=</span> <span class="n">extendsBitmapV4InstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV4Inst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV4Inst</span>

<span class="k">proc </span><span class="nf">extendsOs22xBitmap</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsOs22xBitmapInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsOs22xBitmapInst</span>
  <span class="k">let</span> <span class="n">extendsOs22xBitmapInstExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">==</span> <span class="n">ord</span><span class="p">(</span><span class="n">bmp</span><span class="p">.</span><span class="n">os2_2x_bitmap_header</span><span class="p">))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">extendsOs22xBitmapInst</span> <span class="o">=</span> <span class="n">extendsOs22xBitmapInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsOs22xBitmapInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsOs22xBitmapInst</span>

<span class="k">proc </span><span class="nf">usesFixedPalette</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">usesFixedPaletteInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">usesFixedPaletteInst</span>
  <span class="k">let</span> <span class="n">usesFixedPaletteInstExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span> <span class="p">((</span><span class="ow">not</span><span class="p">(</span> <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">))</span> <span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span> <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapInfo</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">extendsOs22xBitmap</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span> <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">bitmapInfoExt</span><span class="p">.</span><span class="n">compression</span> <span class="o">==</span> <span class="n">bmp</span><span class="p">.</span><span class="n">jpeg</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">bitmapInfoExt</span><span class="p">.</span><span class="n">compression</span> <span class="o">==</span> <span class="n">bmp</span><span class="p">.</span><span class="n">png</span><span class="p">))</span> <span class="p">))</span> <span class="p">)))</span> <span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">usesFixedPaletteInst</span> <span class="o">=</span> <span class="n">usesFixedPaletteInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">usesFixedPaletteInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">usesFixedPaletteInst</span>

<span class="k">proc </span><span class="nf">extendsBitmapInfo</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapInfoInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapInfoInst</span>
  <span class="k">let</span> <span class="n">extendsBitmapInfoInstExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">&gt;=</span> <span class="n">ord</span><span class="p">(</span><span class="n">bmp</span><span class="p">.</span><span class="n">bitmap_info_header</span><span class="p">))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapInfoInst</span> <span class="o">=</span> <span class="n">extendsBitmapInfoInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapInfoInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapInfoInst</span>

<span class="k">proc </span><span class="nf">imageHeight</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">int</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">imageHeightInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">imageHeightInst</span>
  <span class="k">let</span> <span class="n">imageHeightInstExpr</span> <span class="o">=</span> <span class="kt">int</span><span class="p">((</span><span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">imageHeightRaw</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="o">-</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">imageHeightRaw</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">imageHeightRaw</span><span class="p">))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">imageHeightInst</span> <span class="o">=</span> <span class="n">imageHeightInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">imageHeightInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">imageHeightInst</span>

<span class="k">proc </span><span class="nf">isCoreHeader</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isCoreHeaderInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">isCoreHeaderInst</span>
  <span class="k">let</span> <span class="n">isCoreHeaderInstExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">==</span> <span class="n">ord</span><span class="p">(</span><span class="n">bmp</span><span class="p">.</span><span class="n">bitmap_core_header</span><span class="p">))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">isCoreHeaderInst</span> <span class="o">=</span> <span class="n">isCoreHeaderInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isCoreHeaderInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">isCoreHeaderInst</span>

<span class="k">proc </span><span class="nf">extendsBitmapV5</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV5Inst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV5Inst</span>
  <span class="k">let</span> <span class="n">extendsBitmapV5InstExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">&gt;=</span> <span class="n">ord</span><span class="p">(</span><span class="n">bmp</span><span class="p">.</span><span class="n">bitmap_v5_header</span><span class="p">))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV5Inst</span> <span class="o">=</span> <span class="n">extendsBitmapV5InstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV5Inst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV5Inst</span>

<span class="k">proc </span><span class="nf">isColorMaskHere</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHereInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHereInst</span>
  <span class="k">let</span> <span class="n">isColorMaskHereInstExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span> <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">==</span> <span class="n">ord</span><span class="p">(</span><span class="n">bmp</span><span class="p">.</span><span class="n">bitmap_v2_info_header</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">==</span> <span class="n">ord</span><span class="p">(</span><span class="n">bmp</span><span class="p">.</span><span class="n">bitmap_v3_info_header</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">extendsBitmapV4</span><span class="p">))</span> <span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHereInst</span> <span class="o">=</span> <span class="n">isColorMaskHereInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHereInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHereInst</span>

<span class="k">proc </span><span class="nf">bottomUp</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapHeader</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">bottomUpInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">bottomUpInst</span>
  <span class="k">let</span> <span class="n">bottomUpInstExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">imageHeightRaw</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">bottomUpInst</span> <span class="o">=</span> <span class="n">bottomUpInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">bottomUpInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">bottomUpInst</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapHeader], filename: string): Bmp_BitmapHeader =</span>
  <span class="n">Bmp_BitmapHeader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>


<span class="sd">##[</span>
<span class="o">@</span><span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;https://www.fileformat.info/format/os2bmp/egff.htm#OS2BMP-DMYID.3.2&quot;</span><span class="o">&gt;</span><span class="n">Source</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">]</span><span class="sd">##</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_Os22xBitmapExtension], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapHeader): Bmp_Os22xBitmapExtension =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_Os22xBitmapExtension</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

  <span class="k">let</span> <span class="n">unitsExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU2le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">unitsExpr</span>
  <span class="k">let</span> <span class="n">reservedExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU2le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="n">reservedExpr</span>

  <span class="sd">##[</span>
  <span class="n">Specifies</span> <span class="n">how</span> <span class="n">the</span> <span class="n">bitmap</span> <span class="n">scan</span> <span class="n">lines</span> <span class="n">are</span> <span class="n">stored</span><span class="p">.</span>
<span class="n">The</span> <span class="n">only</span> <span class="n">valid</span> <span class="n">value</span> <span class="k">for</span> <span class="n">this</span> <span class="n">field</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">,</span> <span class="n">indicating</span> <span class="n">that</span> <span class="n">the</span> <span class="n">bitmap</span> <span class="ow">is</span>
<span class="n">stored</span> <span class="kn">from</span> <span class="n">left</span> <span class="n">to</span> <span class="n">right</span> <span class="ow">and</span> <span class="kn">from</span> <span class="n">the</span> <span class="n">bottom</span> <span class="n">up</span><span class="p">.</span>

  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">recordingExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU2le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">recording</span> <span class="o">=</span> <span class="n">recordingExpr</span>

  <span class="sd">##[</span>
  <span class="n">Specifies</span> <span class="n">the</span> <span class="n">halftoning</span> <span class="n">algorithm</span> <span class="n">used</span> <span class="n">on</span> <span class="n">the</span> <span class="n">bitmap</span> <span class="n">data</span><span class="p">.</span>
  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">renderingExpr</span> <span class="o">=</span> <span class="n">Bmp_Os2Rendering</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU2le</span><span class="p">())</span>
  <span class="n">this</span><span class="p">.</span><span class="n">rendering</span> <span class="o">=</span> <span class="n">renderingExpr</span>

  <span class="sd">##[</span>
  <span class="n">rendering</span> <span class="o">==</span> <span class="n">os2_rendering</span><span class="p">::</span><span class="n">error_diffusion</span>
  <span class="o">=&gt;</span> <span class="n">error</span> <span class="n">damping</span> <span class="k">as</span> <span class="n">a</span> <span class="n">percentage</span> <span class="ow">in</span> <span class="n">the</span> <span class="kt">range</span> <span class="mi">0</span> <span class="n">through</span> <span class="mi">100</span>
<span class="n">rendering</span> <span class="o">==</span> <span class="n">os2_rendering</span><span class="p">::</span><span class="n">panda</span> <span class="ow">or</span> <span class="n">rendering</span> <span class="o">==</span> <span class="n">os2_rendering</span><span class="p">::</span><span class="n">super_circle</span>
  <span class="o">=&gt;</span> <span class="n">X</span> <span class="n">dimension</span> <span class="k">of</span> <span class="n">the</span> <span class="n">pattern</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">pixels</span>

  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">size1Expr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">size1</span> <span class="o">=</span> <span class="n">size1Expr</span>

  <span class="sd">##[</span>
  <span class="n">rendering</span> <span class="o">==</span> <span class="n">os2_rendering</span><span class="p">::</span><span class="n">error_diffusion</span>
  <span class="o">=&gt;</span> <span class="ow">not</span> <span class="n">used</span>
<span class="n">rendering</span> <span class="o">==</span> <span class="n">os2_rendering</span><span class="p">::</span><span class="n">panda</span> <span class="ow">or</span> <span class="n">rendering</span> <span class="o">==</span> <span class="n">os2_rendering</span><span class="p">::</span><span class="n">super_circle</span>
  <span class="o">=&gt;</span> <span class="n">Y</span> <span class="n">dimension</span> <span class="k">of</span> <span class="n">the</span> <span class="n">pattern</span> <span class="n">used</span> <span class="ow">in</span> <span class="n">pixels</span>

  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">size2Expr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">size2</span> <span class="o">=</span> <span class="n">size2Expr</span>

  <span class="sd">##[</span>
  <span class="n">Specifies</span> <span class="n">the</span> <span class="n">color</span> <span class="n">model</span> <span class="n">used</span> <span class="n">to</span> <span class="n">describe</span> <span class="n">the</span> <span class="n">bitmap</span> <span class="n">data</span><span class="p">.</span>
<span class="n">The</span> <span class="n">only</span> <span class="n">valid</span> <span class="n">value</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">,</span> <span class="n">indicating</span> <span class="n">the</span> <span class="n">RGB</span> <span class="n">encoding</span> <span class="n">scheme</span><span class="p">.</span>

  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">colorEncodingExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">colorEncoding</span> <span class="o">=</span> <span class="n">colorEncodingExpr</span>

  <span class="sd">##[</span>
  <span class="n">Application</span><span class="o">-</span><span class="n">specific</span> <span class="n">value</span>
  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">identifierExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifierExpr</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_Os22xBitmapExtension], filename: string): Bmp_Os22xBitmapExtension =</span>
  <span class="n">Bmp_Os22xBitmapExtension</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_FixedPoint16Dot16], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapV4Extension): Bmp_FixedPoint16Dot16 =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_FixedPoint16Dot16</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

  <span class="k">let</span> <span class="n">rawExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">rawExpr</span>

<span class="k">proc </span><span class="nf">value</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_FixedPoint16Dot16</span><span class="p">):</span> <span class="kt">float64</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">valueInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">valueInst</span>
  <span class="k">let</span> <span class="n">valueInstExpr</span> <span class="o">=</span> <span class="kt">float64</span><span class="p">(((</span><span class="kt">float32</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">raw</span><span class="p">))</span> <span class="ow">div</span> <span class="p">(</span><span class="mi">1</span> <span class="ow">shl</span> <span class="mi">16</span><span class="p">)))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">valueInst</span> <span class="o">=</span> <span class="n">valueInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">valueInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">valueInst</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_FixedPoint16Dot16], filename: string): Bmp_FixedPoint16Dot16 =</span>
  <span class="n">Bmp_FixedPoint16Dot16</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_ColorTable], io: KaitaiStream, root: KaitaiStruct, parent: Bmp_BitmapInfo, hasReservedField: any, numColors: any): Bmp_ColorTable =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_ColorTable</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="k">let</span> <span class="n">hasReservedFieldExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span><span class="n">hasReservedField</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">hasReservedField</span> <span class="o">=</span> <span class="n">hasReservedFieldExpr</span>
  <span class="k">let</span> <span class="n">numColorsExpr</span> <span class="o">=</span> <span class="n">uint32</span><span class="p">(</span><span class="n">numColors</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">numColors</span> <span class="o">=</span> <span class="n">numColorsExpr</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="mi">0</span> <span class="p">..</span><span class="o">&lt;</span> <span class="kt">int</span><span class="p">((</span><span class="k">if</span>  <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">numColors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">numColors</span> <span class="o">&lt;</span> <span class="n">this</span><span class="p">.</span><span class="n">numColorsPresent</span><span class="p">))</span> <span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">numColors</span> <span class="k">else</span><span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">numColorsPresent</span><span class="p">)):</span>
    <span class="k">let</span> <span class="n">it</span> <span class="o">=</span> <span class="n">Bmp_RgbRecord</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">hasReservedField</span><span class="p">)</span>
    <span class="n">this</span><span class="p">.</span><span class="n">colors</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>

<span class="k">proc </span><span class="nf">numColorsPresent</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_ColorTable</span><span class="p">):</span> <span class="kt">int</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">numColorsPresentInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">numColorsPresentInst</span>
  <span class="k">let</span> <span class="n">numColorsPresentInstExpr</span> <span class="o">=</span> <span class="kt">int</span><span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">size</span> <span class="ow">div</span> <span class="p">(</span><span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">hasReservedField</span><span class="p">:</span> <span class="mi">4</span> <span class="k">else</span><span class="p">:</span> <span class="mi">3</span><span class="p">)))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">numColorsPresentInst</span> <span class="o">=</span> <span class="n">numColorsPresentInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">numColorsPresentInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">numColorsPresentInst</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_ColorTable], filename: string): Bmp_ColorTable =</span>
  <span class="n">Bmp_ColorTable</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>


<span class="sd">##[</span>
<span class="o">@</span><span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-bitmapfileheader&quot;</span><span class="o">&gt;</span><span class="n">Source</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">]</span><span class="sd">##</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_FileHeader], io: KaitaiStream, root: KaitaiStruct, parent: Bmp): Bmp_FileHeader =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_FileHeader</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

  <span class="k">let</span> <span class="n">fileTypeExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readBytes</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">fileType</span> <span class="o">=</span> <span class="n">fileTypeExpr</span>

  <span class="sd">##[</span>
  <span class="ow">not</span> <span class="n">reliable</span><span class="p">,</span> <span class="n">mostly</span> <span class="n">ignored</span> <span class="n">by</span> <span class="n">BMP</span> <span class="n">decoders</span>
  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">lenFileExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">lenFile</span> <span class="o">=</span> <span class="n">lenFileExpr</span>
  <span class="k">let</span> <span class="n">reserved1Expr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU2le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">reserved1</span> <span class="o">=</span> <span class="n">reserved1Expr</span>
  <span class="k">let</span> <span class="n">reserved2Expr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU2le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="n">reserved2Expr</span>

  <span class="sd">##[</span>
  <span class="n">Offset</span> <span class="n">to</span> <span class="n">actual</span> <span class="n">raw</span> <span class="n">pixel</span> <span class="n">data</span> <span class="k">of</span> <span class="n">the</span> <span class="n">image</span>
  <span class="o">]</span><span class="sd">##</span>
  <span class="k">let</span> <span class="n">ofsBitmapExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readS4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">ofsBitmap</span> <span class="o">=</span> <span class="n">ofsBitmapExpr</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_FileHeader], filename: string): Bmp_FileHeader =</span>
  <span class="n">Bmp_FileHeader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>


<span class="sd">##[</span>
<span class="o">@</span><span class="n">see</span> <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;https://docs.microsoft.com/en-us/windows/win32/api/wingdi/ns-wingdi-bitmapinfo&quot;</span><span class="o">&gt;</span><span class="n">Source</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">]</span><span class="sd">##</span>
<span class="k">proc </span><span class="nf">read</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapInfo], io: KaitaiStream, root: KaitaiStruct, parent: Bmp): Bmp_BitmapInfo =</span>
  <span class="k">template</span> <span class="n">this</span><span class="p">:</span> <span class="n">untyped</span> <span class="o">=</span> <span class="n">result</span>
  <span class="n">this</span> <span class="o">=</span> <span class="n">new</span><span class="p">(</span><span class="n">Bmp_BitmapInfo</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="k">if</span> <span class="n">root</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">cast</span><span class="o">[</span><span class="n">Bmp</span><span class="o">]</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">io</span> <span class="o">=</span> <span class="n">io</span>
  <span class="n">this</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
  <span class="n">this</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

  <span class="k">let</span> <span class="n">lenHeaderExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readU4le</span><span class="p">()</span>
  <span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">=</span> <span class="n">lenHeaderExpr</span>
  <span class="k">let</span> <span class="n">rawHeaderExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readBytes</span><span class="p">(</span><span class="kt">int</span><span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">rawHeader</span> <span class="o">=</span> <span class="n">rawHeaderExpr</span>
  <span class="k">let</span> <span class="n">rawHeaderIo</span> <span class="o">=</span> <span class="n">newKaitaiStream</span><span class="p">(</span><span class="n">rawHeaderExpr</span><span class="p">)</span>
  <span class="k">let</span> <span class="n">headerExpr</span> <span class="o">=</span> <span class="n">Bmp_BitmapHeader</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">rawHeaderIo</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">lenHeader</span><span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">headerExpr</span>

  <span class="sd">##[</span>
  <span class="n">Valid</span> <span class="n">only</span> <span class="k">for</span> <span class="n">BITMAPINFOHEADER</span><span class="p">,</span> <span class="ow">in</span> <span class="n">all</span> <span class="n">headers</span> <span class="n">extending</span> <span class="n">it</span> <span class="n">the</span> <span class="n">masks</span> <span class="n">are</span> <span class="n">contained</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">header</span> <span class="n">itself</span><span class="p">.</span>
  <span class="o">]</span><span class="sd">##</span>
  <span class="k">if</span>  <span class="p">((</span><span class="ow">not</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">isEof</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHere</span><span class="p">))</span> <span class="p">:</span>
    <span class="k">let</span> <span class="n">colorMaskExpr</span> <span class="o">=</span> <span class="n">Bmp_ColorMask</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitmapInfoExt</span><span class="p">.</span><span class="n">compression</span> <span class="o">==</span> <span class="n">bmp</span><span class="p">.</span><span class="n">alpha_bitfields</span><span class="p">)</span>
    <span class="n">this</span><span class="p">.</span><span class="n">colorMask</span> <span class="o">=</span> <span class="n">colorMaskExpr</span>
  <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">isEof</span><span class="p">):</span>
    <span class="k">let</span> <span class="n">rawColorTableExpr</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">readBytesFull</span><span class="p">()</span>
    <span class="n">this</span><span class="p">.</span><span class="n">rawColorTable</span> <span class="o">=</span> <span class="n">rawColorTableExpr</span>
    <span class="k">let</span> <span class="n">rawColorTableIo</span> <span class="o">=</span> <span class="n">newKaitaiStream</span><span class="p">(</span><span class="n">rawColorTableExpr</span><span class="p">)</span>
    <span class="k">let</span> <span class="n">colorTableExpr</span> <span class="o">=</span> <span class="n">Bmp_ColorTable</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">rawColorTableIo</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="ow">not</span><span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">isCoreHeader</span><span class="p">),</span> <span class="p">(</span><span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">extendsBitmapInfo</span><span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitmapInfoExt</span><span class="p">.</span><span class="n">numColorsUsed</span> <span class="k">else</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">this</span><span class="p">.</span><span class="n">colorTable</span> <span class="o">=</span> <span class="n">colorTableExpr</span>

<span class="k">proc </span><span class="nf">isColorMaskGiven</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskGivenInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskGivenInst</span>
  <span class="k">let</span> <span class="n">isColorMaskGivenInstExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span> <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">extendsBitmapInfo</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitmapInfoExt</span><span class="p">.</span><span class="n">compression</span> <span class="o">==</span> <span class="n">bmp</span><span class="p">.</span><span class="n">bitfields</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitmapInfoExt</span><span class="p">.</span><span class="n">compression</span> <span class="o">==</span> <span class="n">bmp</span><span class="p">.</span><span class="n">alpha_bitfields</span><span class="p">))</span> <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span> <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHere</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">isColorMaskHere</span><span class="p">))</span> <span class="p">))</span> <span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskGivenInst</span> <span class="o">=</span> <span class="n">isColorMaskGivenInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskGivenInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskGivenInst</span>

<span class="k">proc </span><span class="nf">colorMaskGiven</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="n">Bmp_ColorMask</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGivenInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGivenInst</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskGiven</span><span class="p">:</span>
    <span class="k">let</span> <span class="n">colorMaskGivenInstExpr</span> <span class="o">=</span> <span class="n">Bmp_ColorMask</span><span class="p">((</span><span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHere</span><span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMask</span> <span class="k">else</span><span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">colorMask</span><span class="p">))</span>
    <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGivenInst</span> <span class="o">=</span> <span class="n">colorMaskGivenInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGivenInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGivenInst</span>

<span class="k">proc </span><span class="nf">colorMaskBlue</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="n">uint32</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskBlueInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskBlueInst</span>
  <span class="k">let</span> <span class="n">colorMaskBlueInstExpr</span> <span class="o">=</span> <span class="n">uint32</span><span class="p">((</span><span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskGiven</span><span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGiven</span><span class="p">.</span><span class="n">blueMask</span> <span class="k">else</span><span class="p">:</span> <span class="p">(</span><span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span> <span class="mi">31</span> <span class="k">else</span><span class="p">:</span> <span class="p">(</span><span class="k">if</span>  <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">))</span> <span class="p">:</span> <span class="mi">255</span> <span class="k">else</span><span class="p">:</span> <span class="mi">0</span><span class="p">))))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">colorMaskBlueInst</span> <span class="o">=</span> <span class="n">colorMaskBlueInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskBlueInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskBlueInst</span>

<span class="k">proc </span><span class="nf">colorMaskAlpha</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="n">uint32</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskAlphaInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskAlphaInst</span>
  <span class="k">let</span> <span class="n">colorMaskAlphaInstExpr</span> <span class="o">=</span> <span class="n">uint32</span><span class="p">((</span><span class="k">if</span>  <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">isColorMaskGiven</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">colorMaskGiven</span><span class="p">.</span><span class="n">hasAlphaMask</span><span class="p">))</span> <span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGiven</span><span class="p">.</span><span class="n">alphaMask</span> <span class="k">else</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">colorMaskAlphaInst</span> <span class="o">=</span> <span class="n">colorMaskAlphaInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskAlphaInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskAlphaInst</span>

<span class="k">proc </span><span class="nf">colorMaskGreen</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="kt">int</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGreenInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGreenInst</span>
  <span class="k">let</span> <span class="n">colorMaskGreenInstExpr</span> <span class="o">=</span> <span class="kt">int</span><span class="p">((</span><span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskGiven</span><span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGiven</span><span class="p">.</span><span class="n">greenMask</span> <span class="k">else</span><span class="p">:</span> <span class="p">(</span><span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span> <span class="mi">992</span> <span class="k">else</span><span class="p">:</span> <span class="p">(</span><span class="k">if</span>  <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">))</span> <span class="p">:</span> <span class="mi">65280</span> <span class="k">else</span><span class="p">:</span> <span class="mi">0</span><span class="p">))))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGreenInst</span> <span class="o">=</span> <span class="n">colorMaskGreenInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGreenInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGreenInst</span>

<span class="k">proc </span><span class="nf">isColorMaskHere</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="kt">bool</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHereInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHereInst</span>
  <span class="k">let</span> <span class="n">isColorMaskHereInstExpr</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span> <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">lenHeader</span> <span class="o">==</span> <span class="n">ord</span><span class="p">(</span><span class="n">bmp</span><span class="p">.</span><span class="n">bitmap_info_header</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span> <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitmapInfoExt</span><span class="p">.</span><span class="n">compression</span> <span class="o">==</span> <span class="n">bmp</span><span class="p">.</span><span class="n">bitfields</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitmapInfoExt</span><span class="p">.</span><span class="n">compression</span> <span class="o">==</span> <span class="n">bmp</span><span class="p">.</span><span class="n">alpha_bitfields</span><span class="p">))</span> <span class="p">))</span> <span class="p">)</span>
  <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHereInst</span> <span class="o">=</span> <span class="n">isColorMaskHereInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHereInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskHereInst</span>

<span class="k">proc </span><span class="nf">colorMaskRed</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Bmp_BitmapInfo</span><span class="p">):</span> <span class="kt">int</span> <span class="o">=</span> 
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskRedInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskRedInst</span>
  <span class="k">let</span> <span class="n">colorMaskRedInstExpr</span> <span class="o">=</span> <span class="kt">int</span><span class="p">((</span><span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">isColorMaskGiven</span><span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskGiven</span><span class="p">.</span><span class="n">redMask</span> <span class="k">else</span><span class="p">:</span> <span class="p">(</span><span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span> <span class="mi">31744</span> <span class="k">else</span><span class="p">:</span> <span class="p">(</span><span class="k">if</span>  <span class="p">((</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">this</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">bitsPerPixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">))</span> <span class="p">:</span> <span class="mi">16711680</span> <span class="k">else</span><span class="p">:</span> <span class="mi">0</span><span class="p">))))</span>
  <span class="n">this</span><span class="p">.</span><span class="n">colorMaskRedInst</span> <span class="o">=</span> <span class="n">colorMaskRedInstExpr</span>
  <span class="k">if</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskRedInst</span> <span class="o">!=</span> <span class="kp">nil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">colorMaskRedInst</span>

<span class="k">proc </span><span class="nf">fromFile</span><span class="o">*</span><span class="p">(</span><span class="err">_: typedesc[Bmp_BitmapInfo], filename: string): Bmp_BitmapInfo =</span>
  <span class="n">Bmp_BitmapInfo</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">newKaitaiFileStream</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
</pre></div>

        </div>
        
    </div>
</section>

    <footer id="main-footer">
        <div class="container">
            &copy; 2015-2020 Kaitai Project and <a href="https://github.com/kaitai-io/kaitai_struct_formats/graphs/contributors">formats repo contributors</a>

            <h3>Contacts</h3>

            <div class="row">
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-github"></i> <a href="https://github.com/kaitai-io/kaitai_struct">GitHub</a>
                </div>
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-twitter"></i> <a href="https://twitter.com/kaitai_io">@kaitai_io</a>
                </div>
                <div class="col-sm-4">
                    Gitter: <a href="https://gitter.im/kaitai_struct/Lobby">kaitai_struct</a>
                </div>
            </div>
        </div>
    </footer>

  <script src="//kaitai.io/js/jquery-1.12.3.min.js"></script>
  <script src="//kaitai.io/js/bootstrap.min.js"></script>

  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-76299550-1', 'auto');
      ga('send', 'pageview');
  </script>
</body>
</html>
