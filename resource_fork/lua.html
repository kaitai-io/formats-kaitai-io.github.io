<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Macintosh resource fork data: Lua parsing library</title>
  <meta name="keywords" content="kaitai,struct,binary,format,parsing,decoding,java,javascript,python,ruby,library,metadata">
  <meta name="description" content="Kaitai Struct is a formal language for binary format specification that can be compiled into parser code">

  <link rel="stylesheet" href="//kaitai.io/styles/bootstrap.min.css">
  <link rel="stylesheet" href="//kaitai.io/styles/bootstrap-theme.min.css">
  <link href='https://fonts.googleapis.com/css?family=Exo:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Share+Tech+Mono' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="//kaitai.io/styles/main.css" type="text/css">
  <link rel="stylesheet" href="/pygments-default.css" type="text/css">
  <style>
.diagram-img {
    display: block;
    max-width: 100%;
    height: auto;
    margin: 0 auto;
}

section.format {
    padding: 30px 0;
}

section#format-meta, section#format-index-header {
    background: #e3eef7;
}

section#format-diagram, section#format-index-footer {
    background: #e9f8dd;
}

section#format-ksy, section#format-lang {
    background: #d1eadd;
}

section#format-index .row {
    padding-bottom: 10px;
}

  </style>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MFSBBRGREL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-MFSBBRGREL');
  </script>
</head>
<body data-spy="scroll" data-target="#main-navbar" data-offset="100">

    <nav class="navbar navbar-inverse navbar-fixed-top" id="main-navbar">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-navbar-collapse" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <span class="navbar-brand">Kaitai Struct</span>
            </div>
            <div class="collapse navbar-collapse" id="main-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="//kaitai.io/#what-is-it">What is it?</a></li>
                    <li><a href="//kaitai.io/#quick-start">Quick Start</a></li>
                    <li><a href="//kaitai.io/#download">Download</a></li>
                    <li><a href="//kaitai.io/news/">News</a></li>
                    <li class="active"><a href="//formats.kaitai.io/">Format Gallery</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="https://ide.kaitai.io/">Try it &mdash; Web IDE</a></li>
                    <li><a href="//doc.kaitai.io/">Documentation</a></li>
                </ul>
            </div>
        </div>
    </nav>
<nav>
    <div class="container">
    <ol class="breadcrumb">
        <li><a href="../">Format Gallery</a></li>
        <li>macOS-specific</li>
        <li class="active">Macintosh resource fork data</li>
    </ol>
    </div>
</nav>

<section id="format-meta" class="format">
    <div class="container">
        <h1>Macintosh resource fork data:
            
            Lua parsing library
            
        </h1>

        <div class="row">
            <div class="col-md-8">
                <p><p>The data format of Macintosh resource forks,<br />
used on Classic Mac OS and Mac OS X/macOS to store additional structured data along with a file's main data (the data fork).<br />
The kinds of data stored in resource forks include:</p>
<ul>
<li>Document resources:<br />
images, sounds, etc. used by a document</li>
<li>Application resources:<br />
graphics, GUI layouts, localizable strings,<br />
and even code used by an application, a library, or system files</li>
<li>Common metadata:<br />
custom icons and version metadata that could be displayed by the Finder</li>
<li>Application-specific metadata:<br />
because resource forks follow a common format,<br />
other applications can store new metadata in them,<br />
even if the original application does not recognize or understand it</li>
</ul>
<p>Macintosh file systems (MFS, HFS, HFS+, APFS) support resource forks natively,<br />
which allows storing resources along with any file.<br />
Non-Macintosh file systems and protocols have little or no support for resource forks,<br />
so the resource fork data must be stored in some other way when using such file systems or protocols.<br />
Various file formats and tools exist for this purpose,<br />
such as BinHex, MacBinary, AppleSingle, AppleDouble, or QuickTime RezWack.<br />
In some cases,<br />
resource forks are stored as plain data in separate files with a .rsrc extension,<br />
even on Mac systems that natively support resource forks.</p>
<p>On modern Mac OS X/macOS systems,<br />
resource forks are used far less commonly than on classic Mac OS systems,<br />
because of compatibility issues with other systems and historical limitations in the format.<br />
Modern macOS APIs and libraries do not use resource forks,<br />
and the legacy Carbon API that still used them has been deprecated since OS X 10.8.<br />
Despite this,<br />
even current macOS systems still use resource forks for certain purposes,<br />
such as custom file icons.</p>
</p>
            </div>
            <div class="col-md-4">
                <div class="panel panel-info">
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">Application</h3>
                    </div>
                    <div class="panel-body">
                        Mac OS
                    </div>
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">File extension</h3>
                    </div>
                    <div class="panel-body">
                        ["rsrc", "dfont"]
                    </div>
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">KS implementation details</h3>
                    </div>
                    
                    <div class="panel-body">
                        License: <a href="https://spdx.org/licenses/MIT.html">MIT</a>
                    </div>
                    
                    
                    <div class="panel-body">
                        Minimal Kaitai Struct required: 0.9
                    </div>
                    
                    
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">References</h3>
                    </div>
                    <div class="panel-body">
                        <ul>
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            <li><a href="https://www.wikidata.org/wiki/Q3933446">Wikidata Q3933446</a></li>
                            
                            
                            
                            <li><a href="http://fileformats.archiveteam.org/wiki/Resource_Fork">Resource Fork in Just Solve the File Format Problem</a></li>
                            
                        </ul>
                    </div>
                    
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
            <p>
            This page hosts a formal specification of Macintosh resource fork data
            using <a href="//kaitai.io">Kaitai Struct</a>. This
            specification can be automatically translated into a
            variety of programming languages to get a parsing library.
            </p>

            <ul class="nav nav-pills">
                
                
                <li>
                
                <a href="index.html" title="Macintosh resource fork data parsing Overview library">Overview</a></li>
                
                
                <li>
                
                <a href="cpp_stl_11.html" title="Macintosh resource fork data parsing C++11/STL library">C++11/STL</a></li>
                
                
                <li>
                
                <a href="cpp_stl_98.html" title="Macintosh resource fork data parsing C++98/STL library">C++98/STL</a></li>
                
                
                <li>
                
                <a href="csharp.html" title="Macintosh resource fork data parsing C# library">C#</a></li>
                
                
                <li>
                
                <a href="go.html" title="Macintosh resource fork data parsing Go library">Go</a></li>
                
                
                <li>
                
                <a href="graphviz.html" title="Macintosh resource fork data parsing GraphViz library">GraphViz</a></li>
                
                
                <li>
                
                <a href="java.html" title="Macintosh resource fork data parsing Java library">Java</a></li>
                
                
                <li>
                
                <a href="javascript.html" title="Macintosh resource fork data parsing JavaScript library">JavaScript</a></li>
                
                
                <li class="active">
                
                <a href="lua.html" title="Macintosh resource fork data parsing Lua library">Lua</a></li>
                
                
                <li>
                
                <a href="nim.html" title="Macintosh resource fork data parsing Nim library">Nim</a></li>
                
                
                <li>
                
                <a href="perl.html" title="Macintosh resource fork data parsing Perl library">Perl</a></li>
                
                
                <li>
                
                <a href="php.html" title="Macintosh resource fork data parsing PHP library">PHP</a></li>
                
                
                <li>
                
                <a href="python.html" title="Macintosh resource fork data parsing Python library">Python</a></li>
                
                
                <li>
                
                <a href="ruby.html" title="Macintosh resource fork data parsing Ruby library">Ruby</a></li>
                
            </ul>
            </div>
        </div>
    </div>
</section>


<section id="format-lang" class="format">
    <div class="container">
        <h2>
            
            Lua source code to parse Macintosh resource fork data
            
        </h2>

        

        <h3>resource_fork.lua</h3>

        <div class="row">
            <div class="pull-right">
                <p>
                    <a href="src/lua/resource_fork.lua" download="resource_fork.lua" class="btn btn-success">Download <i class="fa fa-download"></i></a>
                </p>
            </div>
        </div>

        <div class="row">
            <div class="highlight"><pre><span></span><span class="c1">-- This is a generated file! Please edit source .ksy file and use kaitai-struct-compiler to rebuild</span>
<span class="c1">--</span>
<span class="c1">-- This file is compatible with Lua 5.3</span>

<span class="kd">local</span> <span class="n">class</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">)</span>
<span class="nb">require</span><span class="p">(</span><span class="s2">&quot;kaitaistruct&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">stringstream</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;string_stream&quot;</span><span class="p">)</span>

<span class="nb">require</span><span class="p">(</span><span class="s2">&quot;bytes_with_io&quot;</span><span class="p">)</span>
<span class="c1">-- </span>
<span class="c1">-- The data format of Macintosh resource forks,</span>
<span class="c1">-- used on Classic Mac OS and Mac OS X/macOS to store additional structured data along with a file&#39;s main data (the data fork).</span>
<span class="c1">-- The kinds of data stored in resource forks include:</span>
<span class="c1">-- </span>
<span class="c1">-- * Document resources:</span>
<span class="c1">--   images, sounds, etc. used by a document</span>
<span class="c1">-- * Application resources:</span>
<span class="c1">--   graphics, GUI layouts, localizable strings,</span>
<span class="c1">--   and even code used by an application, a library, or system files</span>
<span class="c1">-- * Common metadata:</span>
<span class="c1">--   custom icons and version metadata that could be displayed by the Finder</span>
<span class="c1">-- * Application-specific metadata:</span>
<span class="c1">--   because resource forks follow a common format,</span>
<span class="c1">--   other applications can store new metadata in them,</span>
<span class="c1">--   even if the original application does not recognize or understand it</span>
<span class="c1">-- </span>
<span class="c1">-- Macintosh file systems (MFS, HFS, HFS+, APFS) support resource forks natively,</span>
<span class="c1">-- which allows storing resources along with any file.</span>
<span class="c1">-- Non-Macintosh file systems and protocols have little or no support for resource forks,</span>
<span class="c1">-- so the resource fork data must be stored in some other way when using such file systems or protocols.</span>
<span class="c1">-- Various file formats and tools exist for this purpose,</span>
<span class="c1">-- such as BinHex, MacBinary, AppleSingle, AppleDouble, or QuickTime RezWack.</span>
<span class="c1">-- In some cases,</span>
<span class="c1">-- resource forks are stored as plain data in separate files with a .rsrc extension,</span>
<span class="c1">-- even on Mac systems that natively support resource forks.</span>
<span class="c1">-- </span>
<span class="c1">-- On modern Mac OS X/macOS systems,</span>
<span class="c1">-- resource forks are used far less commonly than on classic Mac OS systems,</span>
<span class="c1">-- because of compatibility issues with other systems and historical limitations in the format.</span>
<span class="c1">-- Modern macOS APIs and libraries do not use resource forks,</span>
<span class="c1">-- and the legacy Carbon API that still used them has been deprecated since OS X 10.8.</span>
<span class="c1">-- Despite this,</span>
<span class="c1">-- even current macOS systems still use resource forks for certain purposes,</span>
<span class="c1">-- such as custom file icons.</span>
<span class="c1">-- See also: Inside Macintosh, More Macintosh Toolbox, Resource Manager, Resource Manager Reference, Resource File Format (https://developer.apple.com/library/archive/documentation/mac/pdf/MoreMacintoshToolbox.pdf#page=151)</span>
<span class="c1">-- See also: Inside Macintosh, Volume I, The Resource Manager, Format of a Resource File (https://www.pagetable.com/?p=50)</span>
<span class="c1">-- See also: Source (https://github.com/kreativekorp/ksfl/wiki/Macintosh-Resource-File-Format)</span>
<span class="c1">-- See also: Source (https://github.com/dgelessus/mac_file_format_docs/blob/master/README.md#resource-forks)</span>
<span class="n">ResourceFork</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">FileHeader</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">system_data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes</span><span class="p">(</span><span class="mi">112</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">application_data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- Use `data_blocks` instead,</span>
<span class="c1">-- unless you need access to this instance&#39;s `_io`.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">data_blocks_with_io</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">data_blocks_with_io</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_data_blocks_with_io</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_data_blocks_with_io</span>
  <span class="kr">end</span>

  <span class="kd">local</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">pos</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">ofs_data_blocks</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_raw__m_data_blocks_with_io</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">len_data_blocks</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">_io</span> <span class="o">=</span> <span class="n">KaitaiStream</span><span class="p">(</span><span class="n">stringstream</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw__m_data_blocks_with_io</span><span class="p">))</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_m_data_blocks_with_io</span> <span class="o">=</span> <span class="n">BytesWithIo</span><span class="p">(</span><span class="n">_io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_data_blocks_with_io</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- Storage area for the data blocks of all resources.</span>
<span class="c1">-- </span>
<span class="c1">-- These data blocks are not required to appear in any particular order,</span>
<span class="c1">-- and there may be unused space between and around them.</span>
<span class="c1">-- </span>
<span class="c1">-- In practice,</span>
<span class="c1">-- the data blocks in newly created resource files are usually contiguous.</span>
<span class="c1">-- When existing resources are shortened,</span>
<span class="c1">-- the Mac OS resource manager leaves unused space where the now removed resource data was,</span>
<span class="c1">-- as this is quicker than moving the following resource data into the newly freed space.</span>
<span class="c1">-- Such unused space may be cleaned up later when the resource manager &quot;compacts&quot; the resource file,</span>
<span class="c1">-- which happens when resources are removed entirely,</span>
<span class="c1">-- or when resources are added or grown so that more space is needed in the data area.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">data_blocks</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">data_blocks</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_data_blocks</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_data_blocks</span>
  <span class="kr">end</span>

  <span class="n">self</span><span class="p">.</span><span class="n">_m_data_blocks</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">data_blocks_with_io</span><span class="p">.</span><span class="n">data</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_data_blocks</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The resource file&#39;s resource map.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">resource_map</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">resource_map</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_resource_map</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_resource_map</span>
  <span class="kr">end</span>

  <span class="kd">local</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">pos</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">ofs_resource_map</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_raw__m_resource_map</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">len_resource_map</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">_io</span> <span class="o">=</span> <span class="n">KaitaiStream</span><span class="p">(</span><span class="n">stringstream</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw__m_resource_map</span><span class="p">))</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_m_resource_map</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_resource_map</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The resource file&#39;s header information.</span>
<span class="c1">-- </span>
<span class="c1">-- System-reserved data area.</span>
<span class="c1">-- This field can generally be ignored when reading and writing.</span>
<span class="c1">-- </span>
<span class="c1">-- This field is used by the Classic Mac OS Finder as temporary storage space.</span>
<span class="c1">-- It usually contains parts of the file metadata (name, type/creator code, etc.).</span>
<span class="c1">-- Any existing data in this field is ignored and overwritten.</span>
<span class="c1">-- </span>
<span class="c1">-- In resource files written by Mac OS X,</span>
<span class="c1">-- this field is set to all zero bytes.</span>
<span class="c1">-- </span>
<span class="c1">-- Application-specific data area.</span>
<span class="c1">-- This field can generally be ignored when reading and writing.</span>
<span class="c1">-- </span>
<span class="c1">-- According to early revisions of Inside Macintosh,</span>
<span class="c1">-- this field is &quot;available for application data&quot;.</span>
<span class="c1">-- In practice, it is almost never used for this purpose,</span>
<span class="c1">-- and usually contains only junk data.</span>
<span class="c1">-- </span>
<span class="c1">-- In resource files written by Mac OS X,</span>
<span class="c1">-- this field is set to all zero bytes.</span>

<span class="c1">-- </span>
<span class="c1">-- Resource file header,</span>
<span class="c1">-- containing the offsets and lengths of the resource data area and resource map.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">FileHeader</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">FileHeader</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">FileHeader</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">ofs_data_blocks</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u4be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">ofs_resource_map</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u4be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">len_data_blocks</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u4be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">len_resource_map</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u4be</span><span class="p">()</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- Offset of the resource data area,</span>
<span class="c1">-- from the start of the resource file.</span>
<span class="c1">-- </span>
<span class="c1">-- In practice,</span>
<span class="c1">-- this should always be `256`,</span>
<span class="c1">-- i. e. the resource data area should directly follow the application-specific data area.</span>
<span class="c1">-- </span>
<span class="c1">-- Offset of the resource map,</span>
<span class="c1">-- from the start of the resource file.</span>
<span class="c1">-- </span>
<span class="c1">-- In practice,</span>
<span class="c1">-- this should always be `ofs_data_blocks + len_data_blocks`,</span>
<span class="c1">-- i. e. the resource map should directly follow the resource data area.</span>
<span class="c1">-- </span>
<span class="c1">-- Length of the resource data area.</span>
<span class="c1">-- </span>
<span class="c1">-- Length of the resource map.</span>
<span class="c1">-- </span>
<span class="c1">-- In practice,</span>
<span class="c1">-- this should always be `_root._io.size - ofs_resource_map`,</span>
<span class="c1">-- i. e. the resource map should extend to the end of the resource file.</span>

<span class="c1">-- </span>
<span class="c1">-- A resource data block,</span>
<span class="c1">-- as stored in the resource data area.</span>
<span class="c1">-- </span>
<span class="c1">-- Each data block stores the data contained in a resource,</span>
<span class="c1">-- along with its length.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">DataBlock</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">DataBlock</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">DataBlock</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">len_data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u4be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">len_data</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The length of the resource data stored in this block.</span>
<span class="c1">-- </span>
<span class="c1">-- The data stored in this block.</span>

<span class="c1">-- </span>
<span class="c1">-- Resource map,</span>
<span class="c1">-- containing information about the resources in the file and where they are located in the data area.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">reserved_file_header_copy</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">FileHeader</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">reserved_next_resource_map_handle</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u4be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">reserved_file_reference_number</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u2be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_raw_file_attributes</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">_io</span> <span class="o">=</span> <span class="n">KaitaiStream</span><span class="p">(</span><span class="n">stringstream</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw_file_attributes</span><span class="p">))</span>
  <span class="n">self</span><span class="p">.</span><span class="n">file_attributes</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">FileAttributes</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">ofs_type_list</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u2be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">ofs_names</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u2be</span><span class="p">()</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The resource map&#39;s resource type list, followed by the resource reference list area.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">type_list_and_reference_lists</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">type_list_and_reference_lists</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_type_list_and_reference_lists</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_type_list_and_reference_lists</span>
  <span class="kr">end</span>

  <span class="kd">local</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">pos</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ofs_type_list</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_raw__m_type_list_and_reference_lists</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes</span><span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">ofs_names</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">ofs_type_list</span><span class="p">))</span>
  <span class="kd">local</span> <span class="n">_io</span> <span class="o">=</span> <span class="n">KaitaiStream</span><span class="p">(</span><span class="n">stringstream</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw__m_type_list_and_reference_lists</span><span class="p">))</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_m_type_list_and_reference_lists</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_type_list_and_reference_lists</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- Use `names` instead,</span>
<span class="c1">-- unless you need access to this instance&#39;s `_io`.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">names_with_io</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">names_with_io</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_names_with_io</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_names_with_io</span>
  <span class="kr">end</span>

  <span class="kd">local</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">pos</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ofs_names</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_raw__m_names_with_io</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes_full</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">_io</span> <span class="o">=</span> <span class="n">KaitaiStream</span><span class="p">(</span><span class="n">stringstream</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw__m_names_with_io</span><span class="p">))</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_m_names_with_io</span> <span class="o">=</span> <span class="n">BytesWithIo</span><span class="p">(</span><span class="n">_io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_names_with_io</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- Storage area for the names of all resources.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">names</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_names</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_names</span>
  <span class="kr">end</span>

  <span class="n">self</span><span class="p">.</span><span class="n">_m_names</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">names_with_io</span><span class="p">.</span><span class="n">data</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_names</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- Reserved space for a copy of the resource file header.</span>
<span class="c1">-- </span>
<span class="c1">-- Reserved space for a handle to the next loaded resource map in memory.</span>
<span class="c1">-- </span>
<span class="c1">-- Reserved space for the resource file&#39;s file reference number.</span>
<span class="c1">-- </span>
<span class="c1">-- The resource file&#39;s attributes.</span>
<span class="c1">-- </span>
<span class="c1">-- Offset of the resource type list,</span>
<span class="c1">-- from the start of the resource map.</span>
<span class="c1">-- </span>
<span class="c1">-- In practice,</span>
<span class="c1">-- this should always be `sizeof&lt;resource_map&gt;`,</span>
<span class="c1">-- i. e. the resource type list should directly follow the resource map.</span>
<span class="c1">-- </span>
<span class="c1">-- Offset of the resource name area,</span>
<span class="c1">-- from the start of the resource map.</span>

<span class="c1">-- </span>
<span class="c1">-- A resource file&#39;s attributes,</span>
<span class="c1">-- as stored in the resource map.</span>
<span class="c1">-- </span>
<span class="c1">-- These attributes are sometimes also referred to as resource map attributes,</span>
<span class="c1">-- because of where they are stored in the file.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">FileAttributes</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">FileAttributes</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">FileAttributes</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">resources_locked</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">reserved0</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">printer_driver_multifinder_compatible</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">no_write_changes</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">needs_compact</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">map_needs_write</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">reserved1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The attributes as a packed integer,</span>
<span class="c1">-- as they are stored in the file.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">FileAttributes</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">as_int</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">FileAttributes</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">as_int</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_as_int</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_as_int</span>
  <span class="kr">end</span>

  <span class="kd">local</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">pos</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_m_as_int</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u2be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_as_int</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- TODO What does this attribute actually do,</span>
<span class="c1">-- and how is it different from `read_only`?</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute is undocumented and not defined in &lt;CarbonCore/Resources.h&gt;,</span>
<span class="c1">-- but ResEdit has a checkbox called &quot;Resources Locked&quot; for this attribute.</span>
<span class="c1">-- </span>
<span class="c1">-- These attributes have no known usage or meaning and should always be zero.</span>
<span class="c1">-- </span>
<span class="c1">-- Indicates that this printer driver is compatible with MultiFinder,</span>
<span class="c1">-- i. e. can be used simultaneously by multiple applications.</span>
<span class="c1">-- This attribute is only meant to be set on printer driver resource forks.</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute is not documented in Inside Macintosh and is not defined in &lt;CarbonCore/Resources.h&gt;.</span>
<span class="c1">-- It is documented in technote PR510,</span>
<span class="c1">-- and ResEdit has a checkbox called &quot;Printer Driver MultiFinder Compatible&quot; for this attribute.</span>
<span class="c1">-- See also: Apple Technical Note PR510 - Printer Driver Q&amp;As, section &#39;&quot;Printer driver is MultiFinder compatible&quot; bit&#39; (https://developer.apple.com/library/archive/technotes/pr/pr_510.html)</span>
<span class="c1">-- </span>
<span class="c1">-- Indicates that the Resource Manager should not write any changes from memory into the resource file.</span>
<span class="c1">-- Any modification operations requested by the application will return successfully,</span>
<span class="c1">-- but will not actually update the resource file.</span>
<span class="c1">-- </span>
<span class="c1">-- TODO Is this attribute supposed to be set on disk or only in memory?</span>
<span class="c1">-- </span>
<span class="c1">-- Indicates that the resource file should be compacted the next time it is written by the Resource Manager.</span>
<span class="c1">-- This attribute is only meant to be set in memory;</span>
<span class="c1">-- it is cleared when the resource file is written to disk.</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute is mainly used internally by the Resource Manager,</span>
<span class="c1">-- but may also be set manually by the application.</span>
<span class="c1">-- </span>
<span class="c1">-- Indicates that the resource map has been changed in memory and should be written to the resource file on the next update.</span>
<span class="c1">-- This attribute is only meant to be set in memory;</span>
<span class="c1">-- it is cleared when the resource file is written to disk.</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute is mainly used internally by the Resource Manager,</span>
<span class="c1">-- but may also be set manually by the application.</span>
<span class="c1">-- </span>
<span class="c1">-- These attributes have no known usage or meaning and should always be zero.</span>

<span class="c1">-- </span>
<span class="c1">-- Resource type list and storage area for resource reference lists in the resource map.</span>
<span class="c1">-- </span>
<span class="c1">-- The two parts are combined into a single type here for technical reasons:</span>
<span class="c1">-- the start of the resource reference list area is not stored explicitly in the file,</span>
<span class="c1">-- instead it always starts directly after the resource type list.</span>
<span class="c1">-- The simplest way to implement this is by placing both types into a single `seq`.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">type_list</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">TypeList</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">reference_lists</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes_full</span><span class="p">()</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The resource map&#39;s resource type list.</span>
<span class="c1">-- </span>
<span class="c1">-- Storage area for the resource map&#39;s resource reference lists.</span>
<span class="c1">-- </span>
<span class="c1">-- According to Inside Macintosh,</span>
<span class="c1">-- the reference lists are stored contiguously,</span>
<span class="c1">-- in the same order as their corresponding resource type list entries.</span>

<span class="c1">-- </span>
<span class="c1">-- Resource type list in the resource map.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">TypeList</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">TypeList</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">TypeList</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">num_types_m1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u2be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_types</span> <span class="o">-</span> <span class="mi">1</span> <span class="kr">do</span>
    <span class="n">self</span><span class="p">.</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">TypeList</span><span class="p">.</span><span class="n">TypeListEntry</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
  <span class="kr">end</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The number of resource types in this list.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">TypeList</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">num_types</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">TypeList</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">num_types</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_num_types</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_num_types</span>
  <span class="kr">end</span>

  <span class="n">self</span><span class="p">.</span><span class="n">_m_num_types</span> <span class="o">=</span> <span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">num_types_m1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">65536</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_num_types</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The number of resource types in this list,</span>
<span class="c1">-- minus one.</span>
<span class="c1">-- </span>
<span class="c1">-- If the resource list is empty,</span>
<span class="c1">-- the value of this field is `0xffff`,</span>
<span class="c1">-- i. e. `-1` truncated to a 16-bit unsigned integer.</span>
<span class="c1">-- </span>
<span class="c1">-- Entries in the resource type list.</span>

<span class="c1">-- </span>
<span class="c1">-- A single entry in the resource type list.</span>
<span class="c1">-- </span>
<span class="c1">-- Each entry corresponds to exactly one resource reference list.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">TypeList</span><span class="p">.</span><span class="n">TypeListEntry</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">TypeList</span><span class="p">.</span><span class="nc">TypeListEntry</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">TypeList</span><span class="p">.</span><span class="nc">TypeListEntry</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">num_references_m1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u2be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">ofs_reference_list</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u2be</span><span class="p">()</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The number of resources in the reference list for this type.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">TypeList</span><span class="p">.</span><span class="n">TypeListEntry</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">num_references</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">TypeList</span><span class="p">.</span><span class="nc">TypeListEntry</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">num_references</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_num_references</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_num_references</span>
  <span class="kr">end</span>

  <span class="n">self</span><span class="p">.</span><span class="n">_m_num_references</span> <span class="o">=</span> <span class="p">((</span><span class="n">self</span><span class="p">.</span><span class="n">num_references_m1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">65536</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_num_references</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The resource reference list for this resource type.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">TypeList</span><span class="p">.</span><span class="n">TypeListEntry</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">reference_list</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">TypeList</span><span class="p">.</span><span class="nc">TypeListEntry</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">reference_list</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_reference_list</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_reference_list</span>
  <span class="kr">end</span>

  <span class="kd">local</span> <span class="n">_io</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_parent</span><span class="p">.</span><span class="n">_parent</span><span class="p">.</span><span class="n">_io</span>
  <span class="kd">local</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">_io</span><span class="p">:</span><span class="n">pos</span><span class="p">()</span>
  <span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ofs_reference_list</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_m_reference_list</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">ReferenceList</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_references</span><span class="p">,</span> <span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
  <span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_reference_list</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The four-character type code of the resources in the reference list.</span>
<span class="c1">-- </span>
<span class="c1">-- The number of resources in the reference list for this type,</span>
<span class="c1">-- minus one.</span>
<span class="c1">-- </span>
<span class="c1">-- Empty reference lists should never exist.</span>
<span class="c1">-- </span>
<span class="c1">-- Offset of the resource reference list for this resource type,</span>
<span class="c1">-- from the start of the resource type list.</span>
<span class="c1">-- </span>
<span class="c1">-- Although the offset is relative to the start of the type list,</span>
<span class="c1">-- it should never point into the type list itself,</span>
<span class="c1">-- but into the reference list storage area that directly follows it.</span>
<span class="c1">-- That is,</span>
<span class="c1">-- it should always be at least `_parent._sizeof`.</span>

<span class="c1">-- </span>
<span class="c1">-- A resource reference list,</span>
<span class="c1">-- as stored in the reference list area.</span>
<span class="c1">-- </span>
<span class="c1">-- Each reference list has exactly one matching entry in the resource type list,</span>
<span class="c1">-- and describes all resources of a single type in the file.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">ReferenceList</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">ReferenceList</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">num_references</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">.</span><span class="n">num_references</span> <span class="o">=</span> <span class="n">num_references</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">ReferenceList</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">references</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_references</span> <span class="o">-</span> <span class="mi">1</span> <span class="kr">do</span>
    <span class="n">self</span><span class="p">.</span><span class="n">references</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">ReferenceList</span><span class="p">.</span><span class="n">Reference</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
  <span class="kr">end</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The resource references in this reference list.</span>
<span class="c1">-- </span>
<span class="c1">-- The number of references in this resource reference list.</span>
<span class="c1">-- </span>
<span class="c1">-- This information needs to be passed in as a parameter,</span>
<span class="c1">-- because it is stored in the reference list&#39;s type list entry,</span>
<span class="c1">-- and not in the reference list itself.</span>

<span class="c1">-- </span>
<span class="c1">-- A single resource reference in a resource reference list.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">ReferenceList</span><span class="p">.</span><span class="n">Reference</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">ReferenceList</span><span class="p">.</span><span class="nc">Reference</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">ReferenceList</span><span class="p">.</span><span class="nc">Reference</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_s2be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">ofs_name</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u2be</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_raw_attributes</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">_io</span> <span class="o">=</span> <span class="n">KaitaiStream</span><span class="p">(</span><span class="n">stringstream</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_raw_attributes</span><span class="p">))</span>
  <span class="n">self</span><span class="p">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">ReferenceList</span><span class="p">.</span><span class="n">Reference</span><span class="p">.</span><span class="n">Attributes</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">ofs_data_block</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">align_to_byte</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">reserved_handle</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u4be</span><span class="p">()</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The name (if any) of the resource described by this reference.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">ReferenceList</span><span class="p">.</span><span class="n">Reference</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">ReferenceList</span><span class="p">.</span><span class="nc">Reference</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">name</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_name</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_name</span>
  <span class="kr">end</span>

  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">ofs_name</span> <span class="o">~=</span> <span class="mi">65535</span> <span class="kr">then</span>
    <span class="kd">local</span> <span class="n">_io</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">.</span><span class="n">resource_map</span><span class="p">.</span><span class="n">names_with_io</span><span class="p">.</span><span class="n">_io</span>
    <span class="kd">local</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">_io</span><span class="p">:</span><span class="n">pos</span><span class="p">()</span>
    <span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ofs_name</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">_m_name</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">Name</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
    <span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>
  <span class="kr">end</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_name</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The data block containing the data for the resource described by this reference.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">ReferenceList</span><span class="p">.</span><span class="n">Reference</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">data_block</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">ReferenceList</span><span class="p">.</span><span class="nc">Reference</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">data_block</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_data_block</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_data_block</span>
  <span class="kr">end</span>

  <span class="kd">local</span> <span class="n">_io</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">.</span><span class="n">data_blocks_with_io</span><span class="p">.</span><span class="n">_io</span>
  <span class="kd">local</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">_io</span><span class="p">:</span><span class="n">pos</span><span class="p">()</span>
  <span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ofs_data_block</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_m_data_block</span> <span class="o">=</span> <span class="n">ResourceFork</span><span class="p">.</span><span class="n">DataBlock</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_root</span><span class="p">)</span>
  <span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_data_block</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- ID of the resource described by this reference.</span>
<span class="c1">-- </span>
<span class="c1">-- Offset of the name for the resource described by this reference,</span>
<span class="c1">-- from the start of the resource name area.</span>
<span class="c1">-- </span>
<span class="c1">-- If the resource has no name,</span>
<span class="c1">-- the value of this field is `0xffff`</span>
<span class="c1">-- i. e. `-1` truncated to a 16-bit unsigned integer.</span>
<span class="c1">-- </span>
<span class="c1">-- Attributes of the resource described by this reference.</span>
<span class="c1">-- </span>
<span class="c1">-- Offset of the data block for the resource described by this reference,</span>
<span class="c1">-- from the start of the resource data area.</span>
<span class="c1">-- </span>
<span class="c1">-- Reserved space for the resource&#39;s handle in memory.</span>

<span class="c1">-- </span>
<span class="c1">-- A resource&#39;s attributes,</span>
<span class="c1">-- as stored in a resource reference.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">ReferenceList</span><span class="p">.</span><span class="n">Reference</span><span class="p">.</span><span class="n">Attributes</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">ReferenceList</span><span class="p">.</span><span class="nc">Reference</span><span class="p">.</span><span class="nc">Attributes</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">ReferenceList</span><span class="p">.</span><span class="nc">Reference</span><span class="p">.</span><span class="nc">Attributes</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">system_reference</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">load_into_system_heap</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">purgeable</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">locked</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">protected</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">preload</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">needs_write</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
  <span class="n">self</span><span class="p">.</span><span class="n">compressed</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The attributes as a packed integer,</span>
<span class="c1">-- as they are stored in the file.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">TypeListAndReferenceLists</span><span class="p">.</span><span class="n">ReferenceList</span><span class="p">.</span><span class="n">Reference</span><span class="p">.</span><span class="n">Attributes</span><span class="p">.</span><span class="n">property</span><span class="p">.</span><span class="n">as_int</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">TypeListAndReferenceLists</span><span class="p">.</span><span class="nc">ReferenceList</span><span class="p">.</span><span class="nc">Reference</span><span class="p">.</span><span class="nc">Attributes</span><span class="p">.</span><span class="nc">property</span><span class="p">.</span><span class="nc">as_int</span><span class="p">:</span><span class="nf">get</span><span class="p">()</span>
  <span class="kr">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_as_int</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="kr">then</span>
    <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_as_int</span>
  <span class="kr">end</span>

  <span class="kd">local</span> <span class="n">_pos</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">pos</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_m_as_int</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u1</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="n">_pos</span><span class="p">)</span>
  <span class="kr">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_m_as_int</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- Indicates that this resource reference is a system reference rather than a regular local reference.</span>
<span class="c1">-- This attribute is nearly undocumented.</span>
<span class="c1">-- For all practical purposes,</span>
<span class="c1">-- it should be considered reserved and should always be zero.</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute was last documented in the Promotional Edition of Inside Macintosh,</span>
<span class="c1">-- in the Resource Manager chapter,</span>
<span class="c1">-- on pages 37-41,</span>
<span class="c1">-- in a &quot;System References&quot; section that calls itself &quot;of historical interest only&quot;.</span>
<span class="c1">-- The final versions of Inside Macintosh only mention this attribute as &quot;reserved for use by the Resource Manager&quot;.</span>
<span class="c1">-- &lt;CarbonCore/Resources.h&gt; contains a `resSysRefBit` constant,</span>
<span class="c1">-- but no corresponding `resSysRef` constant like for all other resource attributes.</span>
<span class="c1">-- </span>
<span class="c1">-- According to the Inside Macintosh Promotional Edition,</span>
<span class="c1">-- a system reference was effectively an alias pointing to a resource stored in the system file,</span>
<span class="c1">-- possibly with a different ID and name (but not type) than the system reference.</span>
<span class="c1">-- If this attribute is set,</span>
<span class="c1">-- `ofs_data_block` is ignored and should be zero,</span>
<span class="c1">-- and `reserved_handle` contains</span>
<span class="c1">-- (in its high and low two bytes, respectively)</span>
<span class="c1">-- the ID and name offset of the real system resource that this system reference points to.</span>
<span class="c1">-- </span>
<span class="c1">-- TODO Do any publicly available Mac OS versions support system references,</span>
<span class="c1">-- and do any real files/applications use them?</span>
<span class="c1">-- So far the answer seems to be no,</span>
<span class="c1">-- but I would like to be proven wrong!</span>
<span class="c1">-- </span>
<span class="c1">-- Indicates that this resource should be loaded into the system heap if possible,</span>
<span class="c1">-- rather than the application heap.</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute is only meant to be used by Mac OS itself,</span>
<span class="c1">-- for System and Finder resources,</span>
<span class="c1">-- and not by normal applications.</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute may be set both in memory and on disk,</span>
<span class="c1">-- but it only has any meaning while the resource file is loaded into memory.</span>
<span class="c1">-- </span>
<span class="c1">-- Indicates that this resource&#39;s data should be purgeable by the Mac OS Memory Manager.</span>
<span class="c1">-- This allows the resource data to be purged from memory if space is needed on the heap.</span>
<span class="c1">-- Purged resources can later be reloaded from disk if their data is needed again.</span>
<span class="c1">-- </span>
<span class="c1">-- If the `locked` attribute is set,</span>
<span class="c1">-- this attribute has no effect</span>
<span class="c1">-- (i. e. locked resources are never purgeable).</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute may be set both in memory and on disk,</span>
<span class="c1">-- but it only has any meaning while the resource file is loaded into memory.</span>
<span class="c1">-- </span>
<span class="c1">-- Indicates that this resource&#39;s data should be locked to the Mac OS Memory Manager.</span>
<span class="c1">-- This prevents the resource data from being moved when the heap is compacted.</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute may be set both in memory and on disk,</span>
<span class="c1">-- but it only has any meaning while the resource file is loaded into memory.</span>
<span class="c1">-- </span>
<span class="c1">-- Indicates that this resource should be protected (i. e. unmodifiable) in memory.</span>
<span class="c1">-- This prevents the application from using the Resource Manager to change the resource&#39;s data or metadata,</span>
<span class="c1">-- or delete it.</span>
<span class="c1">-- The only exception are the resource&#39;s attributes,</span>
<span class="c1">-- which can always be changed,</span>
<span class="c1">-- even for protected resources.</span>
<span class="c1">-- This allows protected resources to be unprotected again by the application.</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute may be set both in memory and on disk,</span>
<span class="c1">-- but it only has any meaning while the resource file is loaded into memory.</span>
<span class="c1">-- </span>
<span class="c1">-- Indicates that this resource&#39;s data should be immediately loaded into memory when the resource file is opened.</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute may be set both in memory and on disk,</span>
<span class="c1">-- but it only has any meaning when the resource file is first opened.</span>
<span class="c1">-- </span>
<span class="c1">-- Indicates that this resource&#39;s data has been changed in memory and should be written to the resource file on the next update.</span>
<span class="c1">-- This attribute is only meant to be set in memory;</span>
<span class="c1">-- it is cleared when the resource file is written to disk.</span>
<span class="c1">-- </span>
<span class="c1">-- This attribute is used internally by the Resource Manager and should not be set manually by the application.</span>
<span class="c1">-- </span>
<span class="c1">-- Indicates that this resource&#39;s data is compressed.</span>
<span class="c1">-- Compressed resource data is decompressed transparently by the Resource Manager when reading.</span>
<span class="c1">-- </span>
<span class="c1">-- For a detailed description of the structure of compressed resources as they are stored in the file,</span>
<span class="c1">-- see the compressed_resource.ksy spec.</span>

<span class="c1">-- </span>
<span class="c1">-- A resource name,</span>
<span class="c1">-- as stored in the resource name storage area in the resource map.</span>
<span class="c1">-- </span>
<span class="c1">-- The resource names are not required to appear in any particular order.</span>
<span class="c1">-- There may be unused space between and around resource names,</span>
<span class="c1">-- but in practice they are often contiguous.</span>
<span class="n">ResourceFork</span><span class="p">.</span><span class="n">ResourceMap</span><span class="p">.</span><span class="n">Name</span> <span class="o">=</span> <span class="n">class</span><span class="p">.</span><span class="n">class</span><span class="p">(</span><span class="n">KaitaiStruct</span><span class="p">)</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">Name</span><span class="p">:</span><span class="nf">_init</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
  <span class="n">KaitaiStruct</span><span class="p">.</span><span class="n">_init</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">io</span><span class="p">)</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="n">parent</span>
  <span class="n">self</span><span class="p">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">self</span>
  <span class="n">self</span><span class="p">:</span><span class="n">_read</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nc">ResourceFork</span><span class="p">.</span><span class="nc">ResourceMap</span><span class="p">.</span><span class="nc">Name</span><span class="p">:</span><span class="nf">_read</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">len_value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_u1</span><span class="p">()</span>
  <span class="n">self</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_io</span><span class="p">:</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">len_value</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- </span>
<span class="c1">-- The length of the resource name, in bytes.</span>
<span class="c1">-- </span>
<span class="c1">-- The resource name.</span>
<span class="c1">-- </span>
<span class="c1">-- This field is exposed as a byte array,</span>
<span class="c1">-- because there is no universal encoding for resource names.</span>
<span class="c1">-- Most Classic Mac software does not deal with encodings explicitly and instead assumes that all strings,</span>
<span class="c1">-- including resource names,</span>
<span class="c1">-- use the system encoding,</span>
<span class="c1">-- which varies depending on the system language.</span>
<span class="c1">-- This means that resource names can use different encodings depending on what system language they were created with.</span>
<span class="c1">-- </span>
<span class="c1">-- Many resource names are plain ASCII,</span>
<span class="c1">-- meaning that the encoding often does not matter</span>
<span class="c1">-- (because all Mac OS encodings are ASCII-compatible).</span>
<span class="c1">-- For non-ASCII resource names,</span>
<span class="c1">-- the most common encoding is perhaps MacRoman</span>
<span class="c1">-- (used for English and other Western languages),</span>
<span class="c1">-- but other encodings are also sometimes used,</span>
<span class="c1">-- especially for software in non-Western languages.</span>
<span class="c1">-- </span>
<span class="c1">-- There is no requirement that all names in a single resource file use the same encoding.</span>
<span class="c1">-- For example,</span>
<span class="c1">-- localized software may have some (but not all) of its resource names translated.</span>
<span class="c1">-- For non-Western languages,</span>
<span class="c1">-- this can lead to some resource names using MacRoman,</span>
<span class="c1">-- and others using a different encoding.</span>
</pre></div>

        </div>
        
    </div>
</section>

    <footer id="main-footer">
        <div class="container">
            &copy; 2015&ndash;2024 Kaitai Project and <a href="https://github.com/kaitai-io/kaitai_struct_formats/graphs/contributors">format repo contributors</a>

            <h3>Contacts</h3>

            <div class="row">
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-github"></i> <a href="https://github.com/kaitai-io/kaitai_struct">GitHub</a>
                </div>
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-twitter"></i> <a href="https://twitter.com/kaitai_io">@kaitai_io</a>
                </div>
                <div class="col-sm-4">
                    Gitter: <a href="https://gitter.im/kaitai_struct/Lobby">kaitai_struct</a>
                </div>
            </div>
        </div>
    </footer>

  <script src="//kaitai.io/js/jquery-1.12.3.min.js"></script>
  <script src="//kaitai.io/js/bootstrap.min.js"></script>

  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-76299550-1', 'auto');
      ga('send', 'pageview');
  </script>
</body>
</html>
