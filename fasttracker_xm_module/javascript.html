<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Extended Module: JavaScript parsing library</title>
  <meta name="keywords" content="kaitai,struct,binary,format,parsing,decoding,java,javascript,python,ruby,library,metadata">
  <meta name="description" content="Kaitai Struct is a formal language for binary format specification that can be compiled into parser code">

  <link rel="stylesheet" href="//kaitai.io/styles/bootstrap.min.css">
  <link rel="stylesheet" href="//kaitai.io/styles/bootstrap-theme.min.css">
  <link href='https://fonts.googleapis.com/css?family=Exo:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Share+Tech+Mono' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="//kaitai.io/styles/main.css" type="text/css">

  <link rel="stylesheet" href="//kaitai.io/styles/highlight/default.css">
  <style>
.diagram-img {
    display: block;
    max-width: 100%;
    height: auto;
    margin: 0 auto;
}

section.format {
    padding: 30px 0;
}

section#format-meta, section#format-index-header {
    background: #e3eef7;
}

section#format-diagram, section#format-index-footer {
    background: #e9f8dd;
}

section#format-ksy, section#format-lang {
    background: #d1eadd;
}

section#format-index .row {
    padding-bottom: 10px;
}

  </style>
  <script src="//kaitai.io/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>
<body data-spy="scroll" data-target="#main-navbar" data-offset="100">

    <nav class="navbar navbar-inverse navbar-fixed-top" id="main-navbar">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-navbar-collapse" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <span class="navbar-brand">Kaitai Struct</span>
            </div>
            <div class="collapse navbar-collapse" id="main-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="http://kaitai.io/#what-is-it">What is it?</a></li>
                    <li><a href="http://kaitai.io/#quick-start">Quick Start</a></li>
                    <li><a href="http://kaitai.io/#download">Download</a></li>
                    <li class="active"><a href="http://formats.kaitai.io/">Format Gallery</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://kaitai.io/repl/index.html">Try it</a></li>
                    <li><a href="https://ide.kaitai.io/">Web IDE</a></li>
                    <li><a href="http://doc.kaitai.io/">Documentation</a></li>
                </ul>
            </div>
        </div>
    </nav>
<nav>
    <div class="container">
    <ol class="breadcrumb">
        <li><a href="../index.html">Format Gallery</a></li>
        <li>Multimedia Files</li>
        <li class="active">Extended Module</li>
    </ol>
    </div>
</nav>

<section id="format-meta" class="format">
    <div class="container">
        <h1>Extended Module:
            
            JavaScript parsing library
            
        </h1>

        <div class="row">
            <div class="col-md-8">
                <p><p>XM (standing for eXtended Module) is a popular module music file
format, that was introduced in 1994 in FastTracker2 by Triton demo
group. Akin to MOD files, it bundles both digital samples
(instruments) and instructions on which note to play at what time
(patterns), which provides good audio quality with relatively small
file size. Audio is reproducible without relying on the sound of
particular hardware samplers or synths.</p>
</p>
            </div>
            <div class="col-md-4">
                <div class="panel panel-info">
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">Application</h3>
                    </div>
                    <div class="panel-body">
                        ["FastTracker 2", "Protracker", "MilkyTracker", "libmodplug", "Mikmod"]
                    </div>
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">File extension</h3>
                    </div>
                    <div class="panel-body">
                        xm
                    </div>
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">KS implementation details</h3>
                    </div>
                    
                    <div class="panel-body">
                        License: <a href="https://spdx.org/licenses/Unlicense.html">Unlicense</a>
                    </div>
                    
                    
                    
                    
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
            <p>
            This page hosts a formal specification of Extended Module
            using <a href="http://kaitai.io">Kaitai Struct</a>. This
            specification can be automatically translated into a
            variety of programming languages to get a parsing library.
            </p>

            <ul class="nav nav-pills">
                
                
                <li>
                
                <a href="index.html" title="Extended Module parsing Overview library">Overview</a></li>
                
                
                <li>
                
                <a href="cpp_stl.html" title="Extended Module parsing C++/STL library">C++/STL</a></li>
                
                
                <li>
                
                <a href="csharp.html" title="Extended Module parsing C# library">C#</a></li>
                
                
                <li>
                
                <a href="graphviz.html" title="Extended Module parsing GraphViz library">GraphViz</a></li>
                
                
                <li>
                
                <a href="java.html" title="Extended Module parsing Java library">Java</a></li>
                
                
                <li class="active">
                
                <a href="javascript.html" title="Extended Module parsing JavaScript library">JavaScript</a></li>
                
                
                <li>
                
                <a href="lua.html" title="Extended Module parsing Lua library">Lua</a></li>
                
                
                <li>
                
                <a href="perl.html" title="Extended Module parsing Perl library">Perl</a></li>
                
                
                <li>
                
                <a href="php.html" title="Extended Module parsing PHP library">PHP</a></li>
                
                
                <li>
                
                <a href="python.html" title="Extended Module parsing Python library">Python</a></li>
                
                
                <li>
                
                <a href="ruby.html" title="Extended Module parsing Ruby library">Ruby</a></li>
                
            </ul>
            </div>
        </div>
    </div>
</section>

<section id="format-usage" class="format">
    <div class="container">
        <h2>Usage</h2>

        
<p>See the usage examples in the <a href="http://doc.kaitai.io/lang_javascript.html" target="_blank">JavaScript notes</a>.</p>

<p>Parse structure from an ArrayBuffer:</p>

<pre><code class="javascript">var arrayBuffer = ...;
var data = new FasttrackerXmModule(new KaitaiStream(arrayBuffer));</code></pre>

<p>After that, one can get various attributes from the structure by accessing fields or properties like:</p>

<pre><code class="javascript">data.preheader // => get preheader</code></pre>

    </div>
</section>


<section id="format-lang" class="format">
    <div class="container">
        <h2>
            
            JavaScript source code to parse Extended Module
            
        </h2>

        

        <h3>FasttrackerXmModule.js</h3>

        <div class="row">
            <div class="pull-right">
                <p>
                    <a href="src/javascript/FasttrackerXmModule.js" class="btn btn-success">Download <i class="fa fa-download"></i></a>
                </p>
            </div>
        </div>

        <div class="row">
            <pre><code class="javascript">// This is a generated file! Please edit source .ksy file and use kaitai-struct-compiler to rebuild

(function (root, factory) {
  if (typeof define === &#39;function&#39; &amp;&amp; define.amd) {
    define([&#39;kaitai-struct/KaitaiStream&#39;], factory);
  } else if (typeof module === &#39;object&#39; &amp;&amp; module.exports) {
    module.exports = factory(require(&#39;kaitai-struct/KaitaiStream&#39;));
  } else {
    root.FasttrackerXmModule = factory(root.KaitaiStream);
  }
}(this, function (KaitaiStream) {
/**
 * XM (standing for eXtended Module) is a popular module music file
 * format, that was introduced in 1994 in FastTracker2 by Triton demo
 * group. Akin to MOD files, it bundles both digital samples
 * (instruments) and instructions on which note to play at what time
 * (patterns), which provides good audio quality with relatively small
 * file size. Audio is reproducible without relying on the sound of
 * particular hardware samplers or synths.
 * @see {@link http://sid.ethz.ch/debian/milkytracker/milkytracker-0.90.85%2Bdfsg/resources/reference/xm-form.txt
 * ftp://ftp.modland.com/pub/documents/format_documentation/FastTracker%202%20v2.04%20(.xm).html
 * |Source}
 */

var FasttrackerXmModule = (function() {
  function FasttrackerXmModule(_io, _parent, _root) {
    this._io = _io;
    this._parent = _parent;
    this._root = _root || this;

    this._read();
  }
  FasttrackerXmModule.prototype._read = function() {
    this.preheader = new Preheader(this._io, this, this._root);
    this._raw_header = this._io.readBytes((this.preheader.headerSize - 4));
    var _io__raw_header = new KaitaiStream(this._raw_header);
    this.header = new Header(_io__raw_header, this, this._root);
    this.patterns = new Array(this.header.numPatterns);
    for (var i = 0; i &lt; this.header.numPatterns; i++) {
      this.patterns[i] = new Pattern(this._io, this, this._root);
    }
    this.instruments = new Array(this.header.numInstruments);
    for (var i = 0; i &lt; this.header.numInstruments; i++) {
      this.instruments[i] = new Instrument(this._io, this, this._root);
    }
  }

  var Preheader = FasttrackerXmModule.Preheader = (function() {
    function Preheader(_io, _parent, _root) {
      this._io = _io;
      this._parent = _parent;
      this._root = _root || this;

      this._read();
    }
    Preheader.prototype._read = function() {
      this.signature0 = this._io.ensureFixedContents([69, 120, 116, 101, 110, 100, 101, 100, 32, 77, 111, 100, 117, 108, 101, 58, 32]);
      this.moduleName = KaitaiStream.bytesToStr(KaitaiStream.bytesTerminate(this._io.readBytes(20), 0, false), &quot;utf-8&quot;);
      this.signature1 = this._io.ensureFixedContents([26]);
      this.trackerName = KaitaiStream.bytesToStr(KaitaiStream.bytesTerminate(this._io.readBytes(20), 0, false), &quot;utf-8&quot;);
      this.versionNumber = new Version(this._io, this, this._root);
      this.headerSize = this._io.readU4le();
    }

    var Version = Preheader.Version = (function() {
      function Version(_io, _parent, _root) {
        this._io = _io;
        this._parent = _parent;
        this._root = _root || this;

        this._read();
      }
      Version.prototype._read = function() {
        this.minor = this._io.readU1();
        this.major = this._io.readU1();
      }
      Object.defineProperty(Version.prototype, &#39;value&#39;, {
        get: function() {
          if (this._m_value !== undefined)
            return this._m_value;
          this._m_value = ((this.major &lt;&lt; 8) | this.minor);
          return this._m_value;
        }
      });

      /**
       * currently 0x04
       */

      /**
       * currently 0x01
       */

      return Version;
    })();

    /**
     * Module name, padded with zeroes
     */

    /**
     * Tracker name
     */

    /**
     * Format versions below [0x01, 0x04] have a LOT of differences. Check this field!
     */

    /**
     * Header size &lt;&lt; Calculated FROM THIS OFFSET, not from the beginning of the file! &gt;&gt;
     */

    return Preheader;
  })();

  var Pattern = FasttrackerXmModule.Pattern = (function() {
    function Pattern(_io, _parent, _root) {
      this._io = _io;
      this._parent = _parent;
      this._root = _root || this;

      this._read();
    }
    Pattern.prototype._read = function() {
      this.header = new Header(this._io, this, this._root);
      this.packedData = this._io.readBytes(this.header.main.lenPackedPattern);
    }

    var Header = Pattern.Header = (function() {
      function Header(_io, _parent, _root) {
        this._io = _io;
        this._parent = _parent;
        this._root = _root || this;

        this._read();
      }
      Header.prototype._read = function() {
        this.headerLength = this._io.readU4le();
        this._raw_main = this._io.readBytes((this.headerLength - 4));
        var _io__raw_main = new KaitaiStream(this._raw_main);
        this.main = new HeaderMain(_io__raw_main, this, this._root);
      }

      var HeaderMain = Header.HeaderMain = (function() {
        function HeaderMain(_io, _parent, _root) {
          this._io = _io;
          this._parent = _parent;
          this._root = _root || this;

          this._read();
        }
        HeaderMain.prototype._read = function() {
          this.packingType = this._io.readU1();
          switch (this._root.preheader.versionNumber.value) {
          case 258:
            this.numRowsRaw = this._io.readU1();
            break;
          default:
            this.numRowsRaw = this._io.readU2le();
            break;
          }
          this.lenPackedPattern = this._io.readU2le();
        }
        Object.defineProperty(HeaderMain.prototype, &#39;numRows&#39;, {
          get: function() {
            if (this._m_numRows !== undefined)
              return this._m_numRows;
            this._m_numRows = (this.numRowsRaw + (this._root.preheader.versionNumber.value == 258 ? 1 : 0));
            return this._m_numRows;
          }
        });

        /**
         * Packing type (always 0)
         */

        /**
         * Number of rows in pattern (1..256)
         */

        /**
         * Packed pattern data size
         */

        return HeaderMain;
      })();

      /**
       * Pattern header length
       */

      return Header;
    })();

    return Pattern;
  })();

  var Flags = FasttrackerXmModule.Flags = (function() {
    function Flags(_io, _parent, _root) {
      this._io = _io;
      this._parent = _parent;
      this._root = _root || this;

      this._read();
    }
    Flags.prototype._read = function() {
      this.reserved = this._io.readBitsInt(15);
      this.freqTableType = this._io.readBitsInt(1) != 0;
    }

    /**
     * 0 = Amiga frequency table (see below); 1 = Linear frequency table
     */

    return Flags;
  })();

  var Header = FasttrackerXmModule.Header = (function() {
    function Header(_io, _parent, _root) {
      this._io = _io;
      this._parent = _parent;
      this._root = _root || this;

      this._read();
    }
    Header.prototype._read = function() {
      this.songLength = this._io.readU2le();
      this.restartPosition = this._io.readU2le();
      this.numChannels = this._io.readU2le();
      this.numPatterns = this._io.readU2le();
      this.numInstruments = this._io.readU2le();
      this.flags = new Flags(this._io, this, this._root);
      this.defaultTempo = this._io.readU2le();
      this.defaultBpm = this._io.readU2le();
      this.patternOrderTable = new Array(256);
      for (var i = 0; i &lt; 256; i++) {
        this.patternOrderTable[i] = this._io.readU1();
      }
    }

    /**
     * Song length (in pattern order table)
     */

    /**
     * (2,4,6,8,10,...,32)
     */

    /**
     * (max 256)
     */

    /**
     * (max 128)
     */

    /**
     * max 256
     */

    return Header;
  })();

  var Instrument = FasttrackerXmModule.Instrument = (function() {
    function Instrument(_io, _parent, _root) {
      this._io = _io;
      this._parent = _parent;
      this._root = _root || this;

      this._read();
    }
    Instrument.prototype._read = function() {
      this.headerSize = this._io.readU4le();
      this._raw_header = this._io.readBytes((this.headerSize - 4));
      var _io__raw_header = new KaitaiStream(this._raw_header);
      this.header = new Header(_io__raw_header, this, this._root);
      this.samplesHeaders = new Array(this.header.numSamples);
      for (var i = 0; i &lt; this.header.numSamples; i++) {
        this.samplesHeaders[i] = new SampleHeader(this._io, this, this._root);
      }
      this.samples = new Array(this.header.numSamples);
      for (var i = 0; i &lt; this.header.numSamples; i++) {
        this.samples[i] = new SamplesData(this._io, this, this._root, i);
      }
    }

    var Header = Instrument.Header = (function() {
      function Header(_io, _parent, _root) {
        this._io = _io;
        this._parent = _parent;
        this._root = _root || this;

        this._read();
      }
      Header.prototype._read = function() {
        this.name = KaitaiStream.bytesToStr(KaitaiStream.bytesTerminate(this._io.readBytes(22), 0, false), &quot;utf-8&quot;);
        this.type = this._io.readU1();
        this.numSamples = this._io.readU2le();
        if (this.numSamples &gt; 0) {
          this.extraHeader = new ExtraHeader(this._io, this, this._root);
        }
      }

      /**
       * Usually zero, but this seems pretty random, don&#39;t assume it&#39;s zero
       */

      return Header;
    })();

    var ExtraHeader = Instrument.ExtraHeader = (function() {
      ExtraHeader.Type = Object.freeze({
        TRUE: 0,
        SUSTAIN: 1,
        LOOP: 2,

        0: &quot;TRUE&quot;,
        1: &quot;SUSTAIN&quot;,
        2: &quot;LOOP&quot;,
      });

      function ExtraHeader(_io, _parent, _root) {
        this._io = _io;
        this._parent = _parent;
        this._root = _root || this;

        this._read();
      }
      ExtraHeader.prototype._read = function() {
        this.lenSampleHeader = this._io.readU4le();
        this.sampleNumberForAllNotes = new Array(96);
        for (var i = 0; i &lt; 96; i++) {
          this.sampleNumberForAllNotes[i] = this._io.readU1();
        }
        this.volumePoints = new Array(12);
        for (var i = 0; i &lt; 12; i++) {
          this.volumePoints[i] = new EnvelopePoint(this._io, this, this._root);
        }
        this.panningPoints = new Array(12);
        for (var i = 0; i &lt; 12; i++) {
          this.panningPoints[i] = new EnvelopePoint(this._io, this, this._root);
        }
        this.numVolumePoints = this._io.readU1();
        this.numPanningPoints = this._io.readU1();
        this.volumeSustainPoint = this._io.readU1();
        this.volumeLoopStartPoint = this._io.readU1();
        this.volumeLoopEndPoint = this._io.readU1();
        this.panningSustainPoint = this._io.readU1();
        this.panningLoopStartPoint = this._io.readU1();
        this.panningLoopEndPoint = this._io.readU1();
        this.volumeType = this._io.readU1();
        this.panningType = this._io.readU1();
        this.vibratoType = this._io.readU1();
        this.vibratoSweep = this._io.readU1();
        this.vibratoDepth = this._io.readU1();
        this.vibratoRate = this._io.readU1();
        this.volumeFadeout = this._io.readU2le();
        this.reserved = this._io.readU2le();
      }

      /**
       * Envelope frame-counters work in range 0..FFFFh (0..65535 dec).
       * BUT! FT2 only itself supports only range 0..FFh (0..255 dec).
       * Some other trackers (like SoundTracker for Unix), however, can use the full range 0..FFFF, so it should be supported.
       * !!TIP: This is also a good way to detect if the module has been made with FT2 or not. (In case the tracker name is brain- deadly left unchanged!)
       * Of course it does not help if all instruments have the values inside FT2 supported range.
       * The value-field of the envelope point is ranged between 00..3Fh (0..64 dec).
       */

      var EnvelopePoint = ExtraHeader.EnvelopePoint = (function() {
        function EnvelopePoint(_io, _parent, _root) {
          this._io = _io;
          this._parent = _parent;
          this._root = _root || this;

          this._read();
        }
        EnvelopePoint.prototype._read = function() {
          this.x = this._io.readU2le();
          this.y = this._io.readU2le();
        }

        /**
         * Frame number of the point
         */

        /**
         * Value of the point
         */

        return EnvelopePoint;
      })();

      /**
       * Points for volume envelope. Only `num_volume_points` will be actually used.
       */

      /**
       * Points for panning envelope. Only `num_panning_points` will be actually used.
       */

      return ExtraHeader;
    })();

    /**
     * The saved data uses simple delta-encoding to achieve better compression ratios (when compressed with pkzip, etc.)
     * Pseudocode for converting the delta-coded data to normal data,
     * old = 0;
     * for i in range(data_len):
     *   new = sample[i] + old;
     *   sample[i] = new;
     *   old = new;
     */

    var SamplesData = Instrument.SamplesData = (function() {
      function SamplesData(_io, _parent, _root, index) {
        this._io = _io;
        this._parent = _parent;
        this._root = _root || this;
        this.index = index;

        this._read();
      }
      SamplesData.prototype._read = function() {
        this.samplesData = new Array(this._parent.samplesHeaders[this.index].sampleLength);
        for (var i = 0; i &lt; this._parent.samplesHeaders[this.index].sampleLength; i++) {
          switch (this._parent.samplesHeaders[this.index].type.isSampleData16Bit) {
          case true:
            this.samplesData[i] = this._io.readU2le();
            break;
          case false:
            this.samplesData[i] = this._io.readU1();
            break;
          }
        }
      }

      return SamplesData;
    })();

    var SampleHeader = Instrument.SampleHeader = (function() {
      function SampleHeader(_io, _parent, _root) {
        this._io = _io;
        this._parent = _parent;
        this._root = _root || this;

        this._read();
      }
      SampleHeader.prototype._read = function() {
        this.sampleLength = this._io.readU4le();
        this.sampleLoopStart = this._io.readU4le();
        this.sampleLoopLength = this._io.readU4le();
        this.volume = this._io.readU1();
        this.fineTune = this._io.readS1();
        this.type = new LoopType(this._io, this, this._root);
        this.panning = this._io.readU1();
        this.relativeNoteNumber = this._io.readS1();
        this.reserved = this._io.readU1();
        this.name = KaitaiStream.bytesToStr(KaitaiStream.bytesTerminate(this._io.readBytes(22), 0, false), &quot;utf-8&quot;);
      }

      var LoopType = SampleHeader.LoopType = (function() {
        LoopType.LoopType = Object.freeze({
          NONE: 0,
          FORWARD: 1,
          PING_PONG: 2,

          0: &quot;NONE&quot;,
          1: &quot;FORWARD&quot;,
          2: &quot;PING_PONG&quot;,
        });

        function LoopType(_io, _parent, _root) {
          this._io = _io;
          this._parent = _parent;
          this._root = _root || this;

          this._read();
        }
        LoopType.prototype._read = function() {
          this.reserved0 = this._io.readBitsInt(3);
          this.isSampleData16Bit = this._io.readBitsInt(1) != 0;
          this.reserved1 = this._io.readBitsInt(2);
          this.loopType = this._io.readBitsInt(2);
        }

        return LoopType;
      })();

      /**
       * -16..+15
       */

      /**
       * (0-255)
       */

      return SampleHeader;
    })();

    /**
     * Instrument size &lt;&lt; header that is &gt;&gt;
     * &lt;&lt; &quot;Instrument Size&quot; field tends to be more than the actual size of the structure documented here (it includes also the extended instrument sample header above). So remember to check it and skip the additional bytes before the first sample header &gt;&gt;
     */

    return Instrument;
  })();

  return FasttrackerXmModule;
})();
return FasttrackerXmModule;
}));
</code></pre>
            
        </div>
        
    </div>
</section>

    <footer id="main-footer">
        <div class="container">
            &copy; 2015-2018 Kaitai Project and <a href="https://github.com/kaitai-io/kaitai_struct_formats/graphs/contributors">formats repo contributors</a>

            <h3>Contacts</h3>

            <div class="row">
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-github"></i> <a href="https://github.com/kaitai-io/kaitai_struct">GitHub</a>
                </div>
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-twitter"></i> <a href="https://twitter.com/kaitai_io">@kaitai_io</a>
                </div>
                <div class="col-sm-4">
                    Gitter: <a href="https://gitter.im/kaitai_struct/Lobby">kaitai_struct</a>
                </div>
            </div>
        </div>
    </footer>

  <script src="//kaitai.io/js/jquery-1.12.3.min.js"></script>
  <script src="//kaitai.io/js/bootstrap.min.js"></script>

  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-76299550-1', 'auto');
      ga('send', 'pageview');
  </script>
</body>
</html>
