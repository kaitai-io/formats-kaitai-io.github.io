<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Extended Module: Ruby parsing library</title>
  <meta name="keywords" content="kaitai,struct,binary,format,parsing,decoding,java,javascript,python,ruby,library,metadata">
  <meta name="description" content="Kaitai Struct is a formal language for binary format specification that can be compiled into parser code">

  <link rel="stylesheet" href="//kaitai.io/styles/bootstrap.min.css">
  <link rel="stylesheet" href="//kaitai.io/styles/bootstrap-theme.min.css">
  <link href='https://fonts.googleapis.com/css?family=Exo:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Share+Tech+Mono' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="//kaitai.io/styles/main.css" type="text/css">
  <link rel="stylesheet" href="/pygments-default.css" type="text/css">
  <style>
.diagram-img {
    display: block;
    max-width: 100%;
    height: auto;
    margin: 0 auto;
}

section.format {
    padding: 30px 0;
}

section#format-meta, section#format-index-header {
    background: #e3eef7;
}

section#format-diagram, section#format-index-footer {
    background: #e9f8dd;
}

section#format-ksy, section#format-lang {
    background: #d1eadd;
}

section#format-index .row {
    padding-bottom: 10px;
}

  </style>
</head>
<body data-spy="scroll" data-target="#main-navbar" data-offset="100">

    <nav class="navbar navbar-inverse navbar-fixed-top" id="main-navbar">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-navbar-collapse" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <span class="navbar-brand">Kaitai Struct</span>
            </div>
            <div class="collapse navbar-collapse" id="main-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="//kaitai.io/#what-is-it">What is it?</a></li>
                    <li><a href="//kaitai.io/#quick-start">Quick Start</a></li>
                    <li><a href="//kaitai.io/#download">Download</a></li>
                    <li><a href="//kaitai.io/news/">News</a></li>
                    <li class="active"><a href="//formats.kaitai.io/">Format Gallery</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="https://ide.kaitai.io/">Try it &mdash; Web IDE</a></li>
                    <li><a href="//doc.kaitai.io/">Documentation</a></li>
                </ul>
            </div>
        </div>
    </nav>
<nav>
    <div class="container">
    <ol class="breadcrumb">
        <li><a href="../">Format Gallery</a></li>
        <li>Multimedia Files</li>
        <li class="active">Extended Module</li>
    </ol>
    </div>
</nav>

<section id="format-meta" class="format">
    <div class="container">
        <h1>Extended Module:
            
            Ruby parsing library
            
        </h1>

        <div class="row">
            <div class="col-md-8">
                <p><p>XM (standing for eXtended Module) is a popular module music file
format, that was introduced in 1994 in FastTracker2 by Triton demo
group. Akin to MOD files, it bundles both digital samples
(instruments) and instructions on which note to play at what time
(patterns), which provides good audio quality with relatively small
file size. Audio is reproducible without relying on the sound of
particular hardware samplers or synths.</p>
</p>
            </div>
            <div class="col-md-4">
                <div class="panel panel-info">
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">Application</h3>
                    </div>
                    <div class="panel-body">
                        ["FastTracker 2", "Protracker", "MilkyTracker", "libmodplug", "Mikmod"]
                    </div>
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">File extension</h3>
                    </div>
                    <div class="panel-body">
                        xm
                    </div>
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">KS implementation details</h3>
                    </div>
                    
                    <div class="panel-body">
                        License: <a href="https://spdx.org/licenses/Unlicense.html">Unlicense</a>
                    </div>
                    
                    
                    
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">References</h3>
                    </div>
                    <div class="panel-body">
                        <ul>
                            
                            
                            
                            
                            
                            
                            
                            <li><a href="https://www.nationalarchives.gov.uk/pronom/fmt/323">PRONOM fmt/323</a></li>
                            
                            <li><a href="https://www.wikidata.org/wiki/Q376852">Wikidata Q376852</a></li>
                            
                            
                            
                            <li><a href="http://fileformats.archiveteam.org/wiki/Extended_Module">Extended Module in Just Solve the File Format Problem</a></li>
                            
                        </ul>
                    </div>
                    
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
            <p>
            This page hosts a formal specification of Extended Module
            using <a href="//kaitai.io">Kaitai Struct</a>. This
            specification can be automatically translated into a
            variety of programming languages to get a parsing library.
            </p>

            <ul class="nav nav-pills">
                
                
                <li>
                
                <a href="index.html" title="Extended Module parsing Overview library">Overview</a></li>
                
                
                <li>
                
                <a href="cpp_stl_11.html" title="Extended Module parsing C++11/STL library">C++11/STL</a></li>
                
                
                <li>
                
                <a href="cpp_stl_98.html" title="Extended Module parsing C++98/STL library">C++98/STL</a></li>
                
                
                <li>
                
                <a href="csharp.html" title="Extended Module parsing C# library">C#</a></li>
                
                
                <li>
                
                <a href="go.html" title="Extended Module parsing Go library">Go</a></li>
                
                
                <li>
                
                <a href="graphviz.html" title="Extended Module parsing GraphViz library">GraphViz</a></li>
                
                
                <li>
                
                <a href="java.html" title="Extended Module parsing Java library">Java</a></li>
                
                
                <li>
                
                <a href="java-write.html" title="Extended Module parsing Java (read-write) library">Java (read-write)</a></li>
                
                
                <li>
                
                <a href="javascript.html" title="Extended Module parsing JavaScript library">JavaScript</a></li>
                
                
                <li>
                
                <a href="lua.html" title="Extended Module parsing Lua library">Lua</a></li>
                
                
                <li>
                
                <a href="nim.html" title="Extended Module parsing Nim library">Nim</a></li>
                
                
                <li>
                
                <a href="perl.html" title="Extended Module parsing Perl library">Perl</a></li>
                
                
                <li>
                
                <a href="php.html" title="Extended Module parsing PHP library">PHP</a></li>
                
                
                <li>
                
                <a href="python.html" title="Extended Module parsing Python library">Python</a></li>
                
                
                <li>
                
                <a href="python-write.html" title="Extended Module parsing Python (read-write) library">Python (read-write)</a></li>
                
                
                <li class="active">
                
                <a href="ruby.html" title="Extended Module parsing Ruby library">Ruby</a></li>
                
                
                <li>
                
                <a href="rust.html" title="Extended Module parsing Rust library">Rust</a></li>
                
            </ul>
            </div>
        </div>
    </div>
</section>

<section id="format-usage" class="format">
    <div class="container">
        <h2>Usage</h2>

        <h3>Runtime library</h3>

        <p>All parsing code for Ruby generated by Kaitai Struct depends on the
        <a
            href="https://github.com/kaitai-io/kaitai_struct_ruby_runtime/"
            target="_blank" rel="noopener">
        Ruby runtime library</a>. You have to
        install it before you can parse data.</p>

        <p>The Ruby runtime library can be installed <a href="https://rubygems.org/gems/kaitai-struct"
    target="_blank" rel="noopener">from RubyGems</a>:</p>

<pre><code>gem install kaitai-struct</code></pre>

<h3>Code</h3>

<p>Parse a local file and get structure in memory:</p>



<div class="highlight"><pre><span></span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">FasttrackerXmModule</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="s2">&quot;path/to/local/file.xm&quot;</span><span class="p">)</span>
</pre></div>

<p>Or parse structure from a string of bytes:</p>

<div class="highlight"><pre><span></span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="se">\x00\x01\x02</span><span class="s2">...&quot;</span>
<span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">FasttrackerXmModule</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Stream</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">bytes</span><span class="p">))</span>
</pre></div>

<p>After that, one can get various attributes from the structure by invoking getter methods like:</p>


<div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">preheader</span><span class="w"> </span><span class="c1"># =&gt; get preheader</span>
</pre></div>

    </div>
</section>


<section id="format-lang" class="format">
    <div class="container">
        <h2>
            
            Ruby source code to parse Extended Module
            
        </h2>

        

        <h3>fasttracker_xm_module.rb</h3>

        <div class="row">
            <div class="pull-right">
                <p>
                    <a href="src/ruby/fasttracker_xm_module.rb" download="fasttracker_xm_module.rb" class="btn btn-success">Download <i class="fa fa-download"></i></a>
                </p>
            </div>
        </div>

        <div class="row">
            <div class="highlight"><pre><span></span><span class="c1"># This is a generated file! Please edit source .ksy file and use kaitai-struct-compiler to rebuild</span>

<span class="nb">require</span><span class="w"> </span><span class="s1">&#39;kaitai/struct/struct&#39;</span>

<span class="k">unless</span><span class="w"> </span><span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">VERSION</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="no">Gem</span><span class="o">::</span><span class="no">Version</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;0.11&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="k">raise</span><span class="w"> </span><span class="s2">&quot;Incompatible Kaitai Struct Ruby API: 0.11 or later is required, but you have </span><span class="si">#{</span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">VERSION</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>


<span class="c1">##</span>
<span class="c1"># XM (standing for eXtended Module) is a popular module music file</span>
<span class="c1"># format, that was introduced in 1994 in FastTracker2 by Triton demo</span>
<span class="c1"># group. Akin to MOD files, it bundles both digital samples</span>
<span class="c1"># (instruments) and instructions on which note to play at what time</span>
<span class="c1"># (patterns), which provides good audio quality with relatively small</span>
<span class="c1"># file size. Audio is reproducible without relying on the sound of</span>
<span class="c1"># particular hardware samplers or synths.</span>
<span class="c1"># @see http://sid.ethz.ch/debian/milkytracker/milkytracker-0.90.85%2Bdfsg/resources/reference/xm-form.txt</span>
<span class="c1">#   ftp://ftp.modland.com/pub/documents/format_documentation/FastTracker%202%20v2.04%20(.xm).html</span>
<span class="c1">#    Source</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FasttrackerXmModule</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">self</span><span class="p">)</span>
<span class="w">    </span><span class="n">_read</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">    </span><span class="vi">@preheader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Preheader</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">    </span><span class="n">_io_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">substream</span><span class="p">(</span><span class="n">preheader</span><span class="o">.</span><span class="n">header_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">    </span><span class="vi">@header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Header</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">_io_header</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">    </span><span class="vi">@patterns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<span class="w">    </span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">num_patterns</span><span class="p">)</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="w">      </span><span class="vi">@patterns</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="no">Pattern</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="vi">@instruments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<span class="w">    </span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">num_instruments</span><span class="p">)</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="w">      </span><span class="vi">@instruments</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="no">Instrument</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nb">self</span>
<span class="w">  </span><span class="k">end</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Flags</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">      </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">      </span><span class="n">_read</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">      </span><span class="vi">@reserved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="w">      </span><span class="vi">@freq_table_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="nb">self</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:reserved</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># 0 = Amiga frequency table (see below); 1 = Linear frequency table</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:freq_table_type</span>
<span class="w">  </span><span class="k">end</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Header</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">      </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">      </span><span class="n">_read</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">      </span><span class="vi">@song_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">      </span><span class="vi">@restart_position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">      </span><span class="vi">@num_channels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">      </span><span class="vi">@num_patterns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">      </span><span class="vi">@num_instruments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">      </span><span class="vi">@flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Flags</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">      </span><span class="vi">@default_tempo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">      </span><span class="vi">@default_bpm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">      </span><span class="vi">@pattern_order_table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<span class="w">      </span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="w">        </span><span class="vi">@pattern_order_table</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nb">self</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># Song length (in pattern order table)</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:song_length</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:restart_position</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># (2,4,6,8,10,...,32)</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:num_channels</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># (max 256)</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:num_patterns</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># (max 128)</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:num_instruments</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:flags</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:default_tempo</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:default_bpm</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># max 256</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:pattern_order_table</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">##</span>
<span class="w">  </span><span class="c1"># XM&#39;s notion of &quot;instrument&quot; typically constitutes of a</span>
<span class="w">  </span><span class="c1"># instrument metadata and one or several samples. Metadata</span>
<span class="w">  </span><span class="c1"># includes:</span>
<span class="w">  </span><span class="c1"># </span>
<span class="w">  </span><span class="c1"># * instrument&#39;s name</span>
<span class="w">  </span><span class="c1"># * instruction of which sample to use for which note</span>
<span class="w">  </span><span class="c1"># * volume and panning envelopes and looping instructions</span>
<span class="w">  </span><span class="c1"># * vibrato settings</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Instrument</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">      </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">      </span><span class="n">_read</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">      </span><span class="vi">@header_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u4le</span>
<span class="w">      </span><span class="n">_io_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">substream</span><span class="p">(</span><span class="n">header_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">      </span><span class="vi">@header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Header</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">_io_header</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">      </span><span class="vi">@samples_headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<span class="w">      </span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">num_samples</span><span class="p">)</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="w">        </span><span class="vi">@samples_headers</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="no">SampleHeader</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="vi">@samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<span class="w">      </span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">num_samples</span><span class="p">)</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="w">        </span><span class="vi">@samples</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="no">SamplesData</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">,</span><span class="w"> </span><span class="n">samples_headers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nb">self</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">ExtraHeader</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>

<span class="w">      </span><span class="no">TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">:type_true</span><span class="p">,</span>
<span class="w">        </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">:type_sustain</span><span class="p">,</span>
<span class="w">        </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">:type_loop</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="no">I__TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">TYPE</span><span class="o">.</span><span class="n">invert</span>
<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">        </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">        </span><span class="n">_read</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">        </span><span class="vi">@len_sample_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u4le</span>
<span class="w">        </span><span class="vi">@idx_sample_per_note</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<span class="w">        </span><span class="p">(</span><span class="mi">96</span><span class="p">)</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="w">          </span><span class="vi">@idx_sample_per_note</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="vi">@volume_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<span class="w">        </span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="w">          </span><span class="vi">@volume_points</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="no">EnvelopePoint</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="vi">@panning_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<span class="w">        </span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">|</span><span class="n">i</span><span class="o">|</span>
<span class="w">          </span><span class="vi">@panning_points</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="no">EnvelopePoint</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="vi">@num_volume_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@num_panning_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@volume_sustain_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@volume_loop_start_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@volume_loop_end_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@panning_sustain_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@panning_loop_start_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@panning_loop_end_point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@volume_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Stream</span><span class="o">::</span><span class="n">resolve_enum</span><span class="p">(</span><span class="no">TYPE</span><span class="p">,</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span><span class="p">)</span>
<span class="w">        </span><span class="vi">@panning_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Stream</span><span class="o">::</span><span class="n">resolve_enum</span><span class="p">(</span><span class="no">TYPE</span><span class="p">,</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span><span class="p">)</span>
<span class="w">        </span><span class="vi">@vibrato_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@vibrato_sweep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@vibrato_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@vibrato_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@volume_fadeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">        </span><span class="vi">@reserved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">        </span><span class="nb">self</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="c1">##</span>
<span class="w">      </span><span class="c1"># Envelope frame-counters work in range 0..FFFFh (0..65535 dec).</span>
<span class="w">      </span><span class="c1"># BUT! FT2 only itself supports only range 0..FFh (0..255 dec).</span>
<span class="w">      </span><span class="c1"># Some other trackers (like SoundTracker for Unix), however, can use the full range 0..FFFF, so it should be supported.</span>
<span class="w">      </span><span class="c1"># !!TIP: This is also a good way to detect if the module has been made with FT2 or not. (In case the tracker name is brain- deadly left unchanged!)</span>
<span class="w">      </span><span class="c1"># Of course it does not help if all instruments have the values inside FT2 supported range.</span>
<span class="w">      </span><span class="c1"># The value-field of the envelope point is ranged between 00..3Fh (0..64 dec).</span>
<span class="w">      </span><span class="k">class</span><span class="w"> </span><span class="nc">EnvelopePoint</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">          </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">          </span><span class="n">_read</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">          </span><span class="vi">@x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">          </span><span class="vi">@y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">          </span><span class="nb">self</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">##</span>
<span class="w">        </span><span class="c1"># Frame number of the point</span>
<span class="w">        </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:x</span>

<span class="w">        </span><span class="c1">##</span>
<span class="w">        </span><span class="c1"># Value of the point</span>
<span class="w">        </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:y</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:len_sample_header</span>

<span class="w">      </span><span class="c1">##</span>
<span class="w">      </span><span class="c1"># Index of sample that should be used for any particular</span>
<span class="w">      </span><span class="c1"># note. In the simplest case, where it&#39;s only one sample</span>
<span class="w">      </span><span class="c1"># is available, it&#39;s an array of full of zeroes.</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:idx_sample_per_note</span>

<span class="w">      </span><span class="c1">##</span>
<span class="w">      </span><span class="c1"># Points for volume envelope. Only `num_volume_points` will be actually used.</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:volume_points</span>

<span class="w">      </span><span class="c1">##</span>
<span class="w">      </span><span class="c1"># Points for panning envelope. Only `num_panning_points` will be actually used.</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:panning_points</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:num_volume_points</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:num_panning_points</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:volume_sustain_point</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:volume_loop_start_point</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:volume_loop_end_point</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:panning_sustain_point</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:panning_loop_start_point</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:panning_loop_end_point</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:volume_type</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:panning_type</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:vibrato_type</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:vibrato_sweep</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:vibrato_depth</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:vibrato_rate</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:volume_fadeout</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:reserved</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Header</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">        </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">        </span><span class="n">_read</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">        </span><span class="vi">@name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Stream</span><span class="o">::</span><span class="n">bytes_terminate</span><span class="p">(</span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kp">false</span><span class="p">))</span><span class="o">.</span><span class="n">force_encoding</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="vi">@type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@num_samples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">num_samples</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">          </span><span class="vi">@extra_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">ExtraHeader</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="nb">self</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:name</span>

<span class="w">      </span><span class="c1">##</span>
<span class="w">      </span><span class="c1"># Usually zero, but this seems pretty random, don&#39;t assume it&#39;s zero</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:type</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:num_samples</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:extra_header</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">SampleHeader</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">        </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">        </span><span class="n">_read</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">        </span><span class="vi">@sample_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u4le</span>
<span class="w">        </span><span class="vi">@sample_loop_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u4le</span>
<span class="w">        </span><span class="vi">@sample_loop_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u4le</span>
<span class="w">        </span><span class="vi">@volume</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@fine_tune</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_s1</span>
<span class="w">        </span><span class="vi">@type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">LoopType</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">        </span><span class="vi">@panning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@relative_note_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_s1</span>
<span class="w">        </span><span class="vi">@reserved</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Stream</span><span class="o">::</span><span class="n">bytes_terminate</span><span class="p">(</span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kp">false</span><span class="p">))</span><span class="o">.</span><span class="n">force_encoding</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nb">self</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="k">class</span><span class="w"> </span><span class="nc">LoopType</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>

<span class="w">        </span><span class="no">LOOP_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">:loop_type_none</span><span class="p">,</span>
<span class="w">          </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">:loop_type_forward</span><span class="p">,</span>
<span class="w">          </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="ss">:loop_type_ping_pong</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="no">I__LOOP_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">LOOP_TYPE</span><span class="o">.</span><span class="n">invert</span>
<span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">          </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">          </span><span class="n">_read</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">          </span><span class="vi">@reserved0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">          </span><span class="vi">@is_sample_data_16_bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">          </span><span class="vi">@reserved1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">          </span><span class="vi">@loop_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Stream</span><span class="o">::</span><span class="n">resolve_enum</span><span class="p">(</span><span class="no">LOOP_TYPE</span><span class="p">,</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bits_int_be</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="w">          </span><span class="nb">self</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:reserved0</span>
<span class="w">        </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:is_sample_data_16_bit</span>
<span class="w">        </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:reserved1</span>
<span class="w">        </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:loop_type</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:sample_length</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:sample_loop_start</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:sample_loop_length</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:volume</span>

<span class="w">      </span><span class="c1">##</span>
<span class="w">      </span><span class="c1"># -16..+15</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:fine_tune</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:type</span>

<span class="w">      </span><span class="c1">##</span>
<span class="w">      </span><span class="c1"># (0-255)</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:panning</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:relative_note_number</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:reserved</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:name</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># The saved data uses simple delta-encoding to achieve better compression ratios (when compressed with pkzip, etc.)</span>
<span class="w">    </span><span class="c1"># Pseudocode for converting the delta-coded data to normal data,</span>
<span class="w">    </span><span class="c1"># old = 0;</span>
<span class="w">    </span><span class="c1"># for i in range(data_len):</span>
<span class="w">    </span><span class="c1">#   new = sample[i] + old;</span>
<span class="w">    </span><span class="c1">#   sample[i] = new;</span>
<span class="w">    </span><span class="c1">#   old = new;</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">SamplesData</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="p">)</span>
<span class="w">        </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">        </span><span class="vi">@header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header</span>
<span class="w">        </span><span class="n">_read</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">        </span><span class="vi">@data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">sample_length</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">is_sample_data_16_bit</span><span class="w"> </span><span class="p">?</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">        </span><span class="nb">self</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:data</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:header</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># Instrument size &lt;&lt; header that is &gt;&gt;</span>
<span class="w">    </span><span class="c1"># &lt;&lt; &quot;Instrument Size&quot; field tends to be more than the actual size of the structure documented here (it includes also the extended instrument sample header above). So remember to check it and skip the additional bytes before the first sample header &gt;&gt;</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:header_size</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:header</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:samples_headers</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:samples</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:_raw_header</span>
<span class="w">  </span><span class="k">end</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Pattern</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">      </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">      </span><span class="n">_read</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">      </span><span class="vi">@header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Header</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">      </span><span class="vi">@packed_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">len_packed_pattern</span><span class="p">)</span>
<span class="w">      </span><span class="nb">self</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Header</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">        </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">        </span><span class="n">_read</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">        </span><span class="vi">@header_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u4le</span>
<span class="w">        </span><span class="n">_io_main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">substream</span><span class="p">(</span><span class="n">header_length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">        </span><span class="vi">@main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">HeaderMain</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">_io_main</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">        </span><span class="nb">self</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="k">class</span><span class="w"> </span><span class="nc">HeaderMain</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">          </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">          </span><span class="n">_read</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">          </span><span class="vi">@packing_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="n">_root</span><span class="o">.</span><span class="n">preheader</span><span class="o">.</span><span class="n">version_number</span><span class="o">.</span><span class="n">value</span>
<span class="w">          </span><span class="k">when</span><span class="w"> </span><span class="mi">258</span>
<span class="w">            </span><span class="vi">@num_rows_raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="vi">@num_rows_raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="vi">@len_packed_pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u2le</span>
<span class="w">          </span><span class="nb">self</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">def</span><span class="w"> </span><span class="nf">num_rows</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="vi">@num_rows</span><span class="w"> </span><span class="k">unless</span><span class="w"> </span><span class="vi">@num_rows</span><span class="o">.</span><span class="n">nil?</span>
<span class="w">          </span><span class="vi">@num_rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_rows_raw</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">_root</span><span class="o">.</span><span class="n">preheader</span><span class="o">.</span><span class="n">version_number</span><span class="o">.</span><span class="n">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">258</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">          </span><span class="vi">@num_rows</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">##</span>
<span class="w">        </span><span class="c1"># Packing type (always 0)</span>
<span class="w">        </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:packing_type</span>

<span class="w">        </span><span class="c1">##</span>
<span class="w">        </span><span class="c1"># Number of rows in pattern (1..256)</span>
<span class="w">        </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:num_rows_raw</span>

<span class="w">        </span><span class="c1">##</span>
<span class="w">        </span><span class="c1"># Packed pattern data size</span>
<span class="w">        </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:len_packed_pattern</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="c1">##</span>
<span class="w">      </span><span class="c1"># Pattern header length</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:header_length</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:main</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:_raw_main</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:header</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:packed_data</span>
<span class="w">  </span><span class="k">end</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Preheader</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">      </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">      </span><span class="n">_read</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">      </span><span class="vi">@signature0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
<span class="w">      </span><span class="k">raise</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">ValidationNotEqualError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">69</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">77</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="o">].</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;C*&#39;</span><span class="p">),</span><span class="w"> </span><span class="vi">@signature0</span><span class="p">,</span><span class="w"> </span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/types/preheader/seq/0&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="vi">@signature0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">[</span><span class="mi">69</span><span class="p">,</span><span class="w"> </span><span class="mi">120</span><span class="p">,</span><span class="w"> </span><span class="mi">116</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">110</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">77</span><span class="p">,</span><span class="w"> </span><span class="mi">111</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="mi">108</span><span class="p">,</span><span class="w"> </span><span class="mi">101</span><span class="p">,</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="o">].</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;C*&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="vi">@module_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Stream</span><span class="o">::</span><span class="n">bytes_terminate</span><span class="p">(</span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kp">false</span><span class="p">))</span><span class="o">.</span><span class="n">force_encoding</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="vi">@signature1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="k">raise</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">ValidationNotEqualError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="mi">26</span><span class="o">].</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;C*&#39;</span><span class="p">),</span><span class="w"> </span><span class="vi">@signature1</span><span class="p">,</span><span class="w"> </span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/types/preheader/seq/2&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="vi">@signature1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">[</span><span class="mi">26</span><span class="o">].</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;C*&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="vi">@tracker_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Stream</span><span class="o">::</span><span class="n">bytes_terminate</span><span class="p">(</span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kp">false</span><span class="p">))</span><span class="o">.</span><span class="n">force_encoding</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="vi">@version_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Version</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@_io</span><span class="p">,</span><span class="w"> </span><span class="nb">self</span><span class="p">,</span><span class="w"> </span><span class="vi">@_root</span><span class="p">)</span>
<span class="w">      </span><span class="vi">@header_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u4le</span>
<span class="w">      </span><span class="nb">self</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Version</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Kaitai</span><span class="o">::</span><span class="no">Struct</span><span class="o">::</span><span class="no">Struct</span>
<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kp">nil</span><span class="p">)</span>
<span class="w">        </span><span class="k">super</span><span class="p">(</span><span class="n">_io</span><span class="p">,</span><span class="w"> </span><span class="n">_parent</span><span class="p">,</span><span class="w"> </span><span class="n">_root</span><span class="p">)</span>
<span class="w">        </span><span class="n">_read</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="n">_read</span>
<span class="w">        </span><span class="vi">@minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="vi">@major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vi">@_io</span><span class="o">.</span><span class="n">read_u1</span>
<span class="w">        </span><span class="nb">self</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="k">def</span><span class="w"> </span><span class="nf">value</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="vi">@value</span><span class="w"> </span><span class="k">unless</span><span class="w"> </span><span class="vi">@value</span><span class="o">.</span><span class="n">nil?</span>
<span class="w">        </span><span class="vi">@value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">major</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">minor</span>
<span class="w">        </span><span class="vi">@value</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="c1">##</span>
<span class="w">      </span><span class="c1"># currently 0x04</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:minor</span>

<span class="w">      </span><span class="c1">##</span>
<span class="w">      </span><span class="c1"># currently 0x01</span>
<span class="w">      </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:major</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:signature0</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># Module name, padded with zeroes</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:module_name</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:signature1</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># Tracker name</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:tracker_name</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># Format versions below [0x01, 0x04] have a LOT of differences. Check this field!</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:version_number</span>

<span class="w">    </span><span class="c1">##</span>
<span class="w">    </span><span class="c1"># Header size &lt;&lt; Calculated FROM THIS OFFSET, not from the beginning of the file! &gt;&gt;</span>
<span class="w">    </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:header_size</span>
<span class="w">  </span><span class="k">end</span>
<span class="w">  </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:preheader</span>
<span class="w">  </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:header</span>
<span class="w">  </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:patterns</span>
<span class="w">  </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:instruments</span>
<span class="w">  </span><span class="kp">attr_reader</span><span class="w"> </span><span class="ss">:_raw_header</span>
<span class="k">end</span>
</pre></div>

        </div>
        
    </div>
</section>

    <footer id="main-footer">
        <div class="container">
            &copy; 2015&ndash;2025 Kaitai Project and <a href="https://github.com/kaitai-io/kaitai_struct_formats/graphs/contributors">format repo contributors</a>

            <h3>Contacts</h3>

            <div class="row">
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-github"></i> <a href="https://github.com/kaitai-io/kaitai_struct">GitHub</a>
                </div>
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-twitter"></i> <a href="https://twitter.com/kaitai_io">@kaitai_io</a>
                </div>
                <div class="col-sm-4">
                    Gitter: <a href="https://gitter.im/kaitai_struct/Lobby">kaitai_struct</a>
                </div>
            </div>
        </div>
    </footer>

  <script src="//kaitai.io/js/jquery-1.12.3.min.js"></script>
  <script src="//kaitai.io/js/bootstrap.min.js"></script>
</body>
</html>
