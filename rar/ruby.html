<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>RAR (Roshall ARchiver) archive files: Ruby parsing library</title>
  <meta name="keywords" content="kaitai,struct,binary,format,parsing,decoding,java,javascript,python,ruby,library,metadata">
  <meta name="description" content="Kaitai Struct is a formal language for binary format specification that can be compiled into parser code">

  <link rel="stylesheet" href="http://kaitai.io/styles/bootstrap.min.css">
  <link rel="stylesheet" href="http://kaitai.io/styles/bootstrap-theme.min.css">
  <link href='https://fonts.googleapis.com/css?family=Exo:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Share+Tech+Mono' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="http://kaitai.io/styles/main.css" type="text/css">

  <link rel="stylesheet" href="http://kaitai.io/styles/highlight/default.css">
  <style>
.diagram-img {
    display: block;
    max-width: 100%;
    height: auto;
    margin: 0 auto;
}

section.format {
    padding: 30px 0;
}

section#format-meta, section#format-index-header {
    background: #e3eef7;
}

section#format-diagram, section#format-index-footer {
    background: #e9f8dd;
}

section#format-ksy, section#format-lang {
    background: #d1eadd;
}

section#format-index .row {
    padding-bottom: 10px;
}

  </style>
  <script src="http://kaitai.io/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>
<body data-spy="scroll" data-target="#main-navbar" data-offset="100">

    <nav class="navbar navbar-inverse navbar-fixed-top" id="main-navbar">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-navbar-collapse" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <span class="navbar-brand">Kaitai Struct</span>
            </div>
            <div class="collapse navbar-collapse" id="main-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="http://kaitai.io/#what-is-it">What is it?</a></li>
                    <li><a href="http://kaitai.io/#quick-start">Quick Start</a></li>
                    <li><a href="http://kaitai.io/#download">Download</a></li>
                    <li class="active"><a href="http://formats.kaitai.io/">Format Gallery</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://kaitai.io/repl/index.html">Try it</a></li>
                    <li><a href="https://ide.kaitai.io/">Web IDE</a></li>
                    <li><a href="http://doc.kaitai.io/">Documentation</a></li>
                </ul>
            </div>
        </div>
    </nav>
<nav>
    <div class="container">
    <ol class="breadcrumb">
        <li><a href="../index.html">Format Gallery</a></li>
        <li>Archive Files</li>
        <li class="active">RAR (Roshall ARchiver) archive files</li>
    </ol>
    </div>
</nav>

<section id="format-meta" class="format">
    <div class="container">
        <h1>RAR (Roshall ARchiver) archive files:
            
            Ruby parsing library
            
        </h1>

        <div class="row">
            <div class="col-md-8">
                <p><p>RAR is a archive format used by popular proprietary RAR archiver,
created by Eugene Roshal. There are two major versions of format
(v1.5-4.0 and RAR v5+).</p>
<p>File format essentially consists of a linear sequence of
blocks. Each block has fixed header and custom body (that depends on
block type), so it's possible to skip block even if one doesn't know
how to process a certain block type.</p>
</p>
            </div>
            <div class="col-md-4">
                <div class="panel panel-info">
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">Application</h3>
                    </div>
                    <div class="panel-body">
                        RAR archiver
                    </div>
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">File extension</h3>
                    </div>
                    <div class="panel-body">
                        rar
                    </div>
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">KS implementation details</h3>
                    </div>
                    
                    
                    <div class="panel-body">
                        Minimal Kaitai Struct required: 0.7
                    </div>
                    
                    
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
            <p>
            This page hosts a formal specification of RAR (Roshall ARchiver) archive files
            using <a href="http://kaitai.io">Kaitai Struct</a>. This
            specification can be automatically translated into a
            variety of programming languages to get a parsing library.
            </p>

            <ul class="nav nav-pills">
                
                
                <li>
                
                <a href="index.html" title="RAR (Roshall ARchiver) archive files parsing Overview library">Overview</a></li>
                
                
                <li>
                
                <a href="cpp_stl.html" title="RAR (Roshall ARchiver) archive files parsing C++/STL library">C++/STL</a></li>
                
                
                <li>
                
                <a href="csharp.html" title="RAR (Roshall ARchiver) archive files parsing C# library">C#</a></li>
                
                
                <li>
                
                <a href="graphviz.html" title="RAR (Roshall ARchiver) archive files parsing GraphViz library">GraphViz</a></li>
                
                
                <li>
                
                <a href="java.html" title="RAR (Roshall ARchiver) archive files parsing Java library">Java</a></li>
                
                
                <li>
                
                <a href="javascript.html" title="RAR (Roshall ARchiver) archive files parsing JavaScript library">JavaScript</a></li>
                
                
                <li>
                
                <a href="lua.html" title="RAR (Roshall ARchiver) archive files parsing Lua library">Lua</a></li>
                
                
                <li>
                
                <a href="perl.html" title="RAR (Roshall ARchiver) archive files parsing Perl library">Perl</a></li>
                
                
                <li>
                
                <a href="php.html" title="RAR (Roshall ARchiver) archive files parsing PHP library">PHP</a></li>
                
                
                <li>
                
                <a href="python.html" title="RAR (Roshall ARchiver) archive files parsing Python library">Python</a></li>
                
                
                <li class="active">
                
                <a href="ruby.html" title="RAR (Roshall ARchiver) archive files parsing Ruby library">Ruby</a></li>
                
            </ul>
            </div>
        </div>
    </div>
</section>

<section id="format-usage" class="format">
    <div class="container">
        <h2>Usage</h2>

        <p>Parse a local file and get structure in memory:</p>



<pre><code class="ruby">data = Rar.from_file("path/to/local/file.rar")</code></pre>

<p>Or parse structure from a string of bytes:</p>

<pre><code class="ruby">bytes = "\x00\x01\x02..."
data = Rar.new(Kaitai::Struct::Stream.new(bytes))</code></pre>

<p>After that, one can get various attributes from the structure by invoking getter methods like:</p>

<pre><code class="ruby">data.magic # => File format signature to validate that it is indeed a RAR archive</code></pre>

    </div>
</section>


<section id="format-lang" class="format">
    <div class="container">
        <h2>
            
            Ruby source code to parse RAR (Roshall ARchiver) archive files
            
        </h2>

        

        <h3>rar.rb</h3>

        <div class="row">
            <div class="pull-right">
                <p>
                    <a href="src/ruby/rar.rb" class="btn btn-success">Download <i class="fa fa-download"></i></a>
                </p>
            </div>
        </div>

        <div class="row">
            <pre><code class="ruby"># This is a generated file! Please edit source .ksy file and use kaitai-struct-compiler to rebuild

require &#39;kaitai/struct/struct&#39;

unless Gem::Version.new(Kaitai::Struct::VERSION) &gt;= Gem::Version.new(&#39;0.7&#39;)
  raise &quot;Incompatible Kaitai Struct Ruby API: 0.7 or later is required, but you have #{Kaitai::Struct::VERSION}&quot;
end


##
# RAR is a archive format used by popular proprietary RAR archiver,
# created by Eugene Roshal. There are two major versions of format
# (v1.5-4.0 and RAR v5+).
# 
# File format essentially consists of a linear sequence of
# blocks. Each block has fixed header and custom body (that depends on
# block type), so it&#39;s possible to skip block even if one doesn&#39;t know
# how to process a certain block type.
class Rar &lt; Kaitai::Struct::Struct

  BLOCK_TYPES = {
    114 =&gt; :block_types_marker,
    115 =&gt; :block_types_archive_header,
    116 =&gt; :block_types_file_header,
    117 =&gt; :block_types_old_style_comment_header,
    118 =&gt; :block_types_old_style_authenticity_info_76,
    119 =&gt; :block_types_old_style_subblock,
    120 =&gt; :block_types_old_style_recovery_record,
    121 =&gt; :block_types_old_style_authenticity_info_79,
    122 =&gt; :block_types_subblock,
    123 =&gt; :block_types_terminator,
  }
  I__BLOCK_TYPES = BLOCK_TYPES.invert

  OSES = {
    0 =&gt; :oses_ms_dos,
    1 =&gt; :oses_os_2,
    2 =&gt; :oses_windows,
    3 =&gt; :oses_unix,
    4 =&gt; :oses_mac_os,
    5 =&gt; :oses_beos,
  }
  I__OSES = OSES.invert

  METHODS = {
    48 =&gt; :methods_store,
    49 =&gt; :methods_fastest,
    50 =&gt; :methods_fast,
    51 =&gt; :methods_normal,
    52 =&gt; :methods_good,
    53 =&gt; :methods_best,
  }
  I__METHODS = METHODS.invert
  def initialize(_io, _parent = nil, _root = self)
    super(_io, _parent, _root)
    _read
  end

  def _read
    @magic = MagicSignature.new(@_io, self, @_root)
    @blocks = []
    i = 0
    while not @_io.eof?
      case magic.version
      when 0
        @blocks &lt;&lt; Block.new(@_io, self, @_root)
      when 1
        @blocks &lt;&lt; BlockV5.new(@_io, self, @_root)
      end
      i += 1
    end
    self
  end
  class BlockV5 &lt; Kaitai::Struct::Struct
    def initialize(_io, _parent = nil, _root = self)
      super(_io, _parent, _root)
      _read
    end

    def _read
      self
    end
  end

  ##
  # Basic block that RAR files consist of. There are several block
  # types (see `block_type`), which have different `body` and
  # `add_body`.
  class Block &lt; Kaitai::Struct::Struct
    def initialize(_io, _parent = nil, _root = self)
      super(_io, _parent, _root)
      _read
    end

    def _read
      @crc16 = @_io.read_u2le
      @block_type = Kaitai::Struct::Stream::resolve_enum(BLOCK_TYPES, @_io.read_u1)
      @flags = @_io.read_u2le
      @block_size = @_io.read_u2le
      if has_add
        @add_size = @_io.read_u4le
      end
      case block_type
      when :block_types_file_header
        @_raw_body = @_io.read_bytes(body_size)
        io = Kaitai::Struct::Stream.new(@_raw_body)
        @body = BlockFileHeader.new(io, self, @_root)
      else
        @body = @_io.read_bytes(body_size)
      end
      if has_add
        @add_body = @_io.read_bytes(add_size)
      end
      self
    end

    ##
    # True if block has additional content attached to it
    def has_add
      return @has_add unless @has_add.nil?
      @has_add = (flags &amp; 32768) != 0
      @has_add
    end
    def header_size
      return @header_size unless @header_size.nil?
      @header_size = (has_add ? 11 : 7)
      @header_size
    end
    def body_size
      return @body_size unless @body_size.nil?
      @body_size = (block_size - header_size)
      @body_size
    end

    ##
    # CRC16 of whole block or some part of it (depends on block type)
    attr_reader :crc16
    attr_reader :block_type
    attr_reader :flags

    ##
    # Size of block (header + body, but without additional content)
    attr_reader :block_size

    ##
    # Size of additional content in this block
    attr_reader :add_size
    attr_reader :body

    ##
    # Additional content in this block
    attr_reader :add_body
    attr_reader :_raw_body
  end
  class BlockFileHeader &lt; Kaitai::Struct::Struct
    def initialize(_io, _parent = nil, _root = self)
      super(_io, _parent, _root)
      _read
    end

    def _read
      @low_unp_size = @_io.read_u4le
      @host_os = Kaitai::Struct::Stream::resolve_enum(OSES, @_io.read_u1)
      @file_crc32 = @_io.read_u4le
      @file_time = DosTime.new(@_io, self, @_root)
      @rar_version = @_io.read_u1
      @method = Kaitai::Struct::Stream::resolve_enum(METHODS, @_io.read_u1)
      @name_size = @_io.read_u2le
      @attr = @_io.read_u4le
      if (_parent.flags &amp; 256) != 0
        @high_pack_size = @_io.read_u4le
      end
      @file_name = @_io.read_bytes(name_size)
      if (_parent.flags &amp; 1024) != 0
        @salt = @_io.read_u8le
      end
      self
    end

    ##
    # Uncompressed file size (lower 32 bits, if 64-bit header flag is present)
    attr_reader :low_unp_size

    ##
    # Operating system used for archiving
    attr_reader :host_os
    attr_reader :file_crc32

    ##
    # Date and time in standard MS DOS format
    attr_reader :file_time

    ##
    # RAR version needed to extract file (Version number is encoded as 10 * Major version + minor version.)
    attr_reader :rar_version

    ##
    # Compression method
    attr_reader :method

    ##
    # File name size
    attr_reader :name_size

    ##
    # File attributes
    attr_reader :attr

    ##
    # Compressed file size, high 32 bits, only if 64-bit header flag is present
    attr_reader :high_pack_size
    attr_reader :file_name
    attr_reader :salt
  end

  ##
  # RAR uses either 7-byte magic for RAR versions 1.5 to 4.0, and
  # 8-byte magic (and pretty different block format) for v5+. This
  # type would parse and validate both versions of signature. Note
  # that actually this signature is a valid RAR &quot;block&quot;: in theory,
  # one can omit signature reading at all, and read this normally,
  # as a block, if exact RAR version is known (and thus it&#39;s
  # possible to choose correct block format).
  class MagicSignature &lt; Kaitai::Struct::Struct
    def initialize(_io, _parent = nil, _root = self)
      super(_io, _parent, _root)
      _read
    end

    def _read
      @magic1 = @_io.ensure_fixed_contents([82, 97, 114, 33, 26, 7].pack(&#39;C*&#39;))
      @version = @_io.read_u1
      if version == 1
        @magic3 = @_io.ensure_fixed_contents([0].pack(&#39;C*&#39;))
      end
      self
    end

    ##
    # Fixed part of file&#39;s magic signature that doesn&#39;t change with RAR version
    attr_reader :magic1

    ##
    # Variable part of magic signature: 0 means old (RAR 1.5-4.0)
    # format, 1 means new (RAR 5+) format
    attr_reader :version

    ##
    # New format (RAR 5+) magic contains extra byte
    attr_reader :magic3
  end
  class DosTime &lt; Kaitai::Struct::Struct
    def initialize(_io, _parent = nil, _root = self)
      super(_io, _parent, _root)
      _read
    end

    def _read
      @time = @_io.read_u2le
      @date = @_io.read_u2le
      self
    end
    def month
      return @month unless @month.nil?
      @month = ((date &amp; 480) &gt;&gt; 5)
      @month
    end
    def seconds
      return @seconds unless @seconds.nil?
      @seconds = ((time &amp; 31) * 2)
      @seconds
    end
    def year
      return @year unless @year.nil?
      @year = (((date &amp; 65024) &gt;&gt; 9) + 1980)
      @year
    end
    def minutes
      return @minutes unless @minutes.nil?
      @minutes = ((time &amp; 2016) &gt;&gt; 5)
      @minutes
    end
    def day
      return @day unless @day.nil?
      @day = (date &amp; 31)
      @day
    end
    def hours
      return @hours unless @hours.nil?
      @hours = ((time &amp; 63488) &gt;&gt; 11)
      @hours
    end
    attr_reader :time
    attr_reader :date
  end

  ##
  # File format signature to validate that it is indeed a RAR archive
  attr_reader :magic

  ##
  # Sequence of blocks that constitute the RAR file
  attr_reader :blocks
end
</code></pre>
            
        </div>
        
    </div>
</section>

    <footer id="main-footer">
        <div class="container">
            &copy; 2015-2018 Kaitai Project and <a href="https://github.com/kaitai-io/kaitai_struct_formats/graphs/contributors">formats repo contributors</a>

            <h3>Contacts</h3>

            <div class="row">
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-github"></i> <a href="https://github.com/kaitai-io/kaitai_struct">GitHub</a>
                </div>
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-twitter"></i> <a href="https://twitter.com/kaitai_io">@kaitai_io</a>
                </div>
                <div class="col-sm-4">
                    Gitter: <a href="https://gitter.im/kaitai_struct/Lobby">kaitai_struct</a>
                </div>
            </div>
        </div>
    </footer>

  <script src="http://kaitai.io/js/jquery-1.12.3.min.js"></script>
  <script src="http://kaitai.io/js/bootstrap.min.js"></script>

  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-76299550-1', 'auto');
      ga('send', 'pageview');
  </script>
</body>
</html>
