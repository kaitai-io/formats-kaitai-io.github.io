<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Mifare Classic RFID tag dump: Ruby parsing library</title>
  <meta name="keywords" content="kaitai,struct,binary,format,parsing,decoding,java,javascript,python,ruby,library,metadata">
  <meta name="description" content="Kaitai Struct is a formal language for binary format specification that can be compiled into parser code">

  <link rel="stylesheet" href="//kaitai.io/styles/bootstrap.min.css">
  <link rel="stylesheet" href="//kaitai.io/styles/bootstrap-theme.min.css">
  <link href='https://fonts.googleapis.com/css?family=Exo:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Share+Tech+Mono' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="//kaitai.io/styles/main.css" type="text/css">

  <link rel="stylesheet" href="//kaitai.io/styles/highlight/default.css">
  <style>
.diagram-img {
    display: block;
    max-width: 100%;
    height: auto;
    margin: 0 auto;
}

section.format {
    padding: 30px 0;
}

section#format-meta, section#format-index-header {
    background: #e3eef7;
}

section#format-diagram, section#format-index-footer {
    background: #e9f8dd;
}

section#format-ksy, section#format-lang {
    background: #d1eadd;
}

section#format-index .row {
    padding-bottom: 10px;
}

  </style>
  <script src="//kaitai.io/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>
<body data-spy="scroll" data-target="#main-navbar" data-offset="100">

    <nav class="navbar navbar-inverse navbar-fixed-top" id="main-navbar">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-navbar-collapse" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <span class="navbar-brand">Kaitai Struct</span>
            </div>
            <div class="collapse navbar-collapse" id="main-navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="http://kaitai.io/#what-is-it">What is it?</a></li>
                    <li><a href="http://kaitai.io/#quick-start">Quick Start</a></li>
                    <li><a href="http://kaitai.io/#download">Download</a></li>
                    <li class="active"><a href="http://formats.kaitai.io/">Format Gallery</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="http://kaitai.io/repl/index.html">Try it</a></li>
                    <li><a href="https://ide.kaitai.io/">Web IDE</a></li>
                    <li><a href="http://doc.kaitai.io/">Documentation</a></li>
                </ul>
            </div>
        </div>
    </nav>
<nav>
    <div class="container">
    <ol class="breadcrumb">
        <li><a href="../index.html">Format Gallery</a></li>
        <li>Hardware Protocols</li>
        <li class="active">Mifare Classic RFID tag dump</li>
    </ol>
    </div>
</nav>

<section id="format-meta" class="format">
    <div class="container">
        <h1>Mifare Classic RFID tag dump:
            
            Ruby parsing library
            
        </h1>

        <div class="row">
            <div class="col-md-8">
                <p><p>You can get a dump for testing by the link: https://github.com/zhovner/mfdread/raw/master/dump.mfd</p>
</p>
            </div>
            <div class="col-md-4">
                <div class="panel panel-info">
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">File extension</h3>
                    </div>
                    <div class="panel-body">
                        mfd
                    </div>
                    
                    
                    <div class="panel-heading">
                        <h3 class="panel-title">KS implementation details</h3>
                    </div>
                    
                    <div class="panel-body">
                        License: <a href="https://spdx.org/licenses/BSD-2-Clause.html">BSD-2-Clause</a>
                    </div>
                    
                    
                    <div class="panel-body">
                        Minimal Kaitai Struct required: 0.9
                    </div>
                    
                    
                    
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
            <p>
            This page hosts a formal specification of Mifare Classic RFID tag dump
            using <a href="http://kaitai.io">Kaitai Struct</a>. This
            specification can be automatically translated into a
            variety of programming languages to get a parsing library.
            </p>

            <ul class="nav nav-pills">
                
                
                <li>
                
                <a href="index.html" title="Mifare Classic RFID tag dump parsing Overview library">Overview</a></li>
                
                
                <li>
                
                <a href="csharp.html" title="Mifare Classic RFID tag dump parsing C# library">C#</a></li>
                
                
                <li>
                
                <a href="graphviz.html" title="Mifare Classic RFID tag dump parsing GraphViz library">GraphViz</a></li>
                
                
                <li>
                
                <a href="java.html" title="Mifare Classic RFID tag dump parsing Java library">Java</a></li>
                
                
                <li>
                
                <a href="javascript.html" title="Mifare Classic RFID tag dump parsing JavaScript library">JavaScript</a></li>
                
                
                <li>
                
                <a href="lua.html" title="Mifare Classic RFID tag dump parsing Lua library">Lua</a></li>
                
                
                <li>
                
                <a href="perl.html" title="Mifare Classic RFID tag dump parsing Perl library">Perl</a></li>
                
                
                <li>
                
                <a href="php.html" title="Mifare Classic RFID tag dump parsing PHP library">PHP</a></li>
                
                
                <li>
                
                <a href="python.html" title="Mifare Classic RFID tag dump parsing Python library">Python</a></li>
                
                
                <li class="active">
                
                <a href="ruby.html" title="Mifare Classic RFID tag dump parsing Ruby library">Ruby</a></li>
                
            </ul>
            </div>
        </div>
    </div>
</section>

<section id="format-usage" class="format">
    <div class="container">
        <h2>Usage</h2>

        <p>Parse a local file and get structure in memory:</p>



<pre><code class="ruby">data = MifareClassic.from_file("path/to/local/file.mfd")</code></pre>

<p>Or parse structure from a string of bytes:</p>

<pre><code class="ruby">bytes = "\x00\x01\x02..."
data = MifareClassic.new(Kaitai::Struct::Stream.new(bytes))</code></pre>

<p>After that, one can get various attributes from the structure by invoking getter methods like:</p>

<pre><code class="ruby">data.sectors # => get sectors</code></pre>

    </div>
</section>


<section id="format-lang" class="format">
    <div class="container">
        <h2>
            
            Ruby source code to parse Mifare Classic RFID tag dump
            
        </h2>

        

        <h3>mifare_classic.rb</h3>

        <div class="row">
            <div class="pull-right">
                <p>
                    <a href="src/ruby/mifare_classic.rb" class="btn btn-success">Download <i class="fa fa-download"></i></a>
                </p>
            </div>
        </div>

        <div class="row">
            <pre><code class="ruby"># This is a generated file! Please edit source .ksy file and use kaitai-struct-compiler to rebuild

require &#39;kaitai/struct/struct&#39;

unless Gem::Version.new(Kaitai::Struct::VERSION) &gt;= Gem::Version.new(&#39;0.7&#39;)
  raise &quot;Incompatible Kaitai Struct Ruby API: 0.7 or later is required, but you have #{Kaitai::Struct::VERSION}&quot;
end


##
# You can get a dump for testing by the link: https://github.com/zhovner/mfdread/raw/master/dump.mfd
# @see https://github.com/nfc-tools/libnfc
#   https://www.nxp.com/docs/en/data-sheet/MF1S70YYX_V1.pdf
#    Source
class MifareClassic &lt; Kaitai::Struct::Struct
  def initialize(_io, _parent = nil, _root = self)
    super(_io, _parent, _root)
    _read
  end

  def _read
    @_raw_sectors = []
    @sectors = []
    i = 0
    while not @_io.eof?
      @_raw_sectors &lt;&lt; @_io.read_bytes((((i &gt;= 32 ? 4 : 1) * 4) * 16))
      _io__raw_sectors = Kaitai::Struct::Stream.new(@_raw_sectors.last)
      @sectors &lt;&lt; Sector.new(_io__raw_sectors, self, @_root, i == 0)
      i += 1
    end
    self
  end
  class Key &lt; Kaitai::Struct::Struct
    def initialize(_io, _parent = nil, _root = self)
      super(_io, _parent, _root)
      _read
    end

    def _read
      @key = @_io.read_bytes(6)
      self
    end
    attr_reader :key
  end
  class Sector &lt; Kaitai::Struct::Struct
    def initialize(_io, _parent = nil, _root = self, has_manufacturer)
      super(_io, _parent, _root)
      @has_manufacturer = has_manufacturer
      _read
    end

    def _read
      if has_manufacturer
        @manufacturer = Manufacturer.new(@_io, self, @_root)
      end
      @_raw_data_filler = @_io.read_bytes(((_io.size - _io.pos) - 16))
      _io__raw_data_filler = Kaitai::Struct::Stream.new(@_raw_data_filler)
      @data_filler = Filler.new(_io__raw_data_filler, self, @_root)
      @trailer = Trailer.new(@_io, self, @_root)
      self
    end
    class Values &lt; Kaitai::Struct::Struct
      def initialize(_io, _parent = nil, _root = self)
        super(_io, _parent, _root)
        _read
      end

      def _read
        @values = []
        i = 0
        while not @_io.eof?
          @values &lt;&lt; ValueBlock.new(@_io, self, @_root)
          i += 1
        end
        self
      end
      class ValueBlock &lt; Kaitai::Struct::Struct
        def initialize(_io, _parent = nil, _root = self)
          super(_io, _parent, _root)
          _read
        end

        def _read
          @valuez = Array.new(3)
          (3).times { |i|
            @valuez[i] = @_io.read_u4le
          }
          @addrz = Array.new(4)
          (4).times { |i|
            @addrz[i] = @_io.read_u1
          }
          self
        end
        def addr
          return @addr unless @addr.nil?
          if valid
            @addr = addrz[0]
          end
          @addr
        end
        def addr_valid
          return @addr_valid unless @addr_valid.nil?
          @addr_valid =  ((addrz[0] == ~(addrz[1])) &amp;&amp; (addrz[0] == addrz[2]) &amp;&amp; (addrz[1] == addrz[3])) 
          @addr_valid
        end
        def valid
          return @valid unless @valid.nil?
          @valid =  ((value_valid) &amp;&amp; (addr_valid)) 
          @valid
        end
        def value_valid
          return @value_valid unless @value_valid.nil?
          @value_valid =  ((valuez[0] == ~(valuez[1])) &amp;&amp; (valuez[0] == valuez[2])) 
          @value_valid
        end
        def value
          return @value unless @value.nil?
          if valid
            @value = valuez[0]
          end
          @value
        end
        attr_reader :valuez
        attr_reader :addrz
      end
      attr_reader :values
    end

    ##
    # only to create _io
    class Filler &lt; Kaitai::Struct::Struct
      def initialize(_io, _parent = nil, _root = self)
        super(_io, _parent, _root)
        _read
      end

      def _read
        @data = @_io.read_bytes(_io.size)
        self
      end
      attr_reader :data
    end
    def block_size
      return @block_size unless @block_size.nil?
      @block_size = 16
      @block_size
    end
    def data
      return @data unless @data.nil?
      @data = data_filler.data
      @data
    end
    def blocks
      return @blocks unless @blocks.nil?
      io = data_filler._io
      _pos = io.pos
      io.seek(0)
      @blocks = []
      i = 0
      while not io.eof?
        @blocks &lt;&lt; io.read_bytes(block_size)
        i += 1
      end
      io.seek(_pos)
      @blocks
    end
    def values
      return @values unless @values.nil?
      io = data_filler._io
      _pos = io.pos
      io.seek(0)
      @values = Values.new(io, self, @_root)
      io.seek(_pos)
      @values
    end
    attr_reader :manufacturer
    attr_reader :data_filler
    attr_reader :trailer
    attr_reader :has_manufacturer
    attr_reader :_raw_data_filler
  end
  class Manufacturer &lt; Kaitai::Struct::Struct
    def initialize(_io, _parent = nil, _root = self)
      super(_io, _parent, _root)
      _read
    end

    def _read
      @nuid = @_io.read_u4le
      @bcc = @_io.read_u1
      @sak = @_io.read_u1
      @atqa = @_io.read_u2le
      @manufacturer = @_io.read_bytes(8)
      self
    end

    ##
    # beware for 7bytes UID it goes over next fields
    attr_reader :nuid
    attr_reader :bcc
    attr_reader :sak
    attr_reader :atqa

    ##
    # may contain manufacture date as BCD
    attr_reader :manufacturer
  end
  class Trailer &lt; Kaitai::Struct::Struct
    def initialize(_io, _parent = nil, _root = self)
      super(_io, _parent, _root)
      _read
    end

    def _read
      @key_a = Key.new(@_io, self, @_root)
      @_raw_access_bits = @_io.read_bytes(3)
      _io__raw_access_bits = Kaitai::Struct::Stream.new(@_raw_access_bits)
      @access_bits = AccessConditions.new(_io__raw_access_bits, self, @_root)
      @user_byte = @_io.read_u1
      @key_b = Key.new(@_io, self, @_root)
      self
    end
    class AccessConditions &lt; Kaitai::Struct::Struct
      def initialize(_io, _parent = nil, _root = self)
        super(_io, _parent, _root)
        _read
      end

      def _read
        @raw_chunks = Array.new(_parent.ac_count_of_chunks)
        (_parent.ac_count_of_chunks).times { |i|
          @raw_chunks[i] = @_io.read_bits_int(4)
        }
        self
      end
      class TrailerAc &lt; Kaitai::Struct::Struct
        def initialize(_io, _parent = nil, _root = self, ac)
          super(_io, _parent, _root)
          @ac = ac
          _read
        end

        def _read
          self
        end

        ##
        # key A is required
        def can_read_key_b
          return @can_read_key_b unless @can_read_key_b.nil?
          @can_read_key_b = ac.inv_shift_val &lt;= 2
          @can_read_key_b
        end
        def can_write_keys
          return @can_write_keys unless @can_write_keys.nil?
          @can_write_keys =  ((((ac.inv_shift_val + 1) % 3) != 0) &amp;&amp; (ac.inv_shift_val &lt; 6)) 
          @can_write_keys
        end
        def can_write_access_bits
          return @can_write_access_bits unless @can_write_access_bits.nil?
          @can_write_access_bits = ac.bits[2].b
          @can_write_access_bits
        end
        def key_b_controls_write
          return @key_b_controls_write unless @key_b_controls_write.nil?
          @key_b_controls_write = !(can_read_key_b)
          @key_b_controls_write
        end
        attr_reader :ac
      end
      class ChunkBitRemap &lt; Kaitai::Struct::Struct
        def initialize(_io, _parent = nil, _root = self, bit_no)
          super(_io, _parent, _root)
          @bit_no = bit_no
          _read
        end

        def _read
          self
        end
        def shift_value
          return @shift_value unless @shift_value.nil?
          @shift_value = (bit_no == 1 ? -1 : 1)
          @shift_value
        end
        def chunk_no
          return @chunk_no unless @chunk_no.nil?
          @chunk_no = (((inv_chunk_no + shift_value) + _parent._parent.ac_count_of_chunks) % _parent._parent.ac_count_of_chunks)
          @chunk_no
        end
        def inv_chunk_no
          return @inv_chunk_no unless @inv_chunk_no.nil?
          @inv_chunk_no = (bit_no + shift_value)
          @inv_chunk_no
        end
        attr_reader :bit_no
      end
      class DataAc &lt; Kaitai::Struct::Struct
        def initialize(_io, _parent = nil, _root = self, ac)
          super(_io, _parent, _root)
          @ac = ac
          _read
        end

        def _read
          self
        end
        def read_key_a_required
          return @read_key_a_required unless @read_key_a_required.nil?
          @read_key_a_required = ac.val &lt;= 4
          @read_key_a_required
        end
        def write_key_b_required
          return @write_key_b_required unless @write_key_b_required.nil?
          @write_key_b_required =  (( ((!(read_key_a_required)) || (read_key_b_required)) ) &amp;&amp; (!(ac.bits[0].b))) 
          @write_key_b_required
        end
        def write_key_a_required
          return @write_key_a_required unless @write_key_a_required.nil?
          @write_key_a_required = ac.val == 0
          @write_key_a_required
        end
        def read_key_b_required
          return @read_key_b_required unless @read_key_b_required.nil?
          @read_key_b_required = ac.val &lt;= 6
          @read_key_b_required
        end
        def decrement_available
          return @decrement_available unless @decrement_available.nil?
          @decrement_available =  (( ((ac.bits[1].b) || (!(ac.bits[0].b))) ) &amp;&amp; (!(ac.bits[2].b))) 
          @decrement_available
        end
        def increment_available
          return @increment_available unless @increment_available.nil?
          @increment_available =  (( ((!(ac.bits[0].b)) &amp;&amp; (!(read_key_a_required)) &amp;&amp; (!(read_key_b_required))) ) || ( ((!(ac.bits[0].b)) &amp;&amp; (read_key_a_required) &amp;&amp; (read_key_b_required)) )) 
          @increment_available
        end
        attr_reader :ac
      end
      class Ac &lt; Kaitai::Struct::Struct
        def initialize(_io, _parent = nil, _root = self, index)
          super(_io, _parent, _root)
          @index = index
          _read
        end

        def _read
          self
        end
        class AcBit &lt; Kaitai::Struct::Struct
          def initialize(_io, _parent = nil, _root = self, i, chunk)
            super(_io, _parent, _root)
            @i = i
            @chunk = chunk
            _read
          end

          def _read
            self
          end
          def n
            return @n unless @n.nil?
            @n = ((chunk &gt;&gt; i) &amp; 1)
            @n
          end
          def b
            return @b unless @b.nil?
            @b = n == 1
            @b
          end
          attr_reader :i
          attr_reader :chunk
        end
        def bits
          return @bits unless @bits.nil?
          _pos = @_io.pos
          @_io.seek(0)
          @bits = Array.new(_parent._parent.ac_bits)
          (_parent._parent.ac_bits).times { |i|
            @bits[i] = AcBit.new(@_io, self, @_root, index, _parent.chunks[i].chunk)
          }
          @_io.seek(_pos)
          @bits
        end

        ##
        # c3 c2 c1
        def val
          return @val unless @val.nil?
          @val = (((bits[2].n &lt;&lt; 2) | (bits[1].n &lt;&lt; 1)) | bits[0].n)
          @val
        end
        def inv_shift_val
          return @inv_shift_val unless @inv_shift_val.nil?
          @inv_shift_val = (((bits[0].n &lt;&lt; 2) | (bits[1].n &lt;&lt; 1)) | bits[2].n)
          @inv_shift_val
        end
        attr_reader :index
      end
      class ValidChunk &lt; Kaitai::Struct::Struct
        def initialize(_io, _parent = nil, _root = self, inv_chunk, chunk)
          super(_io, _parent, _root)
          @inv_chunk = inv_chunk
          @chunk = chunk
          _read
        end

        def _read
          self
        end
        def valid
          return @valid unless @valid.nil?
          @valid = (inv_chunk ^ chunk) == 15
          @valid
        end
        attr_reader :inv_chunk

        ##
        # c3 c2 c1 c0
        attr_reader :chunk
      end
      def data_acs
        return @data_acs unless @data_acs.nil?
        _pos = @_io.pos
        @_io.seek(0)
        @data_acs = Array.new((_parent.acs_in_sector - 1))
        ((_parent.acs_in_sector - 1)).times { |i|
          @data_acs[i] = DataAc.new(@_io, self, @_root, acs_raw[i])
        }
        @_io.seek(_pos)
        @data_acs
      end
      def remaps
        return @remaps unless @remaps.nil?
        _pos = @_io.pos
        @_io.seek(0)
        @remaps = Array.new(_parent.ac_bits)
        (_parent.ac_bits).times { |i|
          @remaps[i] = ChunkBitRemap.new(@_io, self, @_root, i)
        }
        @_io.seek(_pos)
        @remaps
      end
      def acs_raw
        return @acs_raw unless @acs_raw.nil?
        _pos = @_io.pos
        @_io.seek(0)
        @acs_raw = Array.new(_parent.acs_in_sector)
        (_parent.acs_in_sector).times { |i|
          @acs_raw[i] = Ac.new(@_io, self, @_root, i)
        }
        @_io.seek(_pos)
        @acs_raw
      end
      def trailer_ac
        return @trailer_ac unless @trailer_ac.nil?
        _pos = @_io.pos
        @_io.seek(0)
        @trailer_ac = TrailerAc.new(@_io, self, @_root, acs_raw[(_parent.acs_in_sector - 1)])
        @_io.seek(_pos)
        @trailer_ac
      end
      def chunks
        return @chunks unless @chunks.nil?
        _pos = @_io.pos
        @_io.seek(0)
        @chunks = Array.new(_parent.ac_bits)
        (_parent.ac_bits).times { |i|
          @chunks[i] = ValidChunk.new(@_io, self, @_root, raw_chunks[remaps[i].inv_chunk_no], raw_chunks[remaps[i].chunk_no])
        }
        @_io.seek(_pos)
        @chunks
      end
      attr_reader :raw_chunks
    end
    def ac_bits
      return @ac_bits unless @ac_bits.nil?
      @ac_bits = 3
      @ac_bits
    end
    def acs_in_sector
      return @acs_in_sector unless @acs_in_sector.nil?
      @acs_in_sector = 4
      @acs_in_sector
    end
    def ac_count_of_chunks
      return @ac_count_of_chunks unless @ac_count_of_chunks.nil?
      @ac_count_of_chunks = (ac_bits * 2)
      @ac_count_of_chunks
    end
    attr_reader :key_a
    attr_reader :access_bits
    attr_reader :user_byte
    attr_reader :key_b
    attr_reader :_raw_access_bits
  end
  attr_reader :sectors
  attr_reader :_raw_sectors
end
</code></pre>
            
        </div>
        
    </div>
</section>

    <footer id="main-footer">
        <div class="container">
            &copy; 2015-2019 Kaitai Project and <a href="https://github.com/kaitai-io/kaitai_struct_formats/graphs/contributors">formats repo contributors</a>

            <h3>Contacts</h3>

            <div class="row">
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-github"></i> <a href="https://github.com/kaitai-io/kaitai_struct">GitHub</a>
                </div>
                <div class="col-sm-4">
                    <i class="fa fa-fw fa-2x fa-twitter"></i> <a href="https://twitter.com/kaitai_io">@kaitai_io</a>
                </div>
                <div class="col-sm-4">
                    Gitter: <a href="https://gitter.im/kaitai_struct/Lobby">kaitai_struct</a>
                </div>
            </div>
        </div>
    </footer>

  <script src="//kaitai.io/js/jquery-1.12.3.min.js"></script>
  <script src="//kaitai.io/js/bootstrap.min.js"></script>

  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-76299550-1', 'auto');
      ga('send', 'pageview');
  </script>
</body>
</html>
